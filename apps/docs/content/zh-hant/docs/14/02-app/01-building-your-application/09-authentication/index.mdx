---
source-updated-at: 2025-05-16T04:52:11.000Z
translation-updated-at: 2025-05-25T21:24:21.614Z
title: èº«ä»½é©—è­‰ (Authentication)
description: å­¸ç¿’å¦‚ä½•åœ¨ Next.js ä¸­å¯¦ä½œèº«ä»½é©—è­‰ï¼Œæ¶µè“‹æœ€ä½³å¯¦è¸ã€ä¿è­·è·¯ç”±ã€æˆæ¬ŠæŠ€è¡“èˆ‡æœƒè©±ç®¡ç† (session management)ã€‚
---

è¦åœ¨ Next.js ä¸­å¯¦ä½œèº«ä»½é©—è­‰ï¼Œæ‚¨éœ€è¦å…ˆç†Ÿæ‚‰ä¸‰å€‹åŸºç¤æ¦‚å¿µï¼š

- **[èº«ä»½é©—è­‰ (Authentication)](#authentication)** é©—è­‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºå…¶æ‰€è²ç¨±çš„èº«ä»½ã€‚è¦æ±‚ä½¿ç”¨è€…é€éä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼ç­‰æ–¹å¼è­‰æ˜èº«ä»½ã€‚
- **[æœƒè©±ç®¡ç† (Session Management)](#session-management)** è¿½è¹¤ä½¿ç”¨è€…åœ¨å¤šå€‹è«‹æ±‚é–“çš„ç‹€æ…‹ï¼ˆä¾‹å¦‚ç™»å…¥ç‹€æ…‹ï¼‰ã€‚
- **[æˆæ¬Š (Authorization)](#authorization)** æ±ºå®šä½¿ç”¨è€…å¯ä»¥å­˜å–æ‡‰ç”¨ç¨‹å¼çš„å“ªäº›éƒ¨åˆ†ã€‚

æœ¬é å°‡ç¤ºç¯„å¦‚ä½•ä½¿ç”¨ Next.js åŠŸèƒ½ä¾†å¯¦ä½œå¸¸è¦‹çš„èº«ä»½é©—è­‰ã€æˆæ¬Šå’Œæœƒè©±ç®¡ç†æ¨¡å¼ï¼Œè®“æ‚¨å¯ä»¥æ ¹æ“šæ‡‰ç”¨éœ€æ±‚é¸æ“‡æœ€ä½³è§£æ±ºæ–¹æ¡ˆã€‚

## èº«ä»½é©—è­‰ (Authentication)

èº«ä»½é©—è­‰ç”¨æ–¼ç¢ºèªä½¿ç”¨è€…èº«ä»½ã€‚ç•¶ä½¿ç”¨è€…é€éä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼æˆ– Google ç­‰æœå‹™ç™»å…¥æ™‚ï¼Œå³é€²è¡Œæ­¤éç¨‹ã€‚å…¶ç›®çš„æ˜¯ç¢ºä¿ä½¿ç”¨è€…ç¢ºå¯¦æ˜¯å…¶æ‰€è²ç¨±çš„èº«ä»½ï¼Œä¿è­·ä½¿ç”¨è€…è³‡æ–™å’Œæ‡‰ç”¨ç¨‹å¼å…æ–¼æœªæˆæ¬Šå­˜å–æˆ–è©é¨™æ´»å‹•ã€‚

### èº«ä»½é©—è­‰ç­–ç•¥

ç¾ä»£ç¶²é æ‡‰ç”¨ç¨‹å¼å¸¸ç”¨çš„èº«ä»½é©—è­‰ç­–ç•¥åŒ…æ‹¬ï¼š

1. **OAuth/OpenID Connect (OIDC)**ï¼šå…è¨±ç¬¬ä¸‰æ–¹å­˜å–è€Œä¸éœ€åˆ†äº«ä½¿ç”¨è€…æ†‘è­‰ã€‚é©ç”¨æ–¼ç¤¾ç¾¤åª’é«”ç™»å…¥å’Œå–®ä¸€ç™»å…¥ (SSO) è§£æ±ºæ–¹æ¡ˆã€‚OpenID Connect å¢åŠ äº†èº«ä»½å±¤ã€‚
2. **åŸºæ–¼æ†‘è­‰çš„ç™»å…¥ (Email + Password)**ï¼šç¶²é æ‡‰ç”¨ç¨‹å¼çš„æ¨™æº–é¸æ“‡ï¼Œä½¿ç”¨è€…é€éé›»å­éƒµä»¶å’Œå¯†ç¢¼ç™»å…¥ã€‚ç†Ÿæ‚‰ä¸”æ˜“æ–¼å¯¦ä½œï¼Œä½†éœ€é‡å°é‡£é­šç­‰å¨è„…æ¡å–å¼·å¥çš„å®‰å…¨æªæ–½ã€‚
3. **ç„¡å¯†ç¢¼/åŸºæ–¼ä»¤ç‰Œçš„èº«ä»½é©—è­‰ (Token-based authentication)**ï¼šä½¿ç”¨é›»å­éƒµä»¶é­”æ³•é€£çµæˆ–ç°¡è¨Šä¸€æ¬¡æ€§ä»£ç¢¼å¯¦ç¾å®‰å…¨ã€ç„¡å¯†ç¢¼çš„å­˜å–ã€‚å› å…¶ä¾¿åˆ©æ€§å’Œå¢å¼·çš„å®‰å…¨æ€§è€Œæµè¡Œï¼Œå¯æ¸›å°‘å¯†ç¢¼ç–²å‹ã€‚å…¶é™åˆ¶åœ¨æ–¼ä¾è³´ä½¿ç”¨è€…çš„é›»å­éƒµä»¶æˆ–é›»è©±å¯ç”¨æ€§ã€‚
4. **é€šè¡Œé‡‘é‘°/WebAuthn (Passkeys/WebAuthn)**ï¼šä½¿ç”¨æ¯å€‹ç¶²ç«™ç¨æœ‰çš„åŠ å¯†æ†‘è­‰ï¼Œæä¾›é«˜å®‰å…¨æ€§ä»¥é˜²é‡£é­šã€‚å®‰å…¨ä½†è¼ƒæ–°ï¼Œæ­¤ç­–ç•¥å¯èƒ½é›£ä»¥å¯¦ä½œã€‚

é¸æ“‡èº«ä»½é©—è­‰ç­–ç•¥æ‡‰ç¬¦åˆæ‡‰ç”¨ç¨‹å¼çš„ç‰¹å®šéœ€æ±‚ã€ä½¿ç”¨è€…ä»‹é¢è€ƒé‡å’Œå®‰å…¨ç›®æ¨™ã€‚

### å¯¦ä½œèº«ä»½é©—è­‰

æœ¬ç¯€å°‡æ¢è¨å¦‚ä½•ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼æ·»åŠ åŸºæœ¬çš„é›»å­éƒµä»¶-å¯†ç¢¼èº«ä»½é©—è­‰ã€‚é›–ç„¶æ­¤æ–¹æ³•æä¾›åŸºç¤å®‰å…¨ç´šåˆ¥ï¼Œä½†è€ƒæ…®ä½¿ç”¨ OAuth æˆ–ç„¡å¯†ç¢¼ç™»å…¥ç­‰é€²éšé¸é …å¯å¢å¼·å°å¸¸è¦‹å®‰å…¨å¨è„…çš„é˜²è­·ã€‚æˆ‘å€‘å°‡è¨è«–çš„èº«ä»½é©—è­‰æµç¨‹å¦‚ä¸‹ï¼š

<PagesOnly>

1. ä½¿ç”¨è€…é€éç™»å…¥è¡¨å–®æäº¤æ†‘è­‰ã€‚
2. è¡¨å–®ç™¼é€è«‹æ±‚ï¼Œç”± API è·¯ç”±è™•ç†ã€‚
3. é©—è­‰æˆåŠŸå¾Œï¼Œæµç¨‹å®Œæˆï¼Œè¡¨ç¤ºä½¿ç”¨è€…èº«ä»½é©—è­‰æˆåŠŸã€‚
4. è‹¥é©—è­‰å¤±æ•—ï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚

è€ƒæ…®ä¸€å€‹ç™»å…¥è¡¨å–®ï¼Œä½¿ç”¨è€…å¯è¼¸å…¥æ†‘è­‰ï¼š

```tsx filename="pages/login.tsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // è™•ç†éŒ¯èª¤
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

```jsx filename="pages/login.jsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // è™•ç†éŒ¯èª¤
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

ä¸Šè¿°è¡¨å–®æœ‰å…©å€‹è¼¸å…¥æ¬„ä½ï¼Œç”¨æ–¼æ•æ‰ä½¿ç”¨è€…çš„é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚æäº¤æ™‚ï¼Œæœƒè§¸ç™¼ä¸€å€‹å‡½å¼ï¼Œå‘ API è·¯ç”± (`/api/auth/login`) ç™¼é€ POST è«‹æ±‚ã€‚

ç„¶å¾Œæ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­å‘¼å«æ‚¨çš„èº«ä»½é©—è­‰æä¾›è€… API ä¾†è™•ç†èº«ä»½é©—è­‰ï¼š

```ts filename="pages/api/auth/login.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚' })
    } else {
      res.status(500).json({ error: 'ç™¼ç”ŸéŒ¯èª¤ã€‚' })
    }
  }
}
```

```js filename="pages/api/auth/login.js" switcher
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚' })
    } else {
      res.status(500).json({ error: 'ç™¼ç”ŸéŒ¯èª¤ã€‚' })
    }
  }
}
```

</PagesOnly>

<AppOnly>

1. ä½¿ç”¨è€…é€éç™»å…¥è¡¨å–®æäº¤æ†‘è­‰ã€‚
2. è¡¨å–®å‘¼å«ä¼ºæœå™¨å‹•ä½œ (Server Action)ã€‚
3. é©—è­‰æˆåŠŸå¾Œï¼Œæµç¨‹å®Œæˆï¼Œè¡¨ç¤ºä½¿ç”¨è€…èº«ä»½é©—è­‰æˆåŠŸã€‚
4. è‹¥é©—è­‰å¤±æ•—ï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚

è€ƒæ…®ä¸€å€‹ç™»å…¥è¡¨å–®ï¼Œä½¿ç”¨è€…å¯è¼¸å…¥æ†‘è­‰ï¼š

```tsx filename="app/login/page.tsx" switcher
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

```jsx filename="app/login/page.jsx" switcher
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

ä¸Šè¿°è¡¨å–®æœ‰å…©å€‹è¼¸å…¥æ¬„ä½ï¼Œç”¨æ–¼æ•æ‰ä½¿ç”¨è€…çš„é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚æäº¤æ™‚ï¼Œæœƒå‘¼å« `authenticate` ä¼ºæœå™¨å‹•ä½œã€‚

ç„¶å¾Œæ‚¨å¯ä»¥åœ¨ä¼ºæœå™¨å‹•ä½œä¸­å‘¼å«æ‚¨çš„èº«ä»½é©—è­‰æä¾›è€… API ä¾†è™•ç†èº«ä»½é©—è­‰ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState: unknown, formData: FormData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚'
        default:
          return 'ç™¼ç”ŸéŒ¯èª¤ã€‚'
      }
    }
    throw error
  }
}
```

```js filename="app/lib/actions.js" switcher
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState, formData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚'
        default:
          return 'ç™¼ç”ŸéŒ¯èª¤ã€‚'
      }
    }
    throw error
  }
}
```

</AppOnly>

åœ¨æ­¤ç¨‹å¼ç¢¼ä¸­ï¼Œ`signIn` æ–¹æ³•æœƒæ ¹æ“šå„²å­˜çš„ä½¿ç”¨è€…è³‡æ–™æª¢æŸ¥æ†‘è­‰ã€‚
èº«ä»½é©—è­‰æä¾›è€…è™•ç†æ†‘è­‰å¾Œï¼Œæœ‰å…©ç¨®å¯èƒ½çš„çµæœï¼š

- **èº«ä»½é©—è­‰æˆåŠŸ**ï¼šè¡¨ç¤ºç™»å…¥æˆåŠŸã€‚éš¨å¾Œå¯å•Ÿå‹•é€²ä¸€æ­¥æ“ä½œï¼Œä¾‹å¦‚å­˜å–å—ä¿è­·è·¯ç”±å’Œå–å¾—ä½¿ç”¨è€…è³‡è¨Šã€‚
- **èº«ä»½é©—è­‰å¤±æ•—**ï¼šè‹¥æ†‘è­‰ä¸æ­£ç¢ºæˆ–é‡åˆ°éŒ¯èª¤ï¼Œå‡½å¼æœƒå›å‚³ç›¸æ‡‰çš„éŒ¯èª¤è¨Šæ¯ä»¥è¡¨ç¤ºèº«ä»½é©—è­‰å¤±æ•—ã€‚

<AppOnly>

æœ€å¾Œï¼Œåœ¨æ‚¨çš„ `login-form.tsx` å…ƒä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ React çš„ `useFormState` ä¾†å‘¼å«ä¼ºæœå™¨å‹•ä½œä¸¦è™•ç†è¡¨å–®éŒ¯èª¤ï¼Œä¸¦ä½¿ç”¨ `useFormStatus` ä¾†è™•ç†è¡¨å–®çš„å¾…è™•ç†ç‹€æ…‹ï¼š

```tsx filename="app/login/page.tsx" switcher
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  const handleClick = (event) => {
    if (pending) {
      event.preventDefault()
    }
  }

  return (
    <button aria-disabled={pending} type="submit" onClick={handleClick}>
      Login
    </button>
  )
}
```

```jsx filename="app/login/page.jsx" switcher
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  const handleClick = (event) => {
    if (pending) {
      event.preventDefault()
    }
  }

  return (
    <button aria-disabled={pending} type="submit" onClick={handleClick}>
      Login
    </button>
  )
}
```

</AppOnly>

ç‚ºäº†åœ¨ Next.js å°ˆæ¡ˆä¸­å»ºç«‹æ›´æµæš¢çš„èº«ä»½é©—è­‰è¨­å®šï¼Œç‰¹åˆ¥æ˜¯æä¾›å¤šç¨®ç™»å…¥æ–¹æ³•æ™‚ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨å…¨é¢çš„[èº«ä»½é©—è­‰è§£æ±ºæ–¹æ¡ˆ](#examples)ã€‚

## æˆæ¬Š (Authorization)

ä¸€æ—¦ä½¿ç”¨è€…é€šéèº«ä»½é©—è­‰ï¼Œæ‚¨éœ€è¦ç¢ºä¿ä½¿ç”¨è€…è¢«å…è¨±å­˜å–ç‰¹å®šè·¯ç”±ï¼Œä¸¦åŸ·è¡Œè«¸å¦‚ä½¿ç”¨ä¼ºæœå™¨å‹•ä½œè®Šæ›´è³‡æ–™å’Œå‘¼å«è·¯ç”±è™•ç†å™¨ç­‰æ“ä½œã€‚

### ä½¿ç”¨ä¸­ä»‹è»Ÿé«” (Middleware) ä¿è­·è·¯ç”±

Next.js ä¸­çš„[ä¸­ä»‹è»Ÿé«” (Middleware)](/docs/app/building-your-application/routing/middleware) å¯å¹«åŠ©æ‚¨æ§åˆ¶èª°èƒ½å­˜å–ç¶²ç«™çš„ä¸åŒéƒ¨åˆ†ã€‚é€™å°æ–¼ä¿è­·ä½¿ç”¨è€…å„€è¡¨æ¿ç­‰å€åŸŸåŒæ™‚è®“è¡ŒéŠ·é é¢ç­‰é é¢å…¬é–‹éå¸¸é‡è¦ã€‚å»ºè­°åœ¨æ‰€æœ‰è·¯ç”±ä¸Šæ‡‰ç”¨ä¸­ä»‹è»Ÿé«”ï¼Œä¸¦ç‚ºå…¬é–‹å­˜å–æŒ‡å®šä¾‹å¤–ã€‚

ä»¥ä¸‹æ˜¯åœ¨ Next.js ä¸­å¯¦ä½œèº«ä»½é©—è­‰ä¸­ä»‹è»Ÿé«”çš„æ–¹æ³•ï¼š

#### è¨­å®šä¸­ä»‹è»Ÿé«”ï¼š

- åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸­å»ºç«‹ `middleware.ts` æˆ– `.js` æª”æ¡ˆã€‚
- åŒ…å«æˆæ¬Šä½¿ç”¨è€…å­˜å–çš„é‚è¼¯ï¼Œä¾‹å¦‚æª¢æŸ¥èº«ä»½é©—è­‰ä»¤ç‰Œã€‚

#### å®šç¾©å—ä¿è­·è·¯ç”±ï¼š

- ä¸¦éæ‰€æœ‰è·¯ç”±éƒ½éœ€è¦æˆæ¬Šã€‚ä½¿ç”¨ä¸­ä»‹è»Ÿé«”ä¸­çš„ `matcher` é¸é …æŒ‡å®šä¸éœ€è¦æˆæ¬Šæª¢æŸ¥çš„ä»»ä½•è·¯ç”±ã€‚

#### ä¸­ä»‹è»Ÿé«”é‚è¼¯ï¼š

- ç·¨å¯«é‚è¼¯ä»¥é©—è­‰ä½¿ç”¨è€…æ˜¯å¦é€šéèº«ä»½é©—è­‰ã€‚æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²æˆ–æ¬Šé™ä»¥é€²è¡Œè·¯ç”±æˆæ¬Šã€‚

#### è™•ç†æœªæˆæ¬Šå­˜å–ï¼š

- å°‡æœªæˆæ¬Šä½¿ç”¨è€…é‡æ–°å°å‘è‡³ç™»å…¥é é¢æˆ–éŒ¯èª¤é é¢ã€‚

ä¸­ä»‹è»Ÿé«”æª”æ¡ˆç¯„ä¾‹ï¼š

```ts filename="middleware.ts" switcher
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser && !request.nextUrl.pathname.startsWith('/dashboard')) {
    return Response.redirect(new URL('/dashboard', request.url))
  }

  if (!currentUser && !request.nextUrl.pathname.startsWith('/login')) {
    return Response.redirect(new URL('/login', request.url))
  }
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

```js filename="middleware.js" switcher
export function middleware(request) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser && !request.nextUrl.pathname.startsWith('/dashboard')) {
    return Response.redirect(new URL('/dashboard', request.url))
  }

  if (!currentUser && !request.nextUrl.pathname.startsWith('/login')) {
    return Response.redirect(new URL('/login', request.url))
  }
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

æ­¤ç¯„ä¾‹ä½¿ç”¨ [`Response.redirect`](https://developer.mozilla.org/en-US/docs/Web/API/Response/redirect_static) åœ¨è«‹æ±‚ç®¡ç·šæ—©æœŸè™•ç†é‡æ–°å°å‘ï¼Œä½¿å…¶é«˜æ•ˆä¸¦é›†ä¸­å­˜å–æ§åˆ¶ã€‚

<AppOnly>

å°æ–¼ç‰¹å®šçš„é‡æ–°å°å‘éœ€æ±‚ï¼Œå¯ä»¥åœ¨ä¼ºæœå™¨å…ƒä»¶ã€è·¯ç”±è™•ç†å™¨å’Œä¼ºæœå™¨å‹•ä½œä¸­ä½¿ç”¨ `redirect` å‡½å¼ä»¥æä¾›æ›´å¤šæ§åˆ¶ã€‚é€™å°æ–¼åŸºæ–¼è§’è‰²çš„å°èˆªæˆ–æƒ…å¢ƒæ•æ„Ÿçš„å ´æ™¯éå¸¸æœ‰ç”¨ã€‚

```ts filename="app/page.tsx" switcher
import { redirect } from 'next/navigation'

export default function Page() {
  // åˆ¤æ–·æ˜¯å¦éœ€è¦é‡æ–°å°å‘çš„é‚è¼¯
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // å®šç¾©å…¶ä»–è·¯ç”±å’Œé‚è¼¯
}
```

```js filename="app/page.jsx" switcher
import { redirect } from 'next/navigation'

export default function Page() {
  // åˆ¤æ–·æ˜¯å¦éœ€è¦é‡æ–°å°å‘çš„é‚è¼¯
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // å®šç¾©å…¶ä»–è·¯ç”±å’Œé‚è¼¯
}
```

</AppOnly>

èº«ä»½é©—è­‰æˆåŠŸå¾Œï¼Œæ ¹æ“šä½¿ç”¨è€…è§’è‰²ç®¡ç†å°èˆªéå¸¸é‡è¦ã€‚ä¾‹å¦‚ï¼Œç®¡ç†å“¡ä½¿ç”¨è€…å¯èƒ½æœƒè¢«é‡æ–°å°å‘è‡³ç®¡ç†å„€è¡¨æ¿ï¼Œè€Œä¸€èˆ¬ä½¿ç”¨è€…å‰‡æœƒè¢«å°å‘è‡³å…¶ä»–é é¢ã€‚é€™å°æ–¼è§’è‰²ç‰¹å®šçš„é«”é©—å’Œæ¢ä»¶å¼å°èˆªï¼ˆä¾‹å¦‚åœ¨éœ€è¦æ™‚æç¤ºä½¿ç”¨è€…å®Œæˆå€‹äººè³‡æ–™ï¼‰éå¸¸é‡è¦ã€‚

è¨­å®šæˆæ¬Šæ™‚ï¼Œé‡è¦çš„æ˜¯ç¢ºä¿ä¸»è¦å®‰å…¨æª¢æŸ¥ç™¼ç”Ÿåœ¨æ‡‰ç”¨ç¨‹å¼å­˜å–æˆ–è®Šæ›´è³‡æ–™çš„åœ°æ–¹ã€‚é›–ç„¶ä¸­ä»‹è»Ÿé«”å¯ç”¨æ–¼åˆå§‹é©—è­‰ï¼Œä½†ä¸æ‡‰æˆç‚ºä¿è­·è³‡æ–™çš„å”¯ä¸€é˜²ç·šã€‚å¤§éƒ¨åˆ†å®‰å…¨æª¢æŸ¥æ‡‰åœ¨è³‡æ–™å­˜å–å±¤ (DAL) ä¸­åŸ·è¡Œã€‚

### ä¿è­· API è·¯ç”±

Next.js ä¸­çš„ API è·¯ç”±å°æ–¼è™•ç†ä¼ºæœå™¨ç«¯é‚è¼¯å’Œè³‡æ–™ç®¡ç†è‡³é—œé‡è¦ã€‚ä¿è­·é€™äº›è·¯ç”±çš„å®‰å…¨ï¼Œç¢ºä¿åªæœ‰æˆæ¬Šä½¿ç”¨è€…èƒ½å­˜å–ç‰¹å®šåŠŸèƒ½ï¼Œæ˜¯ç›¸ç•¶é—œéµçš„ã€‚é€™é€šå¸¸æ¶‰åŠé©—è­‰ä½¿ç”¨è€…çš„èªè­‰ç‹€æ…‹åŠå…¶åŸºæ–¼è§’è‰²çš„æ¬Šé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€å€‹ä¿è­· API è·¯ç”±çš„ç¯„ä¾‹ï¼š

```ts filename="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²èªè­‰
  if (!session) {
    res.status(401).json({
      error: 'ä½¿ç”¨è€…æœªèªè­‰',
    })
    return
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ç„¡ç®¡ç†å“¡æ¬Šé™ã€‚',
    })
    return
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å¯¦ä½œ
}
```

```js filename="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req)

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²èªè­‰
  if (!session) {
    res.status(401).json({
      error: 'ä½¿ç”¨è€…æœªèªè­‰',
    })
    return
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ç„¡ç®¡ç†å“¡æ¬Šé™ã€‚',
    })
    return
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å¯¦ä½œ
}
```

æ­¤ç¯„ä¾‹å±•ç¤ºäº†ä¸€å€‹å…·æœ‰é›™å±¤å®‰å…¨æª¢æŸ¥çš„ API è·¯ç”±ï¼Œç”¨æ–¼èªè­‰å’Œæˆæ¬Šã€‚å®ƒé¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æœƒè©±ï¼Œç„¶å¾Œé©—è­‰ç™»å…¥ä½¿ç”¨è€…æ˜¯å¦ç‚º 'admin'ã€‚é€™ç¨®æ–¹æ³•ç¢ºä¿äº†åªæœ‰ç¶“éèªè­‰å’Œæˆæ¬Šçš„ä½¿ç”¨è€…æ‰èƒ½å­˜å–ï¼Œç¶­æŒäº†è«‹æ±‚è™•ç†çš„å¼·å¥å®‰å…¨æ€§ã€‚

</PagesOnly>

<AppOnly>

é€™ç¨®æ–¹æ³•ï¼Œåœ¨[é€™ç¯‡å®‰å…¨æ€§éƒ¨è½æ ¼](/blog/security-nextjs-server-components-actions)ä¸­æœ‰å¼·èª¿ï¼Œæå€¡å°‡æ‰€æœ‰è³‡æ–™å­˜å–é›†ä¸­åœ¨å°ˆç”¨çš„ DAL (è³‡æ–™å­˜å–å±¤) ä¸­ã€‚æ­¤ç­–ç•¥ç¢ºä¿ä¸€è‡´çš„è³‡æ–™å­˜å–ï¼Œæ¸›å°‘æˆæ¬ŠéŒ¯èª¤ï¼Œä¸¦ç°¡åŒ–ç¶­è­·å·¥ä½œã€‚ç‚ºäº†ç¢ºä¿å…¨é¢çš„å®‰å…¨æ€§ï¼Œè«‹è€ƒæ…®ä»¥ä¸‹é—œéµé ˜åŸŸï¼š

- ä¼ºæœå™¨å‹•ä½œ (Server Actions)ï¼šåœ¨ä¼ºæœå™¨ç«¯æµç¨‹ä¸­å¯¦ä½œå®‰å…¨æ€§æª¢æŸ¥ï¼Œç‰¹åˆ¥æ˜¯é‡å°æ•æ„Ÿæ“ä½œã€‚
- è·¯ç”±è™•ç†å™¨ (Route Handlers)ï¼šç®¡ç†å‚³å…¥è«‹æ±‚æ™‚æ‡‰æ¡å–å®‰å…¨æªæ–½ï¼Œç¢ºä¿åªæœ‰æˆæ¬Šä½¿ç”¨è€…èƒ½å­˜å–ã€‚
- è³‡æ–™å­˜å–å±¤ (DAL)ï¼šç›´æ¥èˆ‡è³‡æ–™åº«äº’å‹•ï¼Œå°æ–¼é©—è­‰å’Œæˆæ¬Šè³‡æ–™äº¤æ˜“è‡³é—œé‡è¦ã€‚åœ¨ DAL ä¸­åŸ·è¡Œé—œéµæª¢æŸ¥ï¼Œä»¥åœ¨è³‡æ–™æœ€é—œéµçš„äº’å‹•é»ï¼ˆå­˜å–æˆ–ä¿®æ”¹ï¼‰ç¢ºä¿å®‰å…¨ã€‚

æœ‰é—œä¿è­· DAL çš„è©³ç´°æŒ‡å—ï¼ŒåŒ…æ‹¬ç¯„ä¾‹ç¨‹å¼ç¢¼ç‰‡æ®µå’Œé€²éšå®‰å…¨å¯¦è¸ï¼Œè«‹åƒé–±æˆ‘å€‘å®‰å…¨æ€§æŒ‡å—ä¸­çš„[è³‡æ–™å­˜å–å±¤ç« ç¯€](/blog/security-nextjs-server-components-actions#data-access-layer)ã€‚

### ä¿è­·ä¼ºæœå™¨å‹•ä½œ

å°å¾…[ä¼ºæœå™¨å‹•ä½œ](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)æ™‚ï¼Œæ‡‰èˆ‡å…¬é–‹ API ç«¯é»æ¡å–ç›¸åŒçš„å®‰å…¨è€ƒé‡ã€‚é©—è­‰æ¯å€‹å‹•ä½œçš„ä½¿ç”¨è€…æˆæ¬Šè‡³é—œé‡è¦ã€‚åœ¨ä¼ºæœå™¨å‹•ä½œä¸­å¯¦ä½œæª¢æŸ¥ä»¥ç¢ºå®šä½¿ç”¨è€…æ¬Šé™ï¼Œä¾‹å¦‚é™åˆ¶æŸäº›å‹•ä½œåƒ…ä¾›ç®¡ç†å“¡ä½¿ç”¨è€…åŸ·è¡Œã€‚

åœ¨ä»¥ä¸‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘åœ¨å…è¨±å‹•ä½œç¹¼çºŒä¹‹å‰æª¢æŸ¥ä½¿ç”¨è€…çš„è§’è‰²ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬ŠåŸ·è¡Œè©²å‹•ä½œ
  if (userRole !== 'admin') {
    throw new Error('æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ç„¡ç®¡ç†å“¡æ¬Šé™ã€‚')
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œå‹•ä½œ
  // ... å‹•ä½œçš„å¯¦ä½œ
}
```

```js filename="app/lib/actions.js" switcher
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬ŠåŸ·è¡Œè©²å‹•ä½œ
  if (userRole !== 'admin') {
    throw new Error('æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ç„¡ç®¡ç†å“¡æ¬Šé™ã€‚')
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œå‹•ä½œ
  // ... å‹•ä½œçš„å¯¦ä½œ
}
```

### ä¿è­·è·¯ç”±è™•ç†å™¨

Next.js ä¸­çš„è·¯ç”±è™•ç†å™¨åœ¨ç®¡ç†å‚³å…¥è«‹æ±‚æ–¹é¢æ‰®æ¼”é‡è¦è§’è‰²ã€‚èˆ‡ä¼ºæœå™¨å‹•ä½œä¸€æ¨£ï¼Œå®ƒå€‘æ‡‰å—åˆ°ä¿è­·ï¼Œç¢ºä¿åªæœ‰æˆæ¬Šä½¿ç”¨è€…èƒ½å­˜å–ç‰¹å®šåŠŸèƒ½ã€‚é€™é€šå¸¸æ¶‰åŠé©—è­‰ä½¿ç”¨è€…çš„èªè­‰ç‹€æ…‹åŠå…¶æ¬Šé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€å€‹ä¿è­·è·¯ç”±è™•ç†å™¨çš„ç¯„ä¾‹ï¼š

```ts filename="app/api/route.ts" switcher
export async function GET() {
  // ä½¿ç”¨è€…èªè­‰å’Œè§’è‰²é©—è­‰
  const session = await getSession()

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²èªè­‰
  if (!session) {
    return new Response(null, { status: 401 }) // ä½¿ç”¨è€…æœªèªè­‰
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // ä½¿ç”¨è€…å·²èªè­‰ä½†ç„¡æ¬Šé™
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…å–å¾—è³‡æ–™
}
```

```js filename="app/api/route.js" switcher
export async function GET() {
  // ä½¿ç”¨è€…èªè­‰å’Œè§’è‰²é©—è­‰
  const session = await getSession()

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²èªè­‰
  if (!session) {
    return new Response(null, { status: 401 }) // ä½¿ç”¨è€…æœªèªè­‰
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // ä½¿ç”¨è€…å·²èªè­‰ä½†ç„¡æ¬Šé™
  }

  // ç‚ºæˆæ¬Šä½¿ç”¨è€…å–å¾—è³‡æ–™
}
```

æ­¤ç¯„ä¾‹å±•ç¤ºäº†ä¸€å€‹å…·æœ‰é›™å±¤å®‰å…¨æª¢æŸ¥çš„è·¯ç”±è™•ç†å™¨ï¼Œç”¨æ–¼èªè­‰å’Œæˆæ¬Šã€‚å®ƒé¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æœƒè©±ï¼Œç„¶å¾Œé©—è­‰ç™»å…¥ä½¿ç”¨è€…æ˜¯å¦ç‚º 'admin'ã€‚é€™ç¨®æ–¹æ³•ç¢ºä¿äº†åªæœ‰ç¶“éèªè­‰å’Œæˆæ¬Šçš„ä½¿ç”¨è€…æ‰èƒ½å­˜å–ï¼Œç¶­æŒäº†è«‹æ±‚è™•ç†çš„å¼·å¥å®‰å…¨æ€§ã€‚

### ä½¿ç”¨ä¼ºæœå™¨å…ƒä»¶é€²è¡Œæˆæ¬Š

Next.js ä¸­çš„[ä¼ºæœå™¨å…ƒä»¶](/docs/app/building-your-application/rendering/server-components)å°ˆç‚ºä¼ºæœå™¨ç«¯åŸ·è¡Œè€Œè¨­è¨ˆï¼Œç‚ºæ•´åˆè¤‡é›œé‚è¼¯ï¼ˆå¦‚æˆæ¬Šï¼‰æä¾›äº†å®‰å…¨çš„ç’°å¢ƒã€‚å®ƒå€‘èƒ½ç›´æ¥å­˜å–å¾Œç«¯è³‡æºï¼Œå„ªåŒ–äº†è³‡æ–™å¯†é›†å‹ä»»å‹™çš„æ•ˆèƒ½ï¼Œä¸¦å¢å¼·äº†æ•æ„Ÿæ“ä½œçš„å®‰å…¨æ€§ã€‚

åœ¨ä¼ºæœå™¨å…ƒä»¶ä¸­ï¼Œå¸¸è¦‹çš„åšæ³•æ˜¯æ ¹æ“šä½¿ç”¨è€…è§’è‰²æ¢ä»¶å¼æ¸²æŸ“ UI å…ƒç´ ã€‚é€™ç¨®æ–¹æ³•é€éç¢ºä¿ä½¿ç”¨è€…åªèƒ½å­˜å–ä»–å€‘æœ‰æ¬ŠæŸ¥çœ‹çš„å…§å®¹ï¼Œæå‡äº†ä½¿ç”¨è€…é«”é©—å’Œå®‰å…¨æ€§ã€‚

**ç¯„ä¾‹ï¼š**

```tsx filename="app/dashboard/page.tsx" switcher
export default async function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // å‡è¨­ 'role' æ˜¯æœƒè©±ç‰©ä»¶çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard /> // ç®¡ç†å“¡ä½¿ç”¨è€…çš„å…ƒä»¶
  } else if (userRole === 'user') {
    return <UserDashboard /> // ä¸€èˆ¬ä½¿ç”¨è€…çš„å…ƒä»¶
  } else {
    return <AccessDenied /> // æœªæˆæ¬Šå­˜å–æ™‚é¡¯ç¤ºçš„å…ƒä»¶
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
export default function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // å‡è¨­ 'role' æ˜¯æœƒè©±ç‰©ä»¶çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard /> // ç®¡ç†å“¡ä½¿ç”¨è€…çš„å…ƒä»¶
  } else if (userRole === 'user') {
    return <UserDashboard /> // ä¸€èˆ¬ä½¿ç”¨è€…çš„å…ƒä»¶
  } else {
    return <AccessDenied /> // æœªæˆæ¬Šå­˜å–æ™‚é¡¯ç¤ºçš„å…ƒä»¶
  }
}
```

åœ¨æ­¤ç¯„ä¾‹ä¸­ï¼ŒDashboard å…ƒä»¶æ ¹æ“š 'admin'ã€'user' å’Œæœªæˆæ¬Šè§’è‰²æ¸²æŸ“ä¸åŒçš„ UIã€‚é€™ç¨®æ¨¡å¼ç¢ºä¿æ¯ä½ä½¿ç”¨è€…åƒ…èˆ‡ç¬¦åˆå…¶è§’è‰²çš„å…ƒä»¶äº’å‹•ï¼ŒåŒæ™‚æå‡äº†å®‰å…¨æ€§å’Œä½¿ç”¨è€…é«”é©—ã€‚

</AppOnly>

### æœ€ä½³å¯¦è¸

- **å®‰å…¨çš„æœƒè©±ç®¡ç†**ï¼šå„ªå…ˆä¿è­·æœƒè©±è³‡æ–™çš„å®‰å…¨ï¼Œé˜²æ­¢æœªæˆæ¬Šå­˜å–å’Œè³‡æ–™å¤–æ´©ã€‚ä½¿ç”¨åŠ å¯†å’Œå®‰å…¨å„²å­˜å¯¦è¸ã€‚
- **å‹•æ…‹è§’è‰²ç®¡ç†**ï¼šä½¿ç”¨å½ˆæ€§çš„ä½¿ç”¨è€…è§’è‰²ç³»çµ±ï¼Œè¼•é¬†é©æ‡‰æ¬Šé™å’Œè§’è‰²çš„è®Šæ›´ï¼Œé¿å…ç¡¬ç·¨ç¢¼è§’è‰²ã€‚
- **å®‰å…¨å„ªå…ˆçš„æ€ç¶­**ï¼šåœ¨æ‰€æœ‰æˆæ¬Šé‚è¼¯ä¸­ï¼Œå„ªå…ˆè€ƒæ…®å®‰å…¨æ€§ä»¥ä¿è­·ä½¿ç”¨è€…è³‡æ–™ä¸¦ç¶­è­·æ‡‰ç”¨ç¨‹å¼çš„å®Œæ•´æ€§ã€‚é€™åŒ…æ‹¬å¾¹åº•çš„æ¸¬è©¦å’Œè€ƒæ…®æ½›åœ¨çš„å®‰å…¨æ¼æ´ã€‚

## æœƒè©±ç®¡ç†

æœƒè©±ç®¡ç†æ¶‰åŠè¿½è¹¤å’Œç®¡ç†ä½¿ç”¨è€…èˆ‡æ‡‰ç”¨ç¨‹å¼çš„äº’å‹•ï¼Œç¢ºä¿å…¶èªè­‰ç‹€æ…‹åœ¨æ‡‰ç”¨ç¨‹å¼çš„ä¸åŒéƒ¨åˆ†ä¹‹é–“æŒçºŒå­˜åœ¨ã€‚

é€™é¿å…äº†é‡è¤‡ç™»å…¥çš„éœ€æ±‚ï¼ŒåŒæ™‚æå‡äº†å®‰å…¨æ€§å’Œä½¿ç”¨è€…ä¾¿åˆ©æ€§ã€‚æœƒè©±ç®¡ç†ä¸»è¦æœ‰å…©ç¨®æ–¹æ³•ï¼šåŸºæ–¼ Cookie çš„æœƒè©±å’Œè³‡æ–™åº«æœƒè©±ã€‚

### åŸºæ–¼ Cookie çš„æœƒè©±

> **ğŸ¥ è§€çœ‹ï¼š** äº†è§£æ›´å¤šé—œæ–¼åŸºæ–¼ Cookie çš„æœƒè©±å’Œ Next.js èªè­‰ â†’ [YouTube (11 åˆ†é˜)](https://www.youtube.com/watch?v=DJvM2lSPn6w)ã€‚

åŸºæ–¼ Cookie çš„æœƒè©±é€éå°‡åŠ å¯†çš„æœƒè©±è³‡è¨Šç›´æ¥å„²å­˜åœ¨ç€è¦½å™¨ Cookie ä¸­ä¾†ç®¡ç†ä½¿ç”¨è€…è³‡æ–™ã€‚ä½¿ç”¨è€…ç™»å…¥å¾Œï¼Œé€™äº›åŠ å¯†è³‡æ–™æœƒå„²å­˜åœ¨ Cookie ä¸­ã€‚å¾ŒçºŒçš„æ¯å€‹ä¼ºæœå™¨è«‹æ±‚éƒ½æœƒåŒ…å«æ­¤ Cookieï¼Œæ¸›å°‘äº†é‡è¤‡ä¼ºæœå™¨æŸ¥è©¢çš„éœ€æ±‚ï¼Œæå‡äº†å®¢æˆ¶ç«¯æ•ˆç‡ã€‚

ç„¶è€Œï¼Œæ­¤æ–¹æ³•éœ€è¦è¬¹æ…åŠ å¯†ä»¥ä¿è­·æ•æ„Ÿè³‡æ–™ï¼Œå› ç‚º Cookie å®¹æ˜“å—åˆ°å®¢æˆ¶ç«¯å®‰å…¨é¢¨éšªçš„å½±éŸ¿ã€‚åŠ å¯† Cookie ä¸­çš„æœƒè©±è³‡æ–™æ˜¯ä¿è­·ä½¿ç”¨è€…è³‡è¨Šå…å—æœªæˆæ¬Šå­˜å–çš„é—œéµã€‚é€™ç¢ºä¿å³ä½¿ Cookie è¢«ç«Šå–ï¼Œå…¶ä¸­çš„è³‡æ–™ä»ç„¡æ³•è¢«è®€å–ã€‚

æ­¤å¤–ï¼Œé›–ç„¶å–®å€‹ Cookie çš„å¤§å°æœ‰é™ï¼ˆé€šå¸¸ç´„ 4KBï¼‰ï¼Œä½†åƒ Cookie åˆ†å¡Šé€™æ¨£çš„æŠ€è¡“å¯ä»¥é€éå°‡å¤§å‹æœƒè©±è³‡æ–™åˆ†å‰²æˆå¤šå€‹ Cookie ä¾†å…‹æœæ­¤é™åˆ¶ã€‚

åœ¨ Next.js å°ˆæ¡ˆä¸­è¨­å®š Cookie å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

**åœ¨ä¼ºæœå™¨ä¸Šè¨­å®š Cookieï¼š**

<PagesOnly>

```ts filename="pages/api/login.ts" switcher
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè¨­å®š Cookieï¼' })
}
```

```js filename="pages/api/login.js" switcher
import { serialize } from 'cookie'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè¨­å®š Cookieï¼' })
}
```

</PagesOnly>

<AppOnly>

```ts filename="app/actions.ts" switcher
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // åŠ å¯†ä½ çš„æœƒè©±è³‡æ–™
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  // è¨­å®š Cookie å¾Œé‡æ–°å°å‘æˆ–è™•ç†å›æ‡‰
}
```

```js filename="app/actions.js" switcher
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // åŠ å¯†ä½ çš„æœƒè©±è³‡æ–™
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  // è¨­å®š Cookie å¾Œé‡æ–°å°å‘æˆ–è™•ç†å›æ‡‰
}
```

**åœ¨ä¼ºæœå™¨å…ƒä»¶ä¸­å­˜å–å„²å­˜åœ¨ Cookie ä¸­çš„æœƒè©±è³‡æ–™ï¼š**

```tsx filename="app/page.tsx" switcher
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

```jsx filename="app/page.jsx" switcher
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

</AppOnly>

### è³‡æ–™åº«æœƒè©±

è³‡æ–™åº«æœƒè©±ç®¡ç†æ¶‰åŠå°‡æœƒè©±è³‡æ–™å„²å­˜åœ¨ä¼ºæœå™¨ä¸Šï¼Œä½¿ç”¨è€…çš„ç€è¦½å™¨åƒ…æ¥æ”¶æœƒè©± IDã€‚æ­¤ ID åƒç…§å„²å­˜åœ¨ä¼ºæœå™¨ç«¯çš„æœƒè©±è³‡æ–™ï¼Œè€Œä¸åŒ…å«è³‡æ–™æœ¬èº«ã€‚é€™ç¨®æ–¹æ³•æå‡äº†å®‰å…¨æ€§ï¼Œå› ç‚ºå®ƒå°‡æ•æ„Ÿçš„æœƒè©±è³‡æ–™é é›¢å®¢æˆ¶ç«¯ç’°å¢ƒï¼Œé™ä½äº†æš´éœ²æ–¼å®¢æˆ¶ç«¯æ”»æ“Šçš„é¢¨éšªã€‚è³‡æ–™åº«æœƒè©±ä¹Ÿæ›´å…·æœ‰æ“´å±•æ€§ï¼Œèƒ½é©æ‡‰æ›´å¤§çš„è³‡æ–™å„²å­˜éœ€æ±‚ã€‚

ç„¶è€Œï¼Œé€™ç¨®æ–¹æ³•æœ‰å…¶æ¬Šè¡¡ã€‚ç”±æ–¼æ¯æ¬¡ä½¿ç”¨è€…äº’å‹•éƒ½éœ€è¦é€²è¡Œè³‡æ–™åº«æŸ¥è©¢ï¼Œå¯èƒ½æœƒå¢åŠ æ•ˆèƒ½é–‹éŠ·ã€‚åƒæœƒè©±è³‡æ–™å¿«å–é€™æ¨£çš„ç­–ç•¥å¯ä»¥å¹«åŠ©ç·©è§£æ­¤å•é¡Œã€‚æ­¤å¤–ï¼Œä¾è³´è³‡æ–™åº«æ„å‘³è‘—æœƒè©±ç®¡ç†çš„å¯é æ€§å–æ±ºæ–¼è³‡æ–™åº«çš„æ•ˆèƒ½å’Œå¯ç”¨æ€§ã€‚

ä»¥ä¸‹æ˜¯ä¸€å€‹åœ¨ Next.js æ‡‰ç”¨ä¸­å¯¦ä½œè³‡æ–™åº«æœƒè©±çš„ç°¡åŒ–ç¯„ä¾‹ï¼š

**åœ¨ä¼ºæœå™¨ä¸Šå»ºç«‹æœƒè©±**ï¼š

<PagesOnly>

```ts filename="pages/api/create-session.ts" switcher
import db from '../../lib/db'
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤' })
  }
}
```

```js filename="pages/api/create-session.js" switcher
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤' })
  }
}
```

</PagesOnly>

<AppOnly>

```js
import db from './lib/db'

export async function createSession(user) {
  const sessionId = generateSessionId() // ç”¢ç”Ÿå”¯ä¸€çš„æœƒè©± ID
  await db.insertSession({ sessionId, userId: user.id, createdAt: new Date() })
  return sessionId
}
```

**åœ¨ä¸­é–“ä»¶æˆ–ä¼ºæœå™¨ç«¯é‚è¼¯ä¸­å–å¾—æœƒè©±**ï¼š

```js
import { cookies } from 'next/headers'
import db from './lib/db'

export async function getSession() {
  const sessionId = cookies().get('sessionId')?.value
  return sessionId ? await db.findSession(sessionId) : null
}
```

</AppOnly>

### åœ¨ Next.js ä¸­é¸æ“‡æœƒè©±ç®¡ç†æ–¹å¼

åœ¨ Next.js ä¸­é¸æ“‡åŸºæ–¼ Cookie æˆ–åŸºæ–¼è³‡æ–™åº«çš„æœƒè©±ç®¡ç†ï¼Œå–æ±ºæ–¼æ‡‰ç”¨ç¨‹å¼çš„éœ€æ±‚ã€‚åŸºæ–¼ Cookie çš„æœƒè©±è¼ƒç‚ºç°¡å–®ï¼Œé©åˆä¼ºæœå™¨è² è¼‰è¼ƒä½çš„å°å‹æ‡‰ç”¨ç¨‹å¼ï¼Œä½†å®‰å…¨æ€§å¯èƒ½è¼ƒä½ã€‚åŸºæ–¼è³‡æ–™åº«çš„æœƒè©±é›–ç„¶è¼ƒè¤‡é›œï¼Œä½†èƒ½æä¾›æ›´å¥½çš„å®‰å…¨æ€§å’Œæ“´å±•æ€§ï¼Œæ˜¯å¤§å‹ä¸”å°è³‡æ–™æ•æ„Ÿçš„æ‡‰ç”¨ç¨‹å¼çš„ç†æƒ³é¸æ“‡ã€‚

é€éå¦‚ [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5) é€™æ¨£çš„[èº«ä»½é©—è­‰è§£æ±ºæ–¹æ¡ˆ](#examples)ï¼Œæœƒè©±ç®¡ç†æœƒæ›´åŠ é«˜æ•ˆï¼Œç„¡è«–æ˜¯ä½¿ç”¨ Cookie é‚„æ˜¯è³‡æ–™åº«å„²å­˜ã€‚é€™ç¨®è‡ªå‹•åŒ–ç°¡åŒ–äº†é–‹ç™¼æµç¨‹ï¼Œä½†äº†è§£æ‰€é¸è§£æ±ºæ–¹æ¡ˆä½¿ç”¨çš„æœƒè©±ç®¡ç†æ–¹æ³•éå¸¸é‡è¦ã€‚ç¢ºä¿å®ƒç¬¦åˆæ‡‰ç”¨ç¨‹å¼çš„å®‰å…¨æ€§å’Œæ•ˆèƒ½éœ€æ±‚ã€‚

ç„¡è«–é¸æ“‡å“ªç¨®æ–¹å¼ï¼Œéƒ½æ‡‰åœ¨æœƒè©±ç®¡ç†ç­–ç•¥ä¸­å„ªå…ˆè€ƒæ…®å®‰å…¨æ€§ã€‚å°æ–¼åŸºæ–¼ Cookie çš„æœƒè©±ï¼Œä½¿ç”¨å®‰å…¨ä¸”åƒ…é™ HTTP çš„ Cookie å°æ–¼ä¿è­·æœƒè©±è³‡æ–™è‡³é—œé‡è¦ã€‚å°æ–¼åŸºæ–¼è³‡æ–™åº«çš„æœƒè©±ï¼Œå®šæœŸå‚™ä»½å’Œå®‰å…¨è™•ç†æœƒè©±è³‡æ–™æ˜¯å¿…ä¸å¯å°‘çš„ã€‚åœ¨å…©ç¨®æ–¹æ³•ä¸­ï¼Œå¯¦ä½œæœƒè©±éæœŸå’Œæ¸…ç†æ©Ÿåˆ¶å°æ–¼é˜²æ­¢æœªç¶“æˆæ¬Šçš„å­˜å–ä»¥åŠç¶­è­·æ‡‰ç”¨ç¨‹å¼çš„æ•ˆèƒ½å’Œå¯é æ€§éƒ½éå¸¸é‡è¦ã€‚

## ç¯„ä¾‹

ä»¥ä¸‹æ˜¯èˆ‡ Next.js ç›¸å®¹çš„èº«ä»½é©—è­‰è§£æ±ºæ–¹æ¡ˆï¼Œè«‹åƒè€ƒä»¥ä¸‹å¿«é€Ÿå…¥é–€æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åœ¨ Next.js æ‡‰ç”¨ç¨‹å¼ä¸­é…ç½®å®ƒå€‘ï¼š

{/* TODO: Change link to authjs.dev when new documentation is ready */}

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Lucia](https://lucia-auth.com/getting-started/nextjs-app)
- [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [Iron Session](https://github.com/vvo/iron-session)

## å»¶ä¼¸é–±è®€

è‹¥è¦ç¹¼çºŒå­¸ç¿’æœ‰é—œèº«ä»½é©—è­‰å’Œå®‰å…¨çš„çŸ¥è­˜ï¼Œè«‹æŸ¥çœ‹ä»¥ä¸‹è³‡æºï¼š

- [äº†è§£ XSS æ”»æ“Š](https://vercel.com/guides/understanding-xss-attacks)
- [äº†è§£ CSRF æ”»æ“Š](https://vercel.com/guides/understanding-csrf-attacks)
