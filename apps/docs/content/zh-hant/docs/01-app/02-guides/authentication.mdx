---
source-updated-at: 2025-06-08T05:18:05.000Z
translation-updated-at: 2025-06-08T21:02:11.461Z
title: å¦‚ä½•åœ¨ Next.js ä¸­å¯¦ç¾èº«ä»½é©—è­‰
nav_title: èº«ä»½é©—è­‰
description: å­¸ç¿’å¦‚ä½•åœ¨æ‚¨çš„ Next.js æ‡‰ç”¨ç¨‹å¼ä¸­å¯¦ç¾èº«ä»½é©—è­‰åŠŸèƒ½ã€‚
---

ç†è§£èº«ä»½é©—è­‰å°æ–¼ä¿è­·æ‡‰ç”¨ç¨‹å¼è³‡æ–™è‡³é—œé‡è¦ã€‚æœ¬é å°‡å¼•å°æ‚¨äº†è§£å¦‚ä½•ä½¿ç”¨ React å’Œ Next.js åŠŸèƒ½ä¾†å¯¦ç¾èº«ä»½é©—è­‰ã€‚

é–‹å§‹ä¹‹å‰ï¼Œå¯ä»¥å°‡æµç¨‹åˆ†è§£ç‚ºä¸‰å€‹æ¦‚å¿µï¼š

1. **[èº«ä»½é©—è­‰ (Authentication)](#authentication)**ï¼šé©—è­‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºå…¶æ‰€è²ç¨±çš„èº«ä»½ã€‚è¦æ±‚ä½¿ç”¨è€…é€šéä»–å€‘æ“æœ‰çš„æ†‘è­‰ï¼ˆå¦‚ç”¨æˆ¶åå’Œå¯†ç¢¼ï¼‰ä¾†è­‰æ˜èº«ä»½ã€‚
2. **[æœƒè©±ç®¡ç† (Session Management)](#session-management)**ï¼šè·¨è«‹æ±‚è¿½è¹¤ä½¿ç”¨è€…çš„é©—è­‰ç‹€æ…‹ã€‚
3. **[æˆæ¬Š (Authorization)](#authorization)**ï¼šæ±ºå®šä½¿ç”¨è€…å¯ä»¥å­˜å–å“ªäº›è·¯ç”±å’Œè³‡æ–™ã€‚

ä»¥ä¸‹åœ–è¡¨å±•ç¤ºäº†ä½¿ç”¨ React å’Œ Next.js åŠŸèƒ½çš„èº«ä»½é©—è­‰æµç¨‹ï¼š

<Image
  alt="å±•ç¤ºä½¿ç”¨ React å’Œ Next.js åŠŸèƒ½çš„èº«ä»½é©—è­‰æµç¨‹åœ–"
  srcLight="/docs/light/authentication-overview.png"
  srcDark="/docs/dark/authentication-overview.png"
  width="1600"
  height="1383"
/>

æœ¬é ç¤ºä¾‹ç‚ºæ•™å­¸ç›®çš„å±•ç¤ºäº†åŸºæœ¬çš„ç”¨æˆ¶åå’Œå¯†ç¢¼é©—è­‰ã€‚é›–ç„¶æ‚¨å¯ä»¥å¯¦ç¾è‡ªè¨‚çš„èº«ä»½é©—è­‰æ–¹æ¡ˆï¼Œä½†ç‚ºäº†æé«˜å®‰å…¨æ€§å’Œç°¡åŒ–æµç¨‹ï¼Œæˆ‘å€‘å»ºè­°ä½¿ç”¨èº«ä»½é©—è­‰å‡½å¼åº«ã€‚é€™äº›å‡½å¼åº«æä¾›äº†å…§å»ºçš„èº«ä»½é©—è­‰ã€æœƒè©±ç®¡ç†å’Œæˆæ¬Šè§£æ±ºæ–¹æ¡ˆï¼Œä»¥åŠé¡å¤–åŠŸèƒ½å¦‚ç¤¾äº¤ç™»å…¥ã€å¤šå› ç´ é©—è­‰å’ŒåŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶ã€‚æ‚¨å¯ä»¥åœ¨[èº«ä»½é©—è­‰å‡½å¼åº«](#auth-libraries)éƒ¨åˆ†æ‰¾åˆ°ç›¸é—œåˆ—è¡¨ã€‚

## èº«ä»½é©—è­‰

<AppOnly>

### è¨»å†Šå’Œç™»å…¥åŠŸèƒ½

æ‚¨å¯ä»¥ä½¿ç”¨ [`<form>`](https://react.dev/reference/react-dom/components/form) å…ƒç´ æ­é… React çš„[ä¼ºæœå™¨å‹•ä½œ (Server Actions)](/docs/app/building-your-application/data-fetching/server-actions-and-mutations) å’Œ `useActionState` ä¾†ç²å–ä½¿ç”¨è€…æ†‘è­‰ã€é©—è­‰è¡¨å–®æ¬„ä½ï¼Œä¸¦å‘¼å«æ‚¨çš„èº«ä»½é©—è­‰æä¾›è€… API æˆ–è³‡æ–™åº«ã€‚

ç”±æ–¼ä¼ºæœå™¨å‹•ä½œç¸½æ˜¯åœ¨ä¼ºæœå™¨ç«¯åŸ·è¡Œï¼Œå› æ­¤æä¾›äº†è™•ç†èº«ä»½é©—è­‰é‚è¼¯çš„å®‰å…¨ç’°å¢ƒã€‚

ä»¥ä¸‹æ˜¯å¯¦ç¾è¨»å†Š/ç™»å…¥åŠŸèƒ½çš„æ­¥é©Ÿï¼š

#### 1. ç²å–ä½¿ç”¨è€…æ†‘è­‰

è¦ç²å–ä½¿ç”¨è€…æ†‘è­‰ï¼Œå»ºç«‹ä¸€å€‹åœ¨æäº¤æ™‚èª¿ç”¨ä¼ºæœå™¨å‹•ä½œçš„è¡¨å–®ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹æ¥å—ä½¿ç”¨è€…åç¨±ã€é›»å­éƒµä»¶å’Œå¯†ç¢¼çš„è¨»å†Šè¡¨å–®ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  )
}
```

```jsx filename="app/ui/signup-form.js" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  )
}
```

```tsx filename="app/actions/auth.ts" switcher
export async function signup(formData: FormData) {}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(formData) {}
```

#### 2. åœ¨ä¼ºæœå™¨ç«¯é©—è­‰è¡¨å–®æ¬„ä½

ä½¿ç”¨ä¼ºæœå™¨å‹•ä½œåœ¨ä¼ºæœå™¨ç«¯é©—è­‰è¡¨å–®æ¬„ä½ã€‚å¦‚æœæ‚¨çš„èº«ä»½é©—è­‰æä¾›è€…ä¸æä¾›è¡¨å–®é©—è­‰ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ [Zod](https://zod.dev/) æˆ– [Yup](https://github.com/jquense/yup) é€™æ¨£çš„æ¨¡å¼é©—è­‰å‡½å¼åº«ã€‚

ä»¥ Zod ç‚ºä¾‹ï¼Œæ‚¨å¯ä»¥å®šç¾©ä¸€å€‹å¸¶æœ‰é©ç•¶éŒ¯èª¤è¨Šæ¯çš„è¡¨å–®æ¨¡å¼ï¼š

```ts filename="app/lib/definitions.ts" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'Name must be at least 2 characters long.' })
    .trim(),
  email: z.string().email({ message: 'Please enter a valid email.' }).trim(),
  password: z
    .string()
    .min(8, { message: 'Be at least 8 characters long' })
    .regex(/[a-zA-Z]/, { message: 'Contain at least one letter.' })
    .regex(/[0-9]/, { message: 'Contain at least one number.' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'Contain at least one special character.',
    })
    .trim(),
})

export type FormState =
  | {
      errors?: {
        name?: string[]
        email?: string[]
        password?: string[]
      }
      message?: string
    }
  | undefined
```

```js filename="app/lib/definitions.js" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'Name must be at least 2 characters long.' })
    .trim(),
  email: z.string().email({ message: 'Please enter a valid email.' }).trim(),
  password: z
    .string()
    .min(8, { message: 'Be at least 8 characters long' })
    .regex(/[a-zA-Z]/, { message: 'Contain at least one letter.' })
    .regex(/[0-9]/, { message: 'Contain at least one number.' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'Contain at least one special character.',
    })
    .trim(),
})
```

ç‚ºäº†é¿å…ä¸å¿…è¦çš„èº«ä»½é©—è­‰æä¾›è€… API æˆ–è³‡æ–™åº«å‘¼å«ï¼Œå¦‚æœä»»ä½•è¡¨å–®æ¬„ä½ä¸ç¬¦åˆå®šç¾©çš„æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨ä¼ºæœå™¨å‹•ä½œä¸­æå‰ `return`ã€‚

```ts filename="app/actions/auth.ts" switcher
import { SignupFormSchema, FormState } from '@/app/lib/definitions'

export async function signup(state: FormState, formData: FormData) {
  // Validate form fields
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // If any form fields are invalid, return early
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // Call the provider or db to create a user...
}
```

```js filename="app/actions/auth.js" switcher
import { SignupFormSchema } from '@/app/lib/definitions'

export async function signup(state, formData) {
  // Validate form fields
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // If any form fields are invalid, return early
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // Call the provider or db to create a user...
}
```

å›åˆ°æ‚¨çš„ `<SignupForm />`ï¼Œå¯ä»¥ä½¿ç”¨ React çš„ `useActionState` é‰¤å­åœ¨è¡¨å–®æäº¤æ™‚é¡¯ç¤ºé©—è­‰éŒ¯èª¤ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher highlight={7,15,21,27-36}
'use client'

import { signup } from '@/app/actions/auth'
import { useActionState } from 'react'

export default function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="Email" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button disabled={pending} type="submit">
        Sign Up
      </button>
    </form>
  )
}
```

```jsx filename="app/ui/signup-form.js" switcher highlight={7,15,21,27-36}
'use client'

import { signup } from '@/app/actions/auth'
import { useActionState } from 'react'

export default function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="Email" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button disabled={pending} type="submit">
        Sign Up
      </button>
    </form>
  )
}
```

> **é ˆçŸ¥äº‹é …ï¼š**
>
> - åœ¨ React 19 ä¸­ï¼Œ`useFormStatus` åŒ…å«è¿”å›ç‰©ä»¶ä¸Šçš„å…¶ä»–éµï¼Œå¦‚ dataã€method å’Œ actionã€‚å¦‚æœæ‚¨ä¸ä½¿ç”¨ React 19ï¼Œå‰‡åªæœ‰ `pending` éµå¯ç”¨ã€‚
> - åœ¨è®Šæ›´è³‡æ–™ä¹‹å‰ï¼Œæ‚¨æ‡‰è©²å§‹çµ‚ç¢ºä¿ä½¿ç”¨è€…ä¹Ÿæœ‰æ¬ŠåŸ·è¡Œè©²æ“ä½œã€‚è«‹åƒé–±[èº«ä»½é©—è­‰èˆ‡æˆæ¬Š](#authorization)ã€‚

#### 3. å»ºç«‹ä½¿ç”¨è€…æˆ–é©—è­‰ä½¿ç”¨è€…æ†‘è­‰

åœ¨é©—è­‰è¡¨å–®æ¬„ä½å¾Œï¼Œæ‚¨å¯ä»¥å»ºç«‹æ–°ä½¿ç”¨è€…å¸³æˆ¶æˆ–é€éå‘¼å«æ‚¨çš„é©—è­‰æä¾›è€… API æˆ–è³‡æ–™åº«ä¾†æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨ã€‚

å»¶çºŒå‰é¢çš„ç¯„ä¾‹ï¼š

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(state: FormState, formData: FormData) {
  // 1. é©—è­‰è¡¨å–®æ¬„ä½
  // ...

  // 2. æº–å‚™è¦æ’å…¥è³‡æ–™åº«çš„è³‡æ–™
  const { name, email, password } = validatedFields.data
  // ä¾‹å¦‚ï¼šåœ¨å„²å­˜å‰é›œæ¹Šä½¿ç”¨è€…çš„å¯†ç¢¼
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. å°‡ä½¿ç”¨è€…æ’å…¥è³‡æ–™åº«æˆ–å‘¼å«é©—è­‰å‡½å¼åº«çš„ API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'å»ºç«‹å¸³æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚',
    }
  }

  // å¾…è¾¦äº‹é …ï¼š
  // 4. å»ºç«‹ä½¿ç”¨è€…å·¥ä½œéšæ®µ
  // 5. é‡æ–°å°å‘ä½¿ç”¨è€…
}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(state, formData) {
  // 1. é©—è­‰è¡¨å–®æ¬„ä½
  // ...

  // 2. æº–å‚™è¦æ’å…¥è³‡æ–™åº«çš„è³‡æ–™
  const { name, email, password } = validatedFields.data
  // ä¾‹å¦‚ï¼šåœ¨å„²å­˜å‰é›œæ¹Šä½¿ç”¨è€…çš„å¯†ç¢¼
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. å°‡ä½¿ç”¨è€…æ’å…¥è³‡æ–™åº«æˆ–å‘¼å«å‡½å¼åº« API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'å»ºç«‹å¸³æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚',
    }
  }

  // å¾…è¾¦äº‹é …ï¼š
  // 4. å»ºç«‹ä½¿ç”¨è€…å·¥ä½œéšæ®µ
  // 5. é‡æ–°å°å‘ä½¿ç”¨è€…
}
```

æˆåŠŸå»ºç«‹ä½¿ç”¨è€…å¸³æˆ¶æˆ–é©—è­‰ä½¿ç”¨è€…æ†‘è­‰å¾Œï¼Œæ‚¨å¯ä»¥å»ºç«‹å·¥ä½œéšæ®µä¾†ç®¡ç†ä½¿ç”¨è€…çš„é©—è­‰ç‹€æ…‹ã€‚æ ¹æ“šæ‚¨çš„å·¥ä½œéšæ®µç®¡ç†ç­–ç•¥ï¼Œå·¥ä½œéšæ®µå¯ä»¥å„²å­˜åœ¨ cookie æˆ–è³‡æ–™åº«ä¸­ï¼Œæˆ–å…©è€…çš†å­˜ã€‚ç¹¼çºŒé–±è®€[å·¥ä½œéšæ®µç®¡ç†](#session-management)ç« ç¯€ä»¥äº†è§£æ›´å¤šã€‚

> **æç¤ºï¼š**
>
> - ä¸Šé¢çš„ç¯„ä¾‹è¼ƒç‚ºè©³ç´°ï¼Œå› ç‚ºå®ƒç‚ºäº†æ•™å­¸ç›®çš„åˆ†è§£äº†é©—è­‰æ­¥é©Ÿã€‚é€™çªé¡¯å‡ºå¯¦ä½œè‡ªå·±çš„å®‰å…¨è§£æ±ºæ–¹æ¡ˆå¯èƒ½å¾ˆå¿«è®Šå¾—è¤‡é›œã€‚è€ƒæ…®ä½¿ç”¨[é©—è­‰å‡½å¼åº«](#auth-libraries)ä¾†ç°¡åŒ–æµç¨‹ã€‚
> - ç‚ºäº†æ”¹å–„ä½¿ç”¨è€…é«”é©—ï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨è¨»å†Šæµç¨‹ä¸­æ›´æ—©æª¢æŸ¥é‡è¤‡çš„é›»å­éƒµä»¶æˆ–ä½¿ç”¨è€…åç¨±ã€‚ä¾‹å¦‚ï¼Œç•¶ä½¿ç”¨è€…è¼¸å…¥ä½¿ç”¨è€…åç¨±æˆ–è¼¸å…¥æ¬„ä½å¤±å»ç„¦é»æ™‚ã€‚é€™å¯ä»¥å¹«åŠ©é¿å…ä¸å¿…è¦çš„è¡¨å–®æäº¤ï¼Œä¸¦ç«‹å³å‘ä½¿ç”¨è€…æä¾›å›é¥‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨åƒ [use-debounce](https://www.npmjs.com/package/use-debounce) é€™æ¨£çš„å‡½å¼åº«ä¾†ç®¡ç†é€™äº›æª¢æŸ¥çš„é »ç‡ã€‚

</AppOnly>

<PagesOnly>

ä»¥ä¸‹æ˜¯å¯¦ä½œè¨»å†Šå’Œ/æˆ–ç™»å…¥è¡¨å–®çš„æ­¥é©Ÿï¼š

1. ä½¿ç”¨è€…é€éè¡¨å–®æäº¤ä»–å€‘çš„æ†‘è­‰ã€‚
2. è¡¨å–®ç™¼é€ä¸€å€‹ç”± API è·¯ç”±è™•ç†çš„è«‹æ±‚ã€‚
3. æˆåŠŸé©—è­‰å¾Œï¼Œæµç¨‹å®Œæˆï¼Œè¡¨ç¤ºä½¿ç”¨è€…å·²æˆåŠŸé©—è­‰ã€‚
4. å¦‚æœé©—è­‰å¤±æ•—ï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚

è€ƒæ…®ä¸€å€‹ç™»å…¥è¡¨å–®ï¼Œä½¿ç”¨è€…å¯ä»¥è¼¸å…¥ä»–å€‘çš„æ†‘è­‰ï¼š

```tsx filename="pages/login.tsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // è™•ç†éŒ¯èª¤
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å…¥</button>
    </form>
  )
}
```

```jsx filename="pages/login.jsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // è™•ç†éŒ¯èª¤
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å…¥</button>
    </form>
  )
}
```

ä¸Šé¢çš„è¡¨å–®æœ‰å…©å€‹è¼¸å…¥æ¬„ä½ï¼Œç”¨æ–¼æ•ç²ä½¿ç”¨è€…çš„é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚æäº¤æ™‚ï¼Œå®ƒæœƒè§¸ç™¼ä¸€å€‹å‡½å¼ï¼Œè©²å‡½å¼å‘ API è·¯ç”± (`/api/auth/login`) ç™¼é€ POST è«‹æ±‚ã€‚

ç„¶å¾Œï¼Œæ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­å‘¼å«æ‚¨çš„é©—è­‰æä¾›è€…çš„ API ä¾†è™•ç†é©—è­‰ï¼š

```ts filename="pages/api/auth/login.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚' })
    } else {
      res.status(500).json({ error: 'ç™¼ç”ŸéŒ¯èª¤ã€‚' })
    }
  }
}
```

```js filename="pages/api/auth/login.js" switcher
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'ç„¡æ•ˆçš„æ†‘è­‰ã€‚' })
    } else {
      res.status(500).json({ error: 'ç™¼ç”ŸéŒ¯èª¤ã€‚' })
    }
  }
}
```

</PagesOnly>

## å·¥ä½œéšæ®µç®¡ç†

å·¥ä½œéšæ®µç®¡ç†ç¢ºä¿ä½¿ç”¨è€…çš„é©—è­‰ç‹€æ…‹åœ¨è«‹æ±‚ä¹‹é–“ä¿æŒã€‚å®ƒæ¶‰åŠå»ºç«‹ã€å„²å­˜ã€åˆ·æ–°å’Œåˆªé™¤å·¥ä½œéšæ®µæˆ–ä»¤ç‰Œã€‚

æœ‰å…©ç¨®é¡å‹çš„å·¥ä½œéšæ®µï¼š

1. [**ç„¡ç‹€æ…‹ (Stateless)**](#stateless-sessions)ï¼šå·¥ä½œéšæ®µè³‡æ–™ï¼ˆæˆ–ä»¤ç‰Œï¼‰å„²å­˜åœ¨ç€è¦½å™¨çš„ cookie ä¸­ã€‚cookie éš¨æ¯å€‹è«‹æ±‚ç™¼é€ï¼Œå…è¨±åœ¨ä¼ºæœå™¨ä¸Šé©—è­‰å·¥ä½œéšæ®µã€‚é€™ç¨®æ–¹æ³•è¼ƒç°¡å–®ï¼Œä½†å¦‚æœæœªæ­£ç¢ºå¯¦ä½œï¼Œå®‰å…¨æ€§è¼ƒä½ã€‚
2. [**è³‡æ–™åº« (Database)**](#database-sessions)ï¼šå·¥ä½œéšæ®µè³‡æ–™å„²å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œä½¿ç”¨è€…çš„ç€è¦½å™¨åƒ…æ¥æ”¶åŠ å¯†çš„å·¥ä½œéšæ®µ IDã€‚é€™ç¨®æ–¹æ³•æ›´å®‰å…¨ï¼Œä½†å¯èƒ½æ›´è¤‡é›œä¸”ä½¿ç”¨æ›´å¤šä¼ºæœå™¨è³‡æºã€‚

> **é ˆçŸ¥ï¼š** é›–ç„¶æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä¸€æ–¹æ³•æˆ–å…©è€…ï¼Œä½†æˆ‘å€‘å»ºè­°ä½¿ç”¨å·¥ä½œéšæ®µç®¡ç†å‡½å¼åº«ï¼Œä¾‹å¦‚ [iron-session](https://github.com/vvo/iron-session) æˆ– [Jose](https://github.com/panva/jose)ã€‚

### ç„¡ç‹€æ…‹å·¥ä½œéšæ®µ

<AppOnly>

è¦å»ºç«‹å’Œç®¡ç†ç„¡ç‹€æ…‹å·¥ä½œéšæ®µï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥é©Ÿï¼š

1. ç”¢ç”Ÿä¸€å€‹å¯†é‘°ï¼Œç”¨æ–¼ç°½ç½²æ‚¨çš„å·¥ä½œéšæ®µï¼Œä¸¦å°‡å…¶å„²å­˜ç‚º[ç’°å¢ƒè®Šæ•¸](/docs/app/guides/environment-variables)ã€‚
2. ä½¿ç”¨å·¥ä½œéšæ®µç®¡ç†å‡½å¼åº«ç·¨å¯«åŠ å¯†/è§£å¯†å·¥ä½œéšæ®µè³‡æ–™çš„é‚è¼¯ã€‚
3. ä½¿ç”¨ Next.js [`cookies`](/docs/app/api-reference/functions/cookies) API ç®¡ç† cookieã€‚

é™¤äº†ä¸Šè¿°å…§å®¹ï¼Œè€ƒæ…®æ–°å¢åŠŸèƒ½åœ¨ä½¿ç”¨è€…è¿”å›æ‡‰ç”¨ç¨‹å¼æ™‚[æ›´æ–°ï¼ˆæˆ–åˆ·æ–°ï¼‰](#updating-or-refreshing-sessions)å·¥ä½œéšæ®µï¼Œä¸¦åœ¨ä½¿ç”¨è€…ç™»å‡ºæ™‚[åˆªé™¤](#deleting-the-session)å·¥ä½œéšæ®µã€‚

> **é ˆçŸ¥ï¼š** æª¢æŸ¥æ‚¨çš„[é©—è­‰å‡½å¼åº«](#auth-libraries)æ˜¯å¦åŒ…å«å·¥ä½œéšæ®µç®¡ç†ã€‚

#### 1. ç”¢ç”Ÿå¯†é‘°

æœ‰å¹¾ç¨®æ–¹æ³•å¯ä»¥ç”¢ç”Ÿç”¨æ–¼ç°½ç½²å·¥ä½œéšæ®µçš„å¯†é‘°ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é¸æ“‡åœ¨çµ‚ç«¯æ©Ÿä¸­ä½¿ç”¨ `openssl` å‘½ä»¤ï¼š

```bash filename="terminal"
openssl rand -base64 32
```

æ­¤å‘½ä»¤ç”¢ç”Ÿä¸€å€‹ 32 å­—å…ƒçš„éš¨æ©Ÿå­—ä¸²ï¼Œæ‚¨å¯ä»¥å°‡å…¶ç”¨ä½œå¯†é‘°ä¸¦å„²å­˜åœ¨æ‚¨çš„[ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ](/docs/app/guides/environment-variables)ä¸­ï¼š

```bash filename=".env"
SESSION_SECRET=your_secret_key
```

ç„¶å¾Œï¼Œæ‚¨å¯ä»¥åœ¨å·¥ä½œéšæ®µç®¡ç†é‚è¼¯ä¸­å¼•ç”¨æ­¤å¯†é‘°ï¼š

```js filename="app/lib/session.js"
const secretKey = process.env.SESSION_SECRET
```

#### 2. åŠ å¯†å’Œè§£å¯†å·¥ä½œéšæ®µ

æ¥ä¸‹ä¾†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨åå¥½çš„[å·¥ä½œéšæ®µç®¡ç†å‡½å¼åº«](#session-management-libraries)ä¾†åŠ å¯†å’Œè§£å¯†å·¥ä½œéšæ®µã€‚å»¶çºŒå‰é¢çš„ç¯„ä¾‹ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨ [Jose](https://www.npmjs.com/package/jose)ï¼ˆèˆ‡ [Edge Runtime](/docs/app/api-reference/edge) ç›¸å®¹ï¼‰å’Œ React çš„ [`server-only`](https://www.npmjs.com/package/server-only) å¥—ä»¶ï¼Œä»¥ç¢ºä¿æ‚¨çš„å·¥ä½œéšæ®µç®¡ç†é‚è¼¯åƒ…åœ¨ä¼ºæœå™¨ä¸ŠåŸ·è¡Œã€‚

```tsx filename="app/lib/session.ts" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'
import { SessionPayload } from '@/app/lib/definitions'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload: SessionPayload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session: string | undefined = '') {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('é©—è­‰å·¥ä½œéšæ®µå¤±æ•—')
  }
}
```

```jsx filename="app/lib/session.js" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session) {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('é©—è­‰å·¥ä½œéšæ®µå¤±æ•—')
  }
}
```

> **æç¤ºï¼š**
>
> - è² è¼‰æ‡‰åŒ…å«åœ¨å¾ŒçºŒè«‹æ±‚ä¸­ä½¿ç”¨çš„**æœ€å°‘**ã€å”¯ä¸€çš„ä½¿ç”¨è€…è³‡æ–™ï¼Œä¾‹å¦‚ä½¿ç”¨è€…çš„ IDã€è§’è‰²ç­‰ã€‚å®ƒä¸æ‡‰åŒ…å«å€‹äººè­˜åˆ¥è³‡è¨Šï¼Œå¦‚é›»è©±è™Ÿç¢¼ã€é›»å­éƒµä»¶åœ°å€ã€ä¿¡ç”¨å¡è³‡è¨Šç­‰ï¼Œæˆ–æ•æ„Ÿè³‡æ–™å¦‚å¯†ç¢¼ã€‚

#### 3. è¨­å®š cookieï¼ˆæ¨è–¦é¸é …ï¼‰

è¦å°‡å·¥ä½œéšæ®µå„²å­˜åœ¨ cookie ä¸­ï¼Œè«‹ä½¿ç”¨ Next.js [`cookies`](/docs/app/api-reference/functions/cookies) APIã€‚cookie æ‡‰åœ¨ä¼ºæœå™¨ä¸Šè¨­å®šï¼Œä¸¦åŒ…å«æ¨è–¦çš„é¸é …ï¼š

- **HttpOnly**ï¼šé˜²æ­¢å®¢æˆ¶ç«¯ JavaScript å­˜å– cookieã€‚
- **Secure**ï¼šä½¿ç”¨ https ç™¼é€ cookieã€‚
- **SameSite**ï¼šæŒ‡å®š cookie æ˜¯å¦å¯ä»¥èˆ‡è·¨ç«™è«‹æ±‚ä¸€èµ·ç™¼é€ã€‚
- **Max-Age æˆ– Expires**ï¼šåœ¨ä¸€å®šæ™‚é–“å¾Œåˆªé™¤ cookieã€‚
- **Path**ï¼šå®šç¾© cookie çš„ URL è·¯å¾‘ã€‚

è«‹åƒè€ƒ [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) ä»¥ç²å–æœ‰é—œé€™äº›é¸é …çš„æ›´å¤šè³‡è¨Šã€‚

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId: string) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })
  const cookieStore = await cookies()

  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })
  const cookieStore = await cookies()

  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

å›åˆ°æ‚¨çš„ä¼ºæœå™¨å‹•ä½œä¸­ï¼Œæ‚¨å¯ä»¥å‘¼å« `createSession()` å‡½å¼ï¼Œä¸¦ä½¿ç”¨ [`redirect()`](/docs/app/guides/redirecting) API å°‡ä½¿ç”¨è€…é‡æ–°å°å‘åˆ°é©ç•¶çš„é é¢ï¼š

```ts filename="app/actions/auth.ts" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state: FormState, formData: FormData) {
  // å…ˆå‰çš„æ­¥é©Ÿï¼š
  // 1. é©—è­‰è¡¨å–®æ¬„ä½
  // 2. æº–å‚™è¦æ’å…¥è³‡æ–™åº«çš„è³‡æ–™
  // 3. å°‡ä½¿ç”¨è€…æ’å…¥è³‡æ–™åº«æˆ–å‘¼å«å‡½å¼åº« API

  // ç›®å‰çš„æ­¥é©Ÿï¼š
  // 4. å»ºç«‹ä½¿ç”¨è€…å·¥ä½œéšæ®µ
  await createSession(user.id)
  // 5. é‡æ–°å°å‘ä½¿ç”¨è€…
  redirect('/profile')
}
```

```js filename="app/actions/auth.js" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state, formData) {
  // å…ˆå‰çš„æ­¥é©Ÿï¼š
  // 1. é©—è­‰è¡¨å–®æ¬„ä½
  // 2. æº–å‚™è¦æ’å…¥è³‡æ–™åº«çš„è³‡æ–™
  // 3. å°‡ä½¿ç”¨è€…æ’å…¥è³‡æ–™åº«æˆ–å‘¼å«å‡½å¼åº« API

  // ç›®å‰çš„æ­¥é©Ÿï¼š
  // 4. å»ºç«‹ä½¿ç”¨è€…å·¥ä½œéšæ®µ
  await createSession(user.id)
  // 5. é‡æ–°å°å‘ä½¿ç”¨è€…
  redirect('/profile')
}
```

> **æç¤ºï¼š**
>
> - **Cookie æ‡‰åœ¨ä¼ºæœå™¨ä¸Šè¨­å®š**ä»¥é˜²æ­¢å®¢æˆ¶ç«¯ç¯¡æ”¹ã€‚
> - ğŸ¥ è§€çœ‹ï¼šäº†è§£æ›´å¤šé—œæ–¼ç„¡ç‹€æ…‹å·¥ä½œéšæ®µå’Œ Next.js é©—è­‰ â†’ [YouTube (11 åˆ†é˜)](https://www.youtube.com/watch?v=DJvM2lSPn6w)ã€‚

#### æ›´æ–°ï¼ˆæˆ–åˆ·æ–°ï¼‰å·¥ä½œéšæ®µ

æ‚¨ä¹Ÿå¯ä»¥å»¶é•·å·¥ä½œéšæ®µçš„éæœŸæ™‚é–“ã€‚é€™å°æ–¼åœ¨ä½¿ç”¨è€…å†æ¬¡å­˜å–æ‡‰ç”¨ç¨‹å¼æ™‚ä¿æŒç™»å…¥ç‹€æ…‹å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼š

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)(
    await cookies()
  ).set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

> **æç¤ºï¼š** æª¢æŸ¥æ‚¨çš„é©—è­‰å‡½å¼åº«æ˜¯å¦æ”¯æ´åˆ·æ–°ä»¤ç‰Œï¼Œå¯ç”¨æ–¼å»¶é•·ä½¿ç”¨è€…çš„å·¥ä½œéšæ®µã€‚

#### åˆªé™¤å·¥ä½œéšæ®µ (Session)

è¦åˆªé™¤å·¥ä½œéšæ®µï¼Œæ‚¨å¯ä»¥åˆªé™¤ cookieï¼š

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

ç„¶å¾Œæ‚¨å¯ä»¥åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­é‡è¤‡ä½¿ç”¨ `deleteSession()` å‡½å¼ï¼Œä¾‹å¦‚åœ¨ç™»å‡ºæ™‚ï¼š

```ts filename="app/actions/auth.ts" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  await deleteSession()
  redirect('/login')
}
```

```js filename="app/actions/auth.js" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  await deleteSession()
  redirect('/login')
}
```

</AppOnly>

<PagesOnly>

#### è¨­å®šèˆ‡åˆªé™¤ cookies

æ‚¨å¯ä»¥ä½¿ç”¨ [API è·¯ç”± (API Routes)](/docs/pages/building-your-application/routing/api-routes) åœ¨ä¼ºæœå™¨ä¸Šå°‡å·¥ä½œéšæ®µè¨­å®šç‚º cookieï¼š

```ts filename="pages/api/login.ts" switcher
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'
import { encrypt } from '@/app/lib/session'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè¨­å®š cookie!' })
}
```

```js filename="pages/api/login.js" switcher
import { serialize } from 'cookie'
import { encrypt } from '@/app/lib/session'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€é€±
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè¨­å®š cookie!' })
}
```

</PagesOnly>

### è³‡æ–™åº«å·¥ä½œéšæ®µ (Database Sessions)

è¦å»ºç«‹å’Œç®¡ç†è³‡æ–™åº«å·¥ä½œéšæ®µï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥é©Ÿï¼š

1. åœ¨è³‡æ–™åº«ä¸­å»ºç«‹ä¸€å€‹è¡¨ä¾†å„²å­˜å·¥ä½œéšæ®µå’Œè³‡æ–™ï¼ˆæˆ–æª¢æŸ¥æ‚¨çš„é©—è­‰å‡½å¼åº«æ˜¯å¦è™•ç†æ­¤åŠŸèƒ½ï¼‰
2. å¯¦ä½œæ’å…¥ã€æ›´æ–°å’Œåˆªé™¤å·¥ä½œéšæ®µçš„åŠŸèƒ½
3. åœ¨å°‡å·¥ä½œéšæ®µ ID å„²å­˜åˆ°ä½¿ç”¨è€…ç€è¦½å™¨ä¹‹å‰å°å…¶é€²è¡ŒåŠ å¯†ï¼Œä¸¦ç¢ºä¿è³‡æ–™åº«å’Œ cookie ä¿æŒåŒæ­¥ï¼ˆé€™æ˜¯å¯é¸çš„ï¼Œä½†å»ºè­°ç”¨æ–¼ [ä¸­ä»‹è»Ÿé«” (Middleware)](#optimistic-checks-with-middleware-optional) ä¸­çš„æ¨‚è§€é©—è­‰æª¢æŸ¥ï¼‰

<AppOnly>

ä¾‹å¦‚ï¼š

```ts filename="app/lib/session.ts" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id: number) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. åœ¨è³‡æ–™åº«ä¸­å»ºç«‹å·¥ä½œéšæ®µ
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // è¿”å›å·¥ä½œéšæ®µ ID
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. åŠ å¯†å·¥ä½œéšæ®µ ID
  const session = await encrypt({ sessionId, expiresAt })

  // 3. å°‡å·¥ä½œéšæ®µå„²å­˜åœ¨ cookie ä¸­ä»¥é€²è¡Œæ¨‚è§€é©—è­‰æª¢æŸ¥
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. åœ¨è³‡æ–™åº«ä¸­å»ºç«‹å·¥ä½œéšæ®µ
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // è¿”å›å·¥ä½œéšæ®µ ID
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. åŠ å¯†å·¥ä½œéšæ®µ ID
  const session = await encrypt({ sessionId, expiresAt })

  // 3. å°‡å·¥ä½œéšæ®µå„²å­˜åœ¨ cookie ä¸­ä»¥é€²è¡Œæ¨‚è§€é©—è­‰æª¢æŸ¥
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

> **æç¤º**ï¼š
>
> - ç‚ºäº†æ›´å¿«å­˜å–ï¼Œæ‚¨å¯ä»¥è€ƒæ…®ç‚ºå·¥ä½œéšæ®µçš„ç”Ÿå‘½é€±æœŸæ·»åŠ ä¼ºæœå™¨å¿«å–ã€‚æ‚¨ä¹Ÿå¯ä»¥å°‡å·¥ä½œéšæ®µè³‡æ–™ä¿ç•™åœ¨ä¸»è³‡æ–™åº«ä¸­ï¼Œä¸¦åˆä½µè³‡æ–™è«‹æ±‚ä»¥æ¸›å°‘æŸ¥è©¢æ¬¡æ•¸
> - æ‚¨å¯ä»¥é¸æ“‡ä½¿ç”¨è³‡æ–™åº«å·¥ä½œéšæ®µä¾†è™•ç†æ›´é«˜ç´šçš„ä½¿ç”¨æ¡ˆä¾‹ï¼Œä¾‹å¦‚è¿½è¹¤ä½¿ç”¨è€…ä¸Šæ¬¡ç™»å…¥æ™‚é–“ã€æ´»èºè£ç½®æ•¸é‡ï¼Œæˆ–è®“ä½¿ç”¨è€…èƒ½å¤ ç™»å‡ºæ‰€æœ‰è£ç½®

å¯¦ä½œå·¥ä½œéšæ®µç®¡ç†å¾Œï¼Œæ‚¨éœ€è¦æ·»åŠ æˆæ¬Šé‚è¼¯ä¾†æ§åˆ¶ä½¿ç”¨è€…åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­çš„å­˜å–æ¬Šé™å’Œæ“ä½œã€‚ç¹¼çºŒé–±è®€ [æˆæ¬Š (Authorization)](#authorization) ç« ç¯€ä»¥äº†è§£æ›´å¤šè³‡è¨Š

</AppOnly>

<PagesOnly>

**åœ¨ä¼ºæœå™¨ä¸Šå»ºç«‹å·¥ä½œéšæ®µ**ï¼š

```ts filename="pages/api/create-session.ts" switcher
import db from '../../lib/db'
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤' })
  }
}
```

```js filename="pages/api/create-session.js" switcher
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤' })
  }
}
```

</PagesOnly>

## æˆæ¬Š (Authorization)

ç•¶ä½¿ç”¨è€…é€šéé©—è­‰ä¸¦å»ºç«‹å·¥ä½œéšæ®µå¾Œï¼Œæ‚¨å¯ä»¥å¯¦ä½œæˆæ¬Šä¾†æ§åˆ¶ä½¿ç”¨è€…åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­çš„å­˜å–æ¬Šé™å’Œæ“ä½œ

ä¸»è¦æœ‰å…©ç¨®æˆæ¬Šæª¢æŸ¥é¡å‹ï¼š

1. **æ¨‚è§€æª¢æŸ¥ (Optimistic)**ï¼šä½¿ç”¨å„²å­˜åœ¨ cookie ä¸­çš„å·¥ä½œéšæ®µè³‡æ–™æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šå­˜å–è·¯ç”±æˆ–åŸ·è¡Œæ“ä½œã€‚é€™äº›æª¢æŸ¥é©ç”¨æ–¼å¿«é€Ÿæ“ä½œï¼Œä¾‹å¦‚é¡¯ç¤º/éš±è— UI å…ƒç´ æˆ–æ ¹æ“šæ¬Šé™æˆ–è§’è‰²é‡å®šå‘ä½¿ç”¨è€…
2. **å®‰å…¨æª¢æŸ¥ (Secure)**ï¼šä½¿ç”¨å„²å­˜åœ¨è³‡æ–™åº«ä¸­çš„å·¥ä½œéšæ®µè³‡æ–™æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šå­˜å–è·¯ç”±æˆ–åŸ·è¡Œæ“ä½œã€‚é€™äº›æª¢æŸ¥æ›´å®‰å…¨ï¼Œé©ç”¨æ–¼éœ€è¦å­˜å–æ•æ„Ÿè³‡æ–™æˆ–æ“ä½œçš„æƒ…æ³

å°æ–¼é€™å…©ç¨®æƒ…æ³ï¼Œæˆ‘å€‘å»ºè­°ï¼š

- å»ºç«‹ [è³‡æ–™å­˜å–å±¤ (Data Access Layer)](#creating-a-data-access-layer-dal) ä¾†é›†ä¸­æ‚¨çš„æˆæ¬Šé‚è¼¯
- ä½¿ç”¨ [è³‡æ–™å‚³è¼¸ç‰©ä»¶ (Data Transfer Objects, DTO)](#using-data-transfer-objects-dto) åƒ…è¿”å›å¿…è¦çš„è³‡æ–™
- å¯é¸ä½¿ç”¨ [ä¸­ä»‹è»Ÿé«” (Middleware)](#optimistic-checks-with-middleware-optional) ä¾†åŸ·è¡Œæ¨‚è§€æª¢æŸ¥

### ä½¿ç”¨ä¸­ä»‹è»Ÿé«”é€²è¡Œæ¨‚è§€æª¢æŸ¥ï¼ˆå¯é¸ï¼‰

åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨ [ä¸­ä»‹è»Ÿé«” (Middleware)](/docs/app/building-your-application/routing/middleware) ä¸¦æ ¹æ“šæ¬Šé™é‡å®šå‘ä½¿ç”¨è€…ï¼š

- åŸ·è¡Œæ¨‚è§€æª¢æŸ¥ã€‚ç”±æ–¼ä¸­ä»‹è»Ÿé«”åœ¨æ¯å€‹è·¯ç”±ä¸ŠåŸ·è¡Œï¼Œé€™æ˜¯é›†ä¸­é‡å®šå‘é‚è¼¯å’Œé å…ˆéæ¿¾æœªæˆæ¬Šä½¿ç”¨è€…çš„å¥½æ–¹æ³•
- ä¿è­·åœ¨ä½¿ç”¨è€…ä¹‹é–“å…±äº«è³‡æ–™çš„éœæ…‹è·¯ç”±ï¼ˆä¾‹å¦‚ä»˜è²»ç‰†å¾Œçš„å…§å®¹ï¼‰

ç„¶è€Œï¼Œç”±æ–¼ä¸­ä»‹è»Ÿé«”åœ¨æ¯å€‹è·¯ç”±ä¸ŠåŸ·è¡Œï¼ŒåŒ…æ‹¬ [é å– (prefetched)](/docs/app/getting-started/linking-and-navigating#prefetching) è·¯ç”±ï¼Œé‡è¦çš„æ˜¯åƒ…å¾ cookie è®€å–å·¥ä½œéšæ®µï¼ˆæ¨‚è§€æª¢æŸ¥ï¼‰ï¼Œä¸¦é¿å…è³‡æ–™åº«æª¢æŸ¥ä»¥é˜²æ­¢æ•ˆèƒ½å•é¡Œ

ä¾‹å¦‚ï¼š

```tsx filename="middleware.ts" switcher
import { NextRequest, NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. æŒ‡å®šå—ä¿è­·å’Œå…¬é–‹è·¯ç”±
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req: NextRequest) {
  // 2. æª¢æŸ¥ç›®å‰è·¯ç”±æ˜¯å—ä¿è­·é‚„æ˜¯å…¬é–‹
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. å¾ cookie è§£å¯†å·¥ä½œéšæ®µ
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 4. å¦‚æœä½¿ç”¨è€…æœªé©—è­‰ï¼Œé‡å®šå‘åˆ° /login
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 5. å¦‚æœä½¿ç”¨è€…å·²é©—è­‰ï¼Œé‡å®šå‘åˆ° /dashboard
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ä¸­ä»‹è»Ÿé«”ä¸æ‡‰åŸ·è¡Œçš„è·¯ç”±
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

```js filename="middleware.js" switcher
import { NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. æŒ‡å®šå—ä¿è­·å’Œå…¬é–‹è·¯ç”±
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req) {
  // 2. æª¢æŸ¥ç›®å‰è·¯ç”±æ˜¯å—ä¿è­·é‚„æ˜¯å…¬é–‹
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. å¾ cookie è§£å¯†å·¥ä½œéšæ®µ
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 5. å¦‚æœä½¿ç”¨è€…æœªé©—è­‰ï¼Œé‡å®šå‘åˆ° /login
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 6. å¦‚æœä½¿ç”¨è€…å·²é©—è­‰ï¼Œé‡å®šå‘åˆ° /dashboard
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ä¸­ä»‹è»Ÿé«”ä¸æ‡‰åŸ·è¡Œçš„è·¯ç”±
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

é›–ç„¶ä¸­ä»‹è»Ÿé«”å°æ–¼åˆå§‹æª¢æŸ¥å¾ˆæœ‰ç”¨ï¼Œä½†å®ƒä¸æ‡‰è©²æ˜¯ä¿è­·è³‡æ–™çš„å”¯ä¸€é˜²ç·šã€‚å¤§å¤šæ•¸å®‰å…¨æª¢æŸ¥æ‡‰ç›¡å¯èƒ½é è¿‘è³‡æ–™æºåŸ·è¡Œï¼Œè«‹åƒé–± [è³‡æ–™å­˜å–å±¤ (Data Access Layer)](#creating-a-data-access-layer-dal) äº†è§£æ›´å¤šè³‡è¨Š

> **æç¤º**ï¼š
>
> - åœ¨ä¸­ä»‹è»Ÿé«”ä¸­ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `req.cookies.get('session').value` è®€å– cookies
> - ä¸­ä»‹è»Ÿé«”ä½¿ç”¨ [Edge Runtime](/docs/app/api-reference/edge)ï¼Œè«‹æª¢æŸ¥æ‚¨çš„é©—è­‰å‡½å¼åº«å’Œå·¥ä½œéšæ®µç®¡ç†å‡½å¼åº«æ˜¯å¦ç›¸å®¹
> - æ‚¨å¯ä»¥ä½¿ç”¨ä¸­ä»‹è»Ÿé«”ä¸­çš„ `matcher` å±¬æ€§ä¾†æŒ‡å®šä¸­ä»‹è»Ÿé«”æ‡‰åŸ·è¡Œçš„è·¯ç”±ã€‚å„˜ç®¡å¦‚æ­¤ï¼Œå°æ–¼é©—è­‰ï¼Œå»ºè­°ä¸­ä»‹è»Ÿé«”åœ¨æ‰€æœ‰è·¯ç”±ä¸ŠåŸ·è¡Œ

<AppOnly>

### å»ºç«‹è³‡æ–™å­˜å–å±¤ (Data Access Layer, DAL)

æˆ‘å€‘å»ºè­°å»ºç«‹ä¸€å€‹ DAL ä¾†é›†ä¸­æ‚¨çš„è³‡æ–™è«‹æ±‚å’Œæˆæ¬Šé‚è¼¯

DAL æ‡‰åŒ…å«ä¸€å€‹å‡½å¼ï¼Œåœ¨ä½¿ç”¨è€…èˆ‡æ‡‰ç”¨ç¨‹å¼äº’å‹•æ™‚é©—è­‰å…¶å·¥ä½œéšæ®µã€‚è‡³å°‘ï¼Œè©²å‡½å¼æ‡‰æª¢æŸ¥å·¥ä½œéšæ®µæ˜¯å¦æœ‰æ•ˆï¼Œç„¶å¾Œé‡å®šå‘æˆ–è¿”å›é€²è¡Œé€²ä¸€æ­¥è«‹æ±‚æ‰€éœ€çš„ç”¨æˆ¶è³‡è¨Š

ä¾‹å¦‚ï¼Œç‚ºæ‚¨çš„ DAL å»ºç«‹ä¸€å€‹å–®ç¨çš„æª”æ¡ˆï¼Œå…¶ä¸­åŒ…å« `verifySession()` å‡½å¼ã€‚ç„¶å¾Œä½¿ç”¨ React çš„ [cache](https://react.dev/reference/react/cache) API åœ¨ React æ¸²æŸ“éç¨‹ä¸­è¨˜æ†¶åŒ–å‡½å¼çš„è¿”å›å€¼ï¼š

```tsx filename="app/lib/dal.ts" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session?.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

```js filename="app/lib/dal.js" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

ç„¶å¾Œæ‚¨å¯ä»¥åœ¨è³‡æ–™è«‹æ±‚ã€ä¼ºæœå™¨æ“ä½œ (Server Actions)ã€è·¯ç”±è™•ç†ç¨‹å¼ (Route Handlers) ä¸­èª¿ç”¨ `verifySession()` å‡½å¼ï¼š

```tsx filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // æ˜ç¢ºè¿”å›æ‚¨éœ€è¦çš„æ¬„ä½ï¼Œè€Œä¸æ˜¯æ•´å€‹ä½¿ç”¨è€…ç‰©ä»¶
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('ç²å–ä½¿ç”¨è€…å¤±æ•—')
    return null
  }
})
```

```jsx filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // æ˜ç¢ºè¿”å›æ‚¨éœ€è¦çš„æ¬„ä½ï¼Œè€Œä¸æ˜¯æ•´å€‹ä½¿ç”¨è€…ç‰©ä»¶
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('ç²å–ä½¿ç”¨è€…å¤±æ•—')
    return null
  }
})
```

> **æç¤º**ï¼š
>
> - DAL å¯ç”¨æ–¼ä¿è­·åœ¨è«‹æ±‚æ™‚ç²å–çš„è³‡æ–™ã€‚ç„¶è€Œï¼Œå°æ–¼åœ¨ä½¿ç”¨è€…ä¹‹é–“å…±äº«è³‡æ–™çš„éœæ…‹è·¯ç”±ï¼Œè³‡æ–™å°‡åœ¨å»ºç½®æ™‚ç²å–ï¼Œè€Œä¸æ˜¯åœ¨è«‹æ±‚æ™‚ã€‚ä½¿ç”¨ [ä¸­ä»‹è»Ÿé«” (Middleware)](#optimistic-checks-with-middleware-optional) ä¾†ä¿è­·éœæ…‹è·¯ç”±
> - å°æ–¼å®‰å…¨æª¢æŸ¥ï¼Œæ‚¨å¯ä»¥é€šéå°‡å·¥ä½œéšæ®µ ID èˆ‡è³‡æ–™åº«é€²è¡Œæ¯”è¼ƒä¾†æª¢æŸ¥å·¥ä½œéšæ®µæ˜¯å¦æœ‰æ•ˆã€‚ä½¿ç”¨ React çš„ [cache](https://react.dev/reference/react/cache) å‡½å¼ä¾†é¿å…åœ¨æ¸²æŸ“éç¨‹ä¸­å°è³‡æ–™åº«é€²è¡Œä¸å¿…è¦çš„é‡è¤‡è«‹æ±‚
> - æ‚¨å¯èƒ½å¸Œæœ›å°‡ç›¸é—œçš„è³‡æ–™è«‹æ±‚åˆä½µåˆ°ä¸€å€‹ JavaScript é¡åˆ¥ä¸­ï¼Œè©²é¡åˆ¥åœ¨ä»»ä½•æ–¹æ³•ä¹‹å‰é‹è¡Œ `verifySession()`

### ä½¿ç”¨è³‡æ–™å‚³è¼¸ç‰©ä»¶ (DTO)

ç•¶æª¢ç´¢è³‡æ–™æ™‚ï¼Œå»ºè­°åªå›å‚³æ‡‰ç”¨ç¨‹å¼ä¸­æœƒç”¨åˆ°çš„å¿…è¦è³‡æ–™ï¼Œè€Œéæ•´å€‹ç‰©ä»¶ã€‚ä¾‹å¦‚ï¼Œç•¶ä½ ç²å–ä½¿ç”¨è€…è³‡æ–™æ™‚ï¼Œå¯èƒ½åªéœ€è¦å›å‚³ä½¿ç”¨è€…çš„ ID å’Œåç¨±ï¼Œè€Œä¸æ˜¯åŒ…å«å¯†ç¢¼ã€é›»è©±è™Ÿç¢¼ç­‰æ•æ„Ÿè³‡è¨Šçš„æ•´å€‹ä½¿ç”¨è€…ç‰©ä»¶ã€‚

ç„¶è€Œï¼Œå¦‚æœä½ ç„¡æ³•æ§åˆ¶å›å‚³çš„è³‡æ–™çµæ§‹ï¼Œæˆ–æ˜¯åœ¨åœ˜éšŠå”ä½œä¸­æƒ³é¿å…æ•´å€‹ç‰©ä»¶è¢«å‚³éåˆ°å®¢æˆ¶ç«¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›ç­–ç•¥ï¼Œä¾‹å¦‚æŒ‡å®šå“ªäº›æ¬„ä½å¯ä»¥å®‰å…¨åœ°æš´éœ²çµ¦å®¢æˆ¶ç«¯ã€‚

```tsx filename="app/lib/dto.ts" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer: User) {
  return true
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug: string) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // åœ¨é€™è£¡å›å‚³ç‰¹å®šæ¬„ä½
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // æˆ–æ˜¯åœ¨é€™è£¡åªå›å‚³æŸ¥è©¢ç‰¹å®šçš„è³‡æ–™
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

```js filename="app/lib/dto.js" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer) {
  return true
}

function canSeePhoneNumber(viewer, team) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // åœ¨é€™è£¡å›å‚³ç‰¹å®šæ¬„ä½
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // æˆ–æ˜¯åœ¨é€™è£¡åªå›å‚³æŸ¥è©¢ç‰¹å®šçš„è³‡æ–™
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

é€éå°‡è³‡æ–™è«‹æ±‚å’Œæˆæ¬Šé‚è¼¯é›†ä¸­åˆ°è³‡æ–™å­˜å–å±¤ (DAL) ä¸¦ä½¿ç”¨ DTOï¼Œä½ å¯ä»¥ç¢ºä¿æ‰€æœ‰è³‡æ–™è«‹æ±‚éƒ½æ˜¯å®‰å…¨ä¸”ä¸€è‡´çš„ï¼Œé€™ä½¿å¾—æ‡‰ç”¨ç¨‹å¼åœ¨æ“´å±•æ™‚æ›´å®¹æ˜“ç¶­è­·ã€å¯©æŸ¥å’Œé™¤éŒ¯ã€‚

> **å°çŸ¥è­˜**ï¼š
>
> - æœ‰å¹¾ç¨®ä¸åŒçš„æ–¹å¼å¯ä»¥å®šç¾© DTOï¼Œå¾ä½¿ç”¨ `toJSON()`ã€åƒä¸Šé¢ç¯„ä¾‹ä¸­çš„ç¨ç«‹å‡½å¼ï¼Œåˆ° JS é¡åˆ¥ã€‚ç”±æ–¼é€™äº›æ˜¯ JavaScript æ¨¡å¼è€Œé React æˆ– Next.js çš„åŠŸèƒ½ï¼Œæˆ‘å€‘å»ºè­°é€²è¡Œä¸€äº›ç ”ç©¶ï¼Œæ‰¾åˆ°æœ€é©åˆä½ æ‡‰ç”¨ç¨‹å¼çš„æ¨¡å¼ã€‚
> - åœ¨æˆ‘å€‘çš„ [Next.js å®‰å…¨æ€§æ–‡ç« ](/blog/security-nextjs-server-components-actions) ä¸­äº†è§£æ›´å¤šå®‰å…¨æ€§æœ€ä½³å¯¦è¸ã€‚

### ä¼ºæœå™¨å…ƒä»¶ (Server Components)

åœ¨ [ä¼ºæœå™¨å…ƒä»¶](/docs/app/getting-started/server-and-client-components) ä¸­é€²è¡Œæˆæ¬Šæª¢æŸ¥å°æ–¼åŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œæ ¹æ“šä½¿ç”¨è€…è§’è‰²æ¢ä»¶å¼æ¸²æŸ“å…ƒä»¶ï¼š

```tsx filename="app/dashboard/page.tsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session?.user?.role // å‡è¨­ 'role' æ˜¯ session ç‰©ä»¶çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session.role // å‡è¨­ 'role' æ˜¯ session ç‰©ä»¶çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

åœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ä¾†è‡ª DAL çš„ `verifySession()` å‡½å¼ä¾†æª¢æŸ¥ 'admin'ã€'user' å’Œæœªæˆæ¬Šçš„è§’è‰²ã€‚é€™ç¨®æ¨¡å¼ç¢ºä¿æ¯ä½ä½¿ç”¨è€…åªèƒ½èˆ‡å…¶è§’è‰²ç›¸ç¬¦çš„å…ƒä»¶äº’å‹•ã€‚

### ä½ˆå±€ (Layouts) èˆ‡æˆæ¬Šæª¢æŸ¥

ç”±æ–¼ [éƒ¨åˆ†æ¸²æŸ“ (Partial Rendering)](/docs/app/getting-started/linking-and-navigating#client-side-transitions)ï¼Œåœ¨ [ä½ˆå±€](/docs/app/api-reference/file-conventions/layout) ä¸­é€²è¡Œæª¢æŸ¥æ™‚è¦å°å¿ƒï¼Œå› ç‚ºé€™äº›æª¢æŸ¥ä¸æœƒåœ¨å°èˆªæ™‚é‡æ–°æ¸²æŸ“ï¼Œé€™æ„å‘³è‘—ä½¿ç”¨è€… session ä¸æœƒåœ¨æ¯æ¬¡è·¯ç”±è®Šæ›´æ™‚è¢«æª¢æŸ¥ã€‚

ç›¸ååœ°ï¼Œä½ æ‡‰è©²åœ¨è³‡æ–™ä¾†æºé™„è¿‘æˆ–å°‡è¢«æ¢ä»¶å¼æ¸²æŸ“çš„å…ƒä»¶ä¸­é€²è¡Œæª¢æŸ¥ã€‚

ä¾‹å¦‚ï¼Œè€ƒæ…®ä¸€å€‹å…±äº«ä½ˆå±€ï¼Œå®ƒç²å–ä½¿ç”¨è€…è³‡æ–™ä¸¦åœ¨å°èˆªä¸­é¡¯ç¤ºä½¿ç”¨è€…åœ–ç‰‡ã€‚èˆ‡å…¶åœ¨ä½ˆå±€ä¸­é€²è¡Œæˆæ¬Šæª¢æŸ¥ï¼Œä½ æ‡‰è©²åœ¨ä½ˆå±€ä¸­ç²å–ä½¿ç”¨è€…è³‡æ–™ (`getUser()`)ï¼Œä¸¦åœ¨ DAL ä¸­é€²è¡Œæˆæ¬Šæª¢æŸ¥ã€‚

é€™ç¢ºä¿äº†ç„¡è«–åœ¨æ‡‰ç”¨ç¨‹å¼çš„å“ªå€‹åœ°æ–¹å‘¼å« `getUser()`ï¼Œéƒ½æœƒåŸ·è¡Œæˆæ¬Šæª¢æŸ¥ï¼Œä¸¦é˜²æ­¢é–‹ç™¼è€…å¿˜è¨˜æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šå­˜å–è³‡æ–™ã€‚

```tsx filename="app/layout.tsx" switcher
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```jsx filename="app/layout.js" switcher
export default async function Layout({ children }) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```ts filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // å¾ session ä¸­ç²å–ä½¿ç”¨è€… ID ä¸¦å–å¾—è³‡æ–™
})
```

```js filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // å¾ session ä¸­ç²å–ä½¿ç”¨è€… ID ä¸¦å–å¾—è³‡æ–™
})
```

> **å°çŸ¥è­˜ï¼š**
>
> - åœ¨ SPA ä¸­ï¼Œå¸¸è¦‹çš„æ¨¡å¼æ˜¯åœ¨ä½ˆå±€æˆ–é ‚å±¤å…ƒä»¶ä¸­ `return null` å¦‚æœä½¿ç”¨è€…æœªç²æˆæ¬Šã€‚é€™ç¨®æ¨¡å¼ **ä¸æ¨è–¦** ä½¿ç”¨ï¼Œå› ç‚º Next.js æ‡‰ç”¨ç¨‹å¼æœ‰å¤šå€‹å…¥å£é»ï¼Œé€™ä¸æœƒé˜»æ­¢å·¢ç‹€è·¯ç”±å€æ®µå’Œä¼ºæœå™¨å‹•ä½œ (Server Actions) è¢«å­˜å–ã€‚

### ä¼ºæœå™¨å‹•ä½œ (Server Actions)

å°å¾… [ä¼ºæœå™¨å‹•ä½œ](/docs/app/building-your-application/data-fetching/server-actions-and-mutations) æ™‚ï¼Œæ‡‰æ¡ç”¨èˆ‡å°å¤–å…¬é–‹çš„ API ç«¯é»ç›¸åŒçš„å®‰å…¨æ€§è€ƒé‡ï¼Œä¸¦é©—è­‰ä½¿ç”¨è€…æ˜¯å¦è¢«å…è¨±åŸ·è¡Œè®Šæ›´ã€‚

åœ¨ä¸‹é¢çš„ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘åœ¨å…è¨±å‹•ä½œç¹¼çºŒä¹‹å‰æª¢æŸ¥ä½¿ç”¨è€…çš„è§’è‰²ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction(formData: FormData) {
  const session = await verifySession()
  const userRole = session?.user?.role

  // å¦‚æœä½¿ç”¨è€…æœªè¢«æˆæ¬ŠåŸ·è¡Œè©²å‹•ä½œï¼Œå‰‡æå‰å›å‚³
  if (userRole !== 'admin') {
    return null
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œå‹•ä½œ
}
```

```js filename="app/lib/actions.js" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction() {
  const session = await verifySession()
  const userRole = session.user.role

  // å¦‚æœä½¿ç”¨è€…æœªè¢«æˆæ¬ŠåŸ·è¡Œè©²å‹•ä½œï¼Œå‰‡æå‰å›å‚³
  if (userRole !== 'admin') {
    return null
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œå‹•ä½œ
}
```

### è·¯ç”±è™•ç†å™¨ (Route Handlers)

å°å¾… [è·¯ç”±è™•ç†å™¨](/docs/app/building-your-application/routing/route-handlers) æ™‚ï¼Œæ‡‰æ¡ç”¨èˆ‡å°å¤–å…¬é–‹çš„ API ç«¯é»ç›¸åŒçš„å®‰å…¨æ€§è€ƒé‡ï¼Œä¸¦é©—è­‰ä½¿ç”¨è€…æ˜¯å¦è¢«å…è¨±å­˜å–è·¯ç”±è™•ç†å™¨ã€‚

ä¾‹å¦‚ï¼š

```ts filename="app/api/route.ts" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ä½¿ç”¨è€…é©—è­‰å’Œè§’è‰²æª¢æŸ¥
  const session = await verifySession()

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²é©—è­‰
  if (!session) {
    // ä½¿ç”¨è€…æœªé©—è­‰
    return new Response(null, { status: 401 })
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    // ä½¿ç”¨è€…å·²é©—è­‰ä½†ä¸å…·å‚™æ­£ç¢ºæ¬Šé™
    return new Response(null, { status: 403 })
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œ
}
```

```js filename="app/api/route.js" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ä½¿ç”¨è€…é©—è­‰å’Œè§’è‰²æª¢æŸ¥
  const session = await verifySession()

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²é©—è­‰
  if (!session) {
    // ä½¿ç”¨è€…æœªé©—è­‰
    return new Response(null, { status: 401 })
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    // ä½¿ç”¨è€…å·²é©—è­‰ä½†ä¸å…·å‚™æ­£ç¢ºæ¬Šé™
    return new Response(null, { status: 403 })
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œ
}
```

ä¸Šé¢çš„ç¯„ä¾‹å±•ç¤ºäº†ä¸€å€‹å…·æœ‰é›™å±¤å®‰å…¨æ€§æª¢æŸ¥çš„è·¯ç”±è™•ç†å™¨ã€‚å®ƒé¦–å…ˆæª¢æŸ¥æœ‰æ•ˆçš„ sessionï¼Œç„¶å¾Œé©—è­‰ç™»å…¥çš„ä½¿ç”¨è€…æ˜¯å¦ç‚º 'admin'ã€‚

## ä¸Šä¸‹æ–‡æä¾›è€… (Context Providers)

ç”±æ–¼ [äº¤éŒ¯æ¸²æŸ“ (interleaving)](/docs/app/getting-started/server-and-client-components#examples#interleaving-server-and-client-components)ï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡æä¾›è€…é€²è¡Œé©—è­‰æ˜¯å¯è¡Œçš„ã€‚ç„¶è€Œï¼ŒReact `context` åœ¨ä¼ºæœå™¨å…ƒä»¶ä¸­ä¸å—æ”¯æ´ï¼Œå› æ­¤åƒ…é©ç”¨æ–¼å®¢æˆ¶ç«¯å…ƒä»¶ã€‚

é€™ç¨®æ–¹å¼å¯è¡Œï¼Œä½†ä»»ä½•å­ä¼ºæœå™¨å…ƒä»¶æœƒå…ˆåœ¨ä¼ºæœå™¨ç«¯æ¸²æŸ“ï¼Œä¸”ç„¡æ³•å­˜å–ä¸Šä¸‹æ–‡æä¾›è€…çš„ session è³‡æ–™ï¼š

```tsx filename="app/layout.ts" switcher
import { ContextProvider } from 'auth-lib'

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <ContextProvider>{children}</ContextProvider>
      </body>
    </html>
  )
}
```

```tsx filename="app/ui/profile.ts switcher
'use client';

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

```jsx filename="app/ui/profile.js switcher
'use client';

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

å¦‚æœå®¢æˆ¶ç«¯å…ƒä»¶éœ€è¦ session è³‡æ–™ï¼ˆä¾‹å¦‚ç”¨æ–¼å®¢æˆ¶ç«¯è³‡æ–™ç²å–ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ React çš„ [`taintUniqueValue`](https://react.dev/reference/react/experimental_taintUniqueValue) API ä¾†é˜²æ­¢æ•æ„Ÿçš„ session è³‡æ–™æš´éœ²çµ¦å®¢æˆ¶ç«¯ã€‚

</AppOnly>

<PagesOnly>

### å»ºç«‹è³‡æ–™å­˜å–å±¤ (DAL)

#### ä¿è­· API è·¯ç”±

Next.js ä¸­çš„ API è·¯ç”±å°æ–¼è™•ç†ä¼ºæœå™¨ç«¯é‚è¼¯å’Œè³‡æ–™ç®¡ç†è‡³é—œé‡è¦ã€‚ä¿è­·é€™äº›è·¯ç”±ä»¥ç¢ºä¿åªæœ‰æˆæ¬Šä½¿ç”¨è€…å¯ä»¥å­˜å–ç‰¹å®šåŠŸèƒ½æ˜¯å¿…è¦çš„ã€‚é€™é€šå¸¸æ¶‰åŠé©—è­‰ä½¿ç”¨è€…çš„é©—è­‰ç‹€æ…‹å’Œå…¶åŸºæ–¼è§’è‰²çš„æ¬Šé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€å€‹ä¿è­· API è·¯ç”±çš„ç¯„ä¾‹ï¼š

```ts filename="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²é©—è­‰
  if (!session) {
    res.status(401).json({
      error: 'ä½¿ç”¨è€…æœªé©—è­‰',
    })
    return
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ä¸å…·å‚™ç®¡ç†å“¡æ¬Šé™ã€‚',
    })
    return
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å¯¦ä½œ
}
```

```js filename="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req)

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²é©—è­‰
  if (!session) {
    res.status(401).json({
      error: 'ä½¿ç”¨è€…æœªé©—è­‰',
    })
    return
  }

  // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæˆæ¬Šå­˜å–ï¼šä½¿ç”¨è€…ä¸å…·å‚™ç®¡ç†å“¡æ¬Šé™ã€‚',
    })
    return
  }

  // ç‚ºæˆæ¬Šçš„ä½¿ç”¨è€…ç¹¼çºŒåŸ·è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å¯¦ä½œ
}
```

é€™å€‹ç¯„ä¾‹å±•ç¤ºäº†ä¸€å€‹å…·æœ‰é›™å±¤å®‰å…¨æ€§æª¢æŸ¥çš„ API è·¯ç”±ï¼Œç”¨æ–¼é©—è­‰å’Œæˆæ¬Šã€‚å®ƒé¦–å…ˆæª¢æŸ¥æœ‰æ•ˆçš„ sessionï¼Œç„¶å¾Œé©—è­‰ç™»å…¥çš„ä½¿ç”¨è€…æ˜¯å¦ç‚º 'admin'ã€‚é€™ç¨®æ–¹æ³•ç¢ºä¿äº†å®‰å…¨çš„å­˜å–ï¼Œåƒ…é™æ–¼å·²é©—è­‰å’Œæˆæ¬Šçš„ä½¿ç”¨è€…ï¼Œä¿æŒäº†è«‹æ±‚è™•ç†çš„ç©©å¥å®‰å…¨æ€§ã€‚

</PagesOnly>

## è³‡æº

ç¾åœ¨ä½ å·²ç¶“äº†è§£äº† Next.js ä¸­çš„é©—è­‰æ©Ÿåˆ¶ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›èˆ‡ Next.js ç›¸å®¹çš„å‡½å¼åº«å’Œè³‡æºï¼Œå¯å¹«åŠ©ä½ å¯¦ç¾å®‰å…¨çš„é©—è­‰å’Œ session ç®¡ç†ï¼š

### é©—è­‰å‡½å¼åº«

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Better Auth](https://www.better-auth.com/docs/integrations/next)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Logto](https://docs.logto.io/quick-starts/next-app-router)
- [NextAuth.js](https://authjs.dev/getting-started/installation?framework=next.js)
- [Ory](https://www.ory.sh/docs/getting-started/integrate-auth/nextjs)
- [Stack Auth](https://docs.stack-auth.com/getting-started/setup)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [WorkOS](https://workos.com/docs/user-management/nextjs)

### Session ç®¡ç†å‡½å¼åº«

- [Iron Session](https://github.com/vvo/iron-session)
- [Jose](https://github.com/panva/jose)

## å»¶ä¼¸é–±è®€

è¦ç¹¼çºŒå­¸ç¿’æœ‰é—œé©—è­‰å’Œå®‰å…¨æ€§çš„çŸ¥è­˜ï¼Œè«‹æŸ¥çœ‹ä»¥ä¸‹è³‡æºï¼š

- [å¦‚ä½•åœ¨ Next.js ä¸­æ€è€ƒå®‰å…¨æ€§](/blog/security-nextjs-server-components-actions)
- [ç†è§£ XSS æ”»æ“Š](https://vercel.com/guides/understanding-xss-attacks)
- [ç†è§£ CSRF æ”»æ“Š](https://vercel.com/guides/understanding-csrf-attacks)
- [The Copenhagen Book](https://thecopenhagenbook.com/)
