---
source-updated-at: 2025-05-16T04:52:11.000Z
translation-updated-at: 2025-06-02T20:00:40.190Z
title: Оптимизация использования памяти
nav_title: Использование памяти
description: Оптимизация использования памяти вашим приложением в режиме разработки и продакшена.
---

По мере роста приложений и добавления новых функций, они могут требовать больше ресурсов при локальной разработке или создании продакшен-сборок.

Рассмотрим некоторые стратегии и техники для оптимизации памяти и решения распространённых проблем с памятью в Next.js.

## Уменьшение количества зависимостей

Приложения с большим количеством зависимостей потребляют больше памяти.

[Анализатор сборки (Bundle Analyzer)](/docs/app/guides/package-bundling) поможет исследовать крупные зависимости в вашем приложении, которые можно удалить для улучшения производительности и использования памяти.

## Использование `experimental.webpackMemoryOptimizations`

Начиная с версии `v15.0.0`, вы можете добавить `experimental.webpackMemoryOptimizations: true` в файл `next.config.js`, чтобы изменить поведение Webpack для уменьшения максимального использования памяти, что может незначительно увеличить время компиляции.

> **Важно знать**: В настоящее время эта функция является экспериментальной для тестирования на большем количестве проектов, но считается низкорисковой.

## Запуск `next build` с `--experimental-debug-memory-usage`

Начиная с версии `14.2.0`, вы можете запустить `next build --experimental-debug-memory-usage` для выполнения сборки в режиме, где Next.js будет непрерывно выводить информацию об использовании памяти в процессе сборки, такую как использование кучи и статистику сборки мусора. Снимки кучи также будут автоматически создаваться при приближении использования памяти к установленному лимиту.

> **Важно знать**: Эта функция несовместима с опцией Webpack build worker, которая автоматически включается, если у вас нет пользовательской конфигурации Webpack.

## Запись профиля кучи

Для поиска проблем с памятью вы можете записать профиль кучи из Node.js и загрузить его в Chrome DevTools для выявления потенциальных источников утечек памяти.

В терминале передайте флаг `--heap-prof` в Node.js при запуске сборки Next.js:

```sh
node --heap-prof node_modules/next/dist/bin/next build
```

По завершении сборки Node.js создаст файл `.heapprofile`.

В Chrome DevTools вы можете открыть вкладку "Memory" и нажать кнопку "Load Profile" для визуализации файла.

## Анализ снимка кучи

Вы можете использовать инструмент инспектора для анализа использования памяти приложением.

При запуске команды `next build` или `next dev` добавьте `NODE_OPTIONS=--inspect` в начало команды. Это откроет агент инспектора на стандартном порту.
Если вы хотите остановить выполнение до запуска пользовательского кода, можно передать `--inspect-brk`. Во время работы процесса вы можете использовать инструмент, например Chrome DevTools, для подключения к порту отладки, записи и анализа снимка кучи, чтобы увидеть, какая память удерживается.

Начиная с версии `14.2.0`, вы также можете запустить `next build` с флагом `--experimental-debug-memory-usage` для упрощения создания снимков кучи.

При работе в этом режиме вы можете отправить сигнал `SIGUSR2` процессу в любой момент, и процесс создаст снимок кучи.

Снимок кучи будет сохранён в корне проекта Next.js и может быть загружен в любой анализатор кучи, например Chrome DevTools, для просмотра удерживаемой памяти. Этот режим пока несовместим с Webpack build workers.

Подробнее см. [как записывать и анализировать снимки кучи](https://developer.chrome.com/docs/devtools/memory-problems/heap-snapshots).

## Webpack build worker

Webpack build worker позволяет запускать компиляции Webpack в отдельном Node.js worker, что уменьшает использование памяти вашим приложением во время сборок.

Эта опция включена по умолчанию, начиная с версии `v14.1.0`, если ваше приложение не имеет пользовательской конфигурации Webpack.

Если вы используете более старую версию Next.js или у вас есть пользовательская конфигурация Webpack, вы можете включить эту опцию, установив `experimental.webpackBuildWorker: true` в вашем `next.config.js`.

> **Важно знать**: Эта функция может быть несовместима со всеми пользовательскими Webpack-плагинами.

## Отключение кэша Webpack

[Кэш Webpack](https://webpack.js.org/configuration/cache/) сохраняет сгенерированные Webpack-модули в памяти и/или на диске для ускорения сборок. Это может
улучшить производительность, но также увеличит использование памяти вашим приложением для хранения кэшированных данных.

Вы можете отключить это поведение, добавив [пользовательскую конфигурацию Webpack](/docs/app/api-reference/config/next-config-js/webpack) в ваше приложение:

```js filename="next.config.mjs"
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (
    config,
    { buildId, dev, isServer, defaultLoaders, nextRuntime, webpack }
  ) => {
    if (config.cache && !dev) {
      config.cache = Object.freeze({
        type: 'memory',
      })
    }
    // Важно: вернуть изменённую конфигурацию
    return config
  },
}

export default nextConfig
```

## Отключение статического анализа

Проверка типов и линтинг могут требовать много памяти, особенно в крупных проектах.
Однако большинство проектов имеют выделенный CI-раннер, который уже выполняет эти задачи.
Если сборка вызывает проблемы с нехваткой памяти на этапе "Linting and checking validity of types", вы можете отключить эти задачи во время сборок:

```js filename="next.config.mjs"
/** @type {import('next').NextConfig} */
const nextConfig = {
  eslint: {
    // Предупреждение: Это позволяет успешно завершать продакшен-сборки,
    // даже если в вашем проекте есть ошибки ESLint.
    ignoreDuringBuilds: true,
  },
  typescript: {
    // !! ВНИМАНИЕ !!
    // Опасная опция: позволяет успешно завершать продакшен-сборки,
    // даже если в вашем проекте есть ошибки типов.
    // !! ВНИМАНИЕ !!
    ignoreBuildErrors: true,
  },
}

export default nextConfig
```

- [Игнорирование ошибок TypeScript](/docs/app/api-reference/config/typescript#disabling-typescript-errors-in-production)
- [ESLint в конфигурации Next.js](/docs/pages/api-reference/config/next-config-js/eslint)

Учтите, что это может привести к ошибочным деплоям из-за ошибок типов или линтинга.
Мы настоятельно рекомендуем продвигать сборки в продакшен только после завершения статического анализа.
Если вы деплоите на Vercel, ознакомьтесь с [руководством по промежуточным деплоям](https://vercel.com/docs/deployments/managing-deployments#staging-and-promoting-a-production-deployment), чтобы узнать, как продвигать сборки в продакшен после успешного выполнения пользовательских задач.

## Отключение source maps

Генерация source maps потребляет дополнительную память во время процесса сборки.

Вы можете отключить генерацию source maps, добавив `productionBrowserSourceMaps: false` и `experimental.serverSourceMaps: false` в конфигурацию Next.js.

> **Важно знать**: Некоторые плагины могут включать source maps и могут требовать пользовательской конфигурации для отключения.

## Проблемы с памятью в Edge

В Next.js `v14.1.3` исправлена проблема с памятью при использовании Edge runtime. Пожалуйста, обновитесь до этой версии (или новее), чтобы проверить, решает ли она вашу проблему.