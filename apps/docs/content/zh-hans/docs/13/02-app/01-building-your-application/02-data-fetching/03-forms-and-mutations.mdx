---
source-updated-at: 2025-05-16T04:52:11.000Z
translation-updated-at: 2025-05-21T21:08:02.600Z
title: è¡¨å•ä¸æ•°æ®å˜æ›´
nav_title: è¡¨å•ä¸æ•°æ®å˜æ›´
description: å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Next.js å¤„ç†è¡¨å•æäº¤ä¸æ•°æ®å˜æ›´ã€‚
---

{/* æœ¬æ–‡æ¡£å†…å®¹åœ¨åº”ç”¨è·¯ç”±å’Œé¡µé¢è·¯ç”±é—´å…±äº«ã€‚å¯ä½¿ç”¨ `<PagesOnly>å†…å®¹</PagesOnly>` ç»„ä»¶æ·»åŠ é¡µé¢è·¯ç”±ä¸“å±å†…å®¹ï¼Œå…±äº«å†…å®¹ä¸åº”åŒ…è£¹åœ¨ä»»ä½•ç»„ä»¶ä¸­ */}

<PagesOnly>

è¡¨å•è®©æ‚¨èƒ½å¤Ÿåœ¨ç½‘é¡µåº”ç”¨ä¸­åˆ›å»ºå’Œæ›´æ–°æ•°æ®ã€‚Next.js é€šè¿‡ **API è·¯ç”±** æä¾›äº†å¼ºå¤§çš„è¡¨å•æäº¤ä¸æ•°æ®å˜æ›´å¤„ç†æ–¹æ¡ˆã€‚

> **é¡»çŸ¥ï¼š**
>
> - æˆ‘ä»¬å³å°†æ¨è [æ¸è¿›å¼è¿ç§»](/docs/app/building-your-application/upgrading/app-router-migration) åˆ°åº”ç”¨è·¯ç”±ï¼Œå¹¶ä½¿ç”¨ [æœåŠ¡ç«¯æ“ä½œ (Server Actions)](/docs/app/building-your-application/data-fetching/forms-and-mutations#how-server-actions-work) å¤„ç†è¡¨å•æäº¤ä¸æ•°æ®å˜æ›´ã€‚æœåŠ¡ç«¯æ“ä½œå…è®¸æ‚¨å®šä¹‰å¼‚æ­¥æœåŠ¡ç«¯å‡½æ•°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º API è·¯ç”±å³å¯ç›´æ¥ä»ç»„ä»¶è°ƒç”¨ã€‚
> - API è·¯ç”± [é»˜è®¤ä¸æŒ‡å®š CORS å¤´ä¿¡æ¯](https://developer.mozilla.org/docs/Web/HTTP/CORS)ï¼Œæ„å‘³ç€é»˜è®¤ä»…æ”¯æŒåŒæºè¯·æ±‚ã€‚
> - ç”±äº API è·¯ç”±åœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œå¯é€šè¿‡ [ç¯å¢ƒå˜é‡](/docs/pages/building-your-application/configuring/environment-variables) ä½¿ç”¨æ•æ„Ÿå€¼ï¼ˆå¦‚ API å¯†é’¥ï¼‰è€Œä¸ä¼šæš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œè¿™å¯¹åº”ç”¨å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚

</PagesOnly>

<AppOnly>

è¡¨å•è®©æ‚¨èƒ½å¤Ÿåœ¨ç½‘é¡µåº”ç”¨ä¸­åˆ›å»ºå’Œæ›´æ–°æ•°æ®ã€‚Next.js é€šè¿‡ **æœåŠ¡ç«¯æ“ä½œ (Server Actions)** æä¾›äº†å¼ºå¤§çš„è¡¨å•æäº¤ä¸æ•°æ®å˜æ›´å¤„ç†æ–¹æ¡ˆã€‚

<details>
  <summary>ç¤ºä¾‹</summary>

- [å¸¦åŠ è½½ä¸é”™è¯¯çŠ¶æ€çš„è¡¨å•](https://github.com/vercel/next.js/tree/canary/examples/next-forms)

</details>

## æœåŠ¡ç«¯æ“ä½œåŸç†

ä½¿ç”¨æœåŠ¡ç«¯æ“ä½œæ—¶ï¼Œæ‚¨æ— éœ€æ‰‹åŠ¨åˆ›å»º API ç«¯ç‚¹ï¼Œè€Œæ˜¯ç›´æ¥å®šä¹‰å¯åœ¨ç»„ä»¶ä¸­è°ƒç”¨çš„å¼‚æ­¥æœåŠ¡ç«¯å‡½æ•°ã€‚

> **ğŸ¥ è§‚çœ‹ï¼š** é€šè¿‡åº”ç”¨è·¯ç”±å­¦ä¹ è¡¨å•ä¸æ•°æ®å˜æ›´ â†’ [YouTube (10åˆ†é’Ÿ)](https://youtu.be/dDpZfOQBMaU?si=cJZHlUu_jFhCzHUg)ã€‚

æœåŠ¡ç«¯æ“ä½œå¯åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­å®šä¹‰ï¼Œæˆ–ä»å®¢æˆ·ç«¯ç»„ä»¶è°ƒç”¨ã€‚åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­å®šä¹‰æ“ä½œå¯ä½¿è¡¨å•åœ¨æ—  JavaScript ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œï¼Œå®ç°æ¸è¿›å¢å¼ºã€‚

åœ¨ `next.config.js` ä¸­å¯ç”¨æœåŠ¡ç«¯æ“ä½œï¼š

```js filename="next.config.js"
module.exports = {
  experimental: {
    serverActions: true,
  },
}
```

> **é¡»çŸ¥ï¼š**
>
> - ä»æœåŠ¡ç«¯ç»„ä»¶è°ƒç”¨æœåŠ¡ç«¯æ“ä½œçš„è¡¨å•å¯åœ¨æ—  JavaScript ç¯å¢ƒä¸‹è¿è¡Œã€‚
> - ä»å®¢æˆ·ç«¯ç»„ä»¶è°ƒç”¨æœåŠ¡ç«¯æ“ä½œçš„è¡¨å•ä¼šåœ¨ JavaScript æœªåŠ è½½æ—¶æ’é˜Ÿæäº¤ï¼Œä¼˜å…ˆä¿è¯å®¢æˆ·ç«¯æ°´åˆã€‚
> - æœåŠ¡ç«¯æ“ä½œç»§æ‰¿æ‰€åœ¨é¡µé¢æˆ–å¸ƒå±€çš„ [è¿è¡Œæ—¶ç¯å¢ƒ](/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes)ã€‚
> - æœåŠ¡ç«¯æ“ä½œå…¼å®¹å®Œå…¨é™æ€çš„è·¯ç”±ï¼ˆåŒ…æ‹¬ä½¿ç”¨ ISR é‡æ–°éªŒè¯æ•°æ®ï¼‰ã€‚

## é‡æ–°éªŒè¯ç¼“å­˜æ•°æ®

æœåŠ¡ç«¯æ“ä½œä¸ Next.js [ç¼“å­˜ä¸é‡æ–°éªŒè¯](/docs/app/building-your-application/caching) æ¶æ„æ·±åº¦é›†æˆã€‚è¡¨å•æäº¤æ—¶ï¼ŒæœåŠ¡ç«¯æ“ä½œå¯æ›´æ–°ç¼“å­˜æ•°æ®å¹¶é‡æ–°éªŒè¯åº”å˜æ›´çš„ç¼“å­˜é”®ã€‚

ä¸åŒäºä¼ ç»Ÿåº”ç”¨æ¯ä¸ªè·¯ç”±åªèƒ½æœ‰ä¸€ä¸ªè¡¨å•ï¼ŒæœåŠ¡ç«¯æ“ä½œæ”¯æŒæ¯ä¸ªè·¯ç”±å¤šä¸ªæ“ä½œã€‚æ­¤å¤–ï¼Œè¡¨å•æäº¤æ—¶æµè§ˆå™¨æ— éœ€åˆ·æ–°ã€‚åœ¨å•æ¬¡ç½‘ç»œå¾€è¿”ä¸­ï¼ŒNext.js å¯åŒæ—¶è¿”å›æ›´æ–°åçš„ UI å’Œåˆ·æ–°æ•°æ®ã€‚

æŸ¥çœ‹ä¸‹æ–¹ [é€šè¿‡æœåŠ¡ç«¯æ“ä½œé‡æ–°éªŒè¯æ•°æ®](#revalidating-data) çš„ç¤ºä¾‹ã€‚

</AppOnly>

## ç¤ºä¾‹

### çº¯æœåŠ¡ç«¯è¡¨å•

<PagesOnly>

ä½¿ç”¨é¡µé¢è·¯ç”±æ—¶ï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨åˆ›å»º API ç«¯ç‚¹æ¥å®‰å…¨åœ°åœ¨æœåŠ¡ç«¯å˜æ›´æ•°æ®ã€‚

```ts filename="pages/api/submit.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const data = req.body
  const id = await createItem(data)
  res.status(200).json({ id })
}
```

```js filename="pages/api/submit.js" switcher
export default function handler(req, res) {
  const data = req.body
  const id = await createItem(data)
  res.status(200).json({ id })
}
```

ç„¶åé€šè¿‡äº‹ä»¶å¤„ç†å™¨åœ¨å®¢æˆ·ç«¯è°ƒç”¨ API è·¯ç”±ï¼š

```tsx filename="pages/index.tsx" switcher
import { FormEvent } from 'react'

export default function Page() {
  async function onSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const response = await fetch('/api/submit', {
      method: 'POST',
      body: formData,
    })

    // å¦‚éœ€å¤„ç†å“åº”
    const data = await response.json()
    // ...
  }

  return (
    <form onSubmit={onSubmit}>
      <input type="text" name="name" />
      <button type="submit">æäº¤</button>
    </form>
  )
}
```

```jsx filename="pages/index.jsx" switcher
export default function Page() {
  async function onSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.target)
    const response = await fetch('/api/submit', {
      method: 'POST',
      body: formData,
    })

    // å¦‚éœ€å¤„ç†å“åº”
    const data = await response.json()
    // ...
  }

  return (
    <form onSubmit={onSubmit}>
      <input type="text" name="name" />
      <button type="submit">æäº¤</button>
    </form>
  )
}
```

</PagesOnly>

<AppOnly>

è¦åˆ›å»ºçº¯æœåŠ¡ç«¯è¡¨å•ï¼Œéœ€åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­å®šä¹‰æœåŠ¡ç«¯æ“ä½œã€‚æ“ä½œå¯å†…è”å®šä¹‰ï¼ˆåœ¨å‡½æ•°é¡¶éƒ¨æ·»åŠ  `"use server"` æŒ‡ä»¤ï¼‰ï¼Œæˆ–åœ¨å•ç‹¬æ–‡ä»¶ä¸­å®šä¹‰ï¼ˆæ–‡ä»¶é¡¶éƒ¨æ·»åŠ æŒ‡ä»¤ï¼‰ã€‚

```tsx filename="app/page.tsx" switcher
export default function Page() {
  async function create(formData: FormData) {
    'use server'

    // å˜æ›´æ•°æ®
    // é‡æ–°éªŒè¯ç¼“å­˜
  }

  return <form action={create}>...</form>
}
```

```jsx filename="app/page.jsx" switcher
export default function Page() {
  async function create(formData) {
    'use server'

    // å˜æ›´æ•°æ®
    // é‡æ–°éªŒè¯ç¼“å­˜
  }

  return <form action={create}>...</form>
}
```

> **é¡»çŸ¥**ï¼š`<form action={create}>` æ¥æ”¶ [FormData](https://developer.mozilla.org/docs/Web/API/FormData/FormData) æ•°æ®ç±»å‹ã€‚ä¸Šä¾‹ä¸­é€šè¿‡ HTML [`form`](https://developer.mozilla.org/docs/Web/HTML/Element/form) æäº¤çš„ FormData å¯åœ¨æœåŠ¡ç«¯æ“ä½œ `create` ä¸­è®¿é—®ã€‚

### é‡æ–°éªŒè¯æ•°æ®

æœåŠ¡ç«¯æ“ä½œå…è®¸æ‚¨æŒ‰éœ€ä½¿ [Next.js ç¼“å­˜](/docs/app/building-your-application/caching) å¤±æ•ˆã€‚æ‚¨å¯ä»¥ä½¿ç”¨ [`revalidatePath`](/docs/app/api-reference/functions/revalidatePath) ä½¿æ•´ä¸ªè·¯ç”±æ®µå¤±æ•ˆï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { revalidatePath } from 'next/cache'

export default async function submit() {
  await submitForm()
  revalidatePath('/')
}
```

```js filename="app/actions.js" switcher
'use server'

import { revalidatePath } from 'next/cache'

export default async function submit() {
  await submitForm()
  revalidatePath('/')
}
```

æˆ–ä½¿ç”¨ [`revalidateTag`](/docs/app/api-reference/functions/revalidateTag) é€šè¿‡ç¼“å­˜æ ‡ç­¾ä½¿ç‰¹å®šæ•°æ®è·å–å¤±æ•ˆï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { revalidateTag } from 'next/cache'

export default async function submit() {
  await addPost()
  revalidateTag('posts')
}
```

```js filename="app/actions.js" switcher
'use server'

import { revalidateTag } from 'next/cache'

export default async function submit() {
  await addPost()
  revalidateTag('posts')
}
```

</AppOnly>

### é‡å®šå‘

<PagesOnly>

è‹¥è¦åœ¨æ•°æ®å˜æ›´åé‡å®šå‘ç”¨æˆ·ï¼Œå¯ä½¿ç”¨ [`redirect`](/docs/pages/building-your-application/routing/api-routes#response-helpers) è·³è½¬åˆ°ä»»æ„ç»å¯¹æˆ–ç›¸å¯¹ URLï¼š

```ts filename="pages/api/submit.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const id = await addPost()
  res.redirect(307, `/post/${id}`)
}
```

```js filename="pages/api/submit.js" switcher
export default async function handler(req, res) {
  const id = await addPost()
  res.redirect(307, `/post/${id}`)
}
```

</PagesOnly>

<AppOnly>

è‹¥è¦åœ¨æœåŠ¡ç«¯æ“ä½œå®Œæˆåé‡å®šå‘ç”¨æˆ·ï¼Œå¯ä½¿ç”¨ [`redirect`](/docs/app/api-reference/functions/redirect) è·³è½¬åˆ°ä»»æ„ç»å¯¹æˆ–ç›¸å¯¹ URLï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { redirect } from 'next/navigation'
import { revalidateTag } from 'next/cache'

export default async function submit() {
  const id = await addPost()
  revalidateTag('posts') // æ›´æ–°ç¼“å­˜æ–‡ç« 
  redirect(`/post/${id}`) // å¯¼èˆªåˆ°æ–°è·¯ç”±
}
```

```js filename="app/actions.js" switcher
'use server'

import { redirect } from 'next/navigation'
import { revalidateTag } from 'next/cache'

export default async function submit() {
  const id = await addPost()
  revalidateTag('posts') // æ›´æ–°ç¼“å­˜æ–‡ç« 
  redirect(`/post/${id}`) // å¯¼èˆªåˆ°æ–°è·¯ç”±
}
```

</AppOnly>

### è¡¨å•éªŒè¯

æ¨èä½¿ç”¨ `required` å’Œ `type="email"` ç­‰ HTML éªŒè¯è¿›è¡ŒåŸºç¡€è¡¨å•éªŒè¯ã€‚

å¦‚éœ€é«˜çº§æœåŠ¡ç«¯éªŒè¯ï¼Œå¯ä½¿ç”¨ [zod](https://zod.dev/) ç­‰æ¨¡å¼éªŒè¯åº“éªŒè¯è§£æåçš„è¡¨å•æ•°æ®ç»“æ„ï¼š

<PagesOnly>

```ts filename="pages/api/submit.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'
import { z } from 'zod'

const schema = z.object({
  // ...
})

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const parsed = schema.parse(req.body)
  // ...
}
```

```js filename="pages/api/submit.js" switcher
import { z } from 'zod'

const schema = z.object({
  // ...
})

export default async function handler(req, res) {
  const parsed = schema.parse(req.body)
  // ...
}
```

</PagesOnly>

<AppOnly>

```tsx filename="app/actions.ts" switcher
import { z } from 'zod'

const schema = z.object({
  // ...
})

export default async function submit(formData: FormData) {
  const parsed = schema.parse({
    id: formData.get('id'),
  })
  // ...
}
```

```jsx filename="app/actions.js" switcher
import { z } from 'zod'

const schema = z.object({
  // ...
})

export default async function submit(formData) {
  const parsed = schema.parse({
    id: formData.get('id'),
  })
  // ...
}
```

</AppOnly>

### æ˜¾ç¤ºåŠ è½½çŠ¶æ€

<AppOnly>

ä½¿ç”¨ `useFormStatus` é’©å­æ˜¾ç¤ºè¡¨å•åœ¨æœåŠ¡ç«¯æäº¤æ—¶çš„åŠ è½½çŠ¶æ€ã€‚è¯¥é’©å­åªèƒ½ä½œä¸ºä½¿ç”¨æœåŠ¡ç«¯æ“ä½œçš„ `form` å…ƒç´ çš„å­ç»„ä»¶ä½¿ç”¨ã€‚

ä¾‹å¦‚ä»¥ä¸‹æäº¤æŒ‰é’®ï¼š

```tsx filename="app/submit-button.tsx" switcher
'use client'

import { experimental_useFormStatus as useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      æ·»åŠ 
    </button>
  )
}
```

```jsx filename="app/submit-button.jsx" switcher
'use client'

import { experimental_useFormStatus as useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      æ·»åŠ 
    </button>
  )
}
```

`<SubmitButton />` å¯åœ¨åŒ…å«æœåŠ¡ç«¯æ“ä½œçš„è¡¨å•ä¸­ä½¿ç”¨ï¼š

```tsx filename="app/page.tsx" switcher
import { SubmitButton } from '@/app/submit-button'

export default async function Home() {
  return (
    <form action={...}>
      <input type="text" name="field-name" />
      <SubmitButton />
    </form>
  )
}
```

```jsx filename="app/page.jsx" switcher
import { SubmitButton } from '@/app/submit-button'

export default async function Home() {
  return (
    <form action={...}>
      <input type="text" name="field-name" />
      <SubmitButton />
    </form>
  )
}
```

</AppOnly>

<PagesOnly>

å¯ä½¿ç”¨ React çŠ¶æ€æ˜¾ç¤ºè¡¨å•åœ¨æœåŠ¡ç«¯æäº¤æ—¶çš„åŠ è½½çŠ¶æ€ï¼š

```tsx filename="pages/index.tsx" switcher
import React, { useState, FormEvent } from 'react'

export default function Page() {
  const [isLoading, setIsLoading] = useState<boolean>(false)

  async function onSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()
    setIsLoading(true) // è¯·æ±‚å¼€å§‹æ—¶è®¾ç½®åŠ è½½çŠ¶æ€

    try {
      const formData = new FormData(event.currentTarget)
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: formData,
      })

      // å¦‚éœ€å¤„ç†å“åº”
      const data = await response.json()
      // ...
    } catch (error) {
      // å¦‚éœ€å¤„ç†é”™è¯¯
      console.error(error)
    } finally {
      setIsLoading(false) // è¯·æ±‚å®Œæˆåå–æ¶ˆåŠ è½½çŠ¶æ€
    }
  }

  return (
    <form onSubmit={onSubmit}>
      <input type="text" name="name" />
      <button type="submit" disabled={isLoading}>
        {isLoading ? 'æäº¤ä¸­...' : 'æäº¤'}
      </button>
    </form>
  )
}
```

```jsx filename="pages/index.jsx" switcher
import React, { useState } from 'react'

export default function Page() {
  const [isLoading, setIsLoading] = useState(false)

  async function onSubmit(event) {
    event.preventDefault()
    setIsLoading(true) // è¯·æ±‚å¼€å§‹æ—¶è®¾ç½®åŠ è½½çŠ¶æ€

    try {
      const formData = new FormData(event.currentTarget)
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: formData,
      })

      // å¦‚éœ€å¤„ç†å“åº”
      const data = await response.json()
      // ...
    } catch (error) {
      // å¦‚éœ€å¤„ç†é”™è¯¯
      console.error(error)
    } finally {
      setIsLoading(false) // è¯·æ±‚å®Œæˆåå–æ¶ˆåŠ è½½çŠ¶æ€
    }
  }

  return (
    <form onSubmit={onSubmit}>
      <input type="text" name="name" />
      <button type="submit" disabled={isLoading}>
        {isLoading ? 'æäº¤ä¸­...' : 'æäº¤'}
      </button>
    </form>
  )
}
```

</PagesOnly>

### é”™è¯¯å¤„ç†

<AppOnly>

æœåŠ¡ç«¯æ“ä½œ (Server Actions) ä¹Ÿå¯ä»¥è¿”å›[å¯åºåˆ—åŒ–å¯¹è±¡](https://developer.mozilla.org/docs/Glossary/Serialization)ã€‚ä¾‹å¦‚ï¼Œæ‚¨çš„æœåŠ¡ç«¯æ“ä½œå¯ä»¥å¤„ç†åˆ›å»ºæ–°é¡¹ç›®æ—¶çš„é”™è¯¯ï¼š

```ts filename="app/actions.ts" switcher
'use server'

export async function createTodo(prevState: any, formData: FormData) {
  try {
    await createItem(formData.get('todo'))
    return revalidatePath('/')
  } catch (e) {
    return { message: 'Failed to create' }
  }
}
```

```js filename="app/actions.js" switcher
'use server'

export async function createTodo(prevState, formData) {
  try {
    await createItem(formData.get('todo'))
    return revalidatePath('/')
  } catch (e) {
    return { message: 'Failed to create' }
  }
}
```

ç„¶åï¼Œåœ¨å®¢æˆ·ç«¯ç»„ä»¶ (Client Component) ä¸­ï¼Œæ‚¨å¯ä»¥è¯»å–è¿™ä¸ªå€¼å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

```tsx filename="app/add-form.tsx" switcher
'use client'

import { experimental_useFormState as useFormState } from 'react-dom'
import { experimental_useFormStatus as useFormStatus } from 'react-dom'
import { createTodo } from '@/app/actions'

const initialState = {
  message: null,
}

function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      Add
    </button>
  )
}

export function AddForm() {
  const [state, formAction] = useFormState(createTodo, initialState)

  return (
    <form action={formAction}>
      <label htmlFor="todo">Enter Task</label>
      <input type="text" id="todo" name="todo" required />
      <SubmitButton />
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
    </form>
  )
}
```

```jsx filename="app/add-form.jsx" switcher
'use client'

import { experimental_useFormState as useFormState } from 'react-dom'
import { experimental_useFormStatus as useFormStatus } from 'react-dom'
import { createTodo } from '@/app/actions'

const initialState = {
  message: null,
}

function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      Add
    </button>
  )
}

export function AddForm() {
  const [state, formAction] = useFormState(createTodo, initialState)

  return (
    <form action={formAction}>
      <label htmlFor="todo">Enter Task</label>
      <input type="text" id="todo" name="todo" required />
      <SubmitButton />
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
    </form>
  )
}
```

</AppOnly>

<PagesOnly>

æ‚¨å¯ä»¥ä½¿ç”¨ React çŠ¶æ€åœ¨è¡¨å•æäº¤å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š

```tsx filename="pages/index.tsx" switcher
import React, { useState, FormEvent } from 'react'

export default function Page() {
  const [isLoading, setIsLoading] = useState<boolean>(false)
  const [error, setError] = useState<string | null>(null)

  async function onSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()
    setIsLoading(true)
    setError(null) // æ–°è¯·æ±‚å¼€å§‹æ—¶æ¸…é™¤ä¹‹å‰çš„é”™è¯¯

    try {
      const formData = new FormData(event.currentTarget)
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: formData,
      })

      if (!response.ok) {
        throw new Error('Failed to submit the data. Please try again.')
      }

      // å¦‚æœ‰éœ€è¦å¤„ç†å“åº”
      const data = await response.json()
      // ...
    } catch (error) {
      // æ•è·é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºç»™ç”¨æˆ·
      setError(error.message)
      console.error(error)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div>
      {error && <div style={{ color: 'red' }}>{error}</div>}
      <form onSubmit={onSubmit}>
        <input type="text" name="name" />
        <button type="submit" disabled={isLoading}>
          {isLoading ? 'åŠ è½½ä¸­...' : 'æäº¤'}
        </button>
      </form>
    </div>
  )
}
```

```jsx filename="pages/index.jsx" switcher
import React, { useState } from 'react'

export default function Page() {
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState(null)

  async function onSubmit(event) {
    event.preventDefault()
    setIsLoading(true)
    setError(null) // æ–°è¯·æ±‚å¼€å§‹æ—¶æ¸…é™¤ä¹‹å‰çš„é”™è¯¯

    try {
      const formData = new FormData(event.currentTarget)
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: formData,
      })

      if (!response.ok) {
        throw new Error('Failed to submit the data. Please try again.')
      }

      // å¦‚æœ‰éœ€è¦å¤„ç†å“åº”
      const data = await response.json()
      // ...
    } catch (error) {
      // æ•è·é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºç»™ç”¨æˆ·
      setError(error.message)
      console.error(error)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div>
      {error && <div style={{ color: 'red' }}>{error}</div>}
      <form onSubmit={onSubmit}>
        <input type="text" name="name" />
        <button type="submit" disabled={isLoading}>
          {isLoading ? 'åŠ è½½ä¸­...' : 'æäº¤'}
        </button>
      </form>
    </div>
  )
}
```

</PagesOnly>

<AppOnly>

### ä¹è§‚æ›´æ–° (Optimistic Updates)

ä½¿ç”¨ `useOptimistic` åœ¨æœåŠ¡ç«¯æ“ä½œå®Œæˆå‰ä¹è§‚åœ°æ›´æ–° UIï¼Œè€Œæ— éœ€ç­‰å¾…å“åº”ï¼š

```tsx filename="app/page.tsx" switcher
'use client'

import { experimental_useOptimistic as useOptimistic } from 'react'
import { send } from './actions'

type Message = {
  message: string
}

export function Thread({ messages }: { messages: Message[] }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic<Message[]>(
    messages,
    (state: Message[], newMessage: string) => [
      ...state,
      { message: newMessage },
    ]
  )

  return (
    <div>
      {optimisticMessages.map((m, k) => (
        <div key={k}>{m.message}</div>
      ))}
      <form
        action={async (formData: FormData) => {
          const message = formData.get('message')
          addOptimisticMessage(message)
          await send(message)
        }}
      >
        <input type="text" name="message" />
        <button type="submit">å‘é€</button>
      </form>
    </div>
  )
}
```

```jsx filename="app/page.jsx" switcher
'use client'

import { experimental_useOptimistic as useOptimistic } from 'react'
import { send } from './actions'

export function Thread({ messages }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) => [...state, { message: newMessage }]
  )

  return (
    <div>
      {optimisticMessages.map((m) => (
        <div>{m.message}</div>
      ))}
      <form
        action={async (formData) => {
          const message = formData.get('message')
          addOptimisticMessage(message)
          await send(message)
        }}
      >
        <input type="text" name="message" />
        <button type="submit">å‘é€</button>
      </form>
    </div>
  )
}
```

</AppOnly>

### è®¾ç½® Cookies

<PagesOnly>

æ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨å“åº”å¯¹è±¡çš„ `setHeader` æ–¹æ³•è®¾ç½® cookieï¼š

```ts filename="pages/api/cookie.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  res.setHeader('Set-Cookie', 'username=lee; Path=/; HttpOnly')
  res.status(200).send('Cookie å·²è®¾ç½®ã€‚')
}
```

```js filename="pages/api/cookie.js" switcher
export default async function handler(req, res) {
  res.setHeader('Set-Cookie', 'username=lee; Path=/; HttpOnly')
  res.status(200).send('Cookie å·²è®¾ç½®ã€‚')
}
```

</PagesOnly>

<AppOnly>

æ‚¨å¯ä»¥åœ¨æœåŠ¡ç«¯æ“ä½œä¸­ä½¿ç”¨ [`cookies`](/docs/app/api-reference/functions/cookies) å‡½æ•°è®¾ç½® cookieï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { cookies } from 'next/headers'

export async function create() {
  const cart = await createCart()
  cookies().set('cartId', cart.id)
}
```

```js filename="app/actions.js" switcher
'use server'

import { cookies } from 'next/headers'

export async function create() {
  const cart = await createCart()
  cookies().set('cartId', cart.id)
}
```

</AppOnly>

### è¯»å– Cookies

<PagesOnly>

æ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨ [`cookies`](/docs/pages/building-your-application/routing/api-routes#request-helpers) è¯·æ±‚è¾…åŠ©å‡½æ•°è¯»å– cookieï¼š

```ts filename="pages/api/cookie.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const auth = req.cookies.authorization
  // ...
}
```

```js filename="pages/api/cookie.js" switcher
export default async function handler(req, res) {
  const auth = req.cookies.authorization
  // ...
}
```

</PagesOnly>

<AppOnly>

æ‚¨å¯ä»¥åœ¨æœåŠ¡ç«¯æ“ä½œä¸­ä½¿ç”¨ [`cookies`](/docs/app/api-reference/functions/cookies) å‡½æ•°è¯»å– cookieï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { cookies } from 'next/headers'

export async function read() {
  const auth = cookies().get('authorization')?.value
  // ...
}
```

```js filename="app/actions.js" switcher
'use server'

import { cookies } from 'next/headers'

export async function read() {
  const auth = cookies().get('authorization')?.value
  // ...
}
```

</AppOnly>

### åˆ é™¤ Cookies

<PagesOnly>

æ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨å“åº”å¯¹è±¡çš„ `setHeader` æ–¹æ³•åˆ é™¤ cookieï¼š

```ts filename="pages/api/cookie.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  res.setHeader('Set-Cookie', 'username=; Path=/; HttpOnly; Max-Age=0')
  res.status(200).send('Cookie å·²åˆ é™¤ã€‚')
}
```

```js filename="pages/api/cookie.js" switcher
export default async function handler(req, res) {
  res.setHeader('Set-Cookie', 'username=; Path=/; HttpOnly; Max-Age=0')
  res.status(200).send('Cookie å·²åˆ é™¤ã€‚')
}
```

</PagesOnly>

<AppOnly>

æ‚¨å¯ä»¥åœ¨æœåŠ¡ç«¯æ“ä½œä¸­ä½¿ç”¨ [`cookies`](/docs/app/api-reference/functions/cookies) å‡½æ•°åˆ é™¤ cookieï¼š

```ts filename="app/actions.ts" switcher
'use server'

import { cookies } from 'next/headers'

export async function delete() {
  cookies().delete('name')
  // ...
}
```

```js filename="app/actions.js" switcher
'use server'

import { cookies } from 'next/headers'

export async function delete() {
  cookies().delete('name')
  // ...
}
```

æŸ¥çœ‹[æ›´å¤šç¤ºä¾‹](/docs/app/api-reference/functions/cookies#deleting-cookies)äº†è§£å¦‚ä½•ä»æœåŠ¡ç«¯æ“ä½œä¸­åˆ é™¤ cookieã€‚

</AppOnly>
