---
source-updated-at: 2025-05-16T04:52:11.000Z
translation-updated-at: 2025-05-21T20:42:56.207Z
title: èº«ä»½éªŒè¯
description: å­¦ä¹ å¦‚ä½•åœ¨ Next.js ä¸­å®ç°èº«ä»½éªŒè¯ï¼Œæ¶µç›–æœ€ä½³å®è·µã€è·¯ç”±ä¿æŠ¤ã€æˆæƒæŠ€æœ¯å’Œä¼šè¯ç®¡ç†ã€‚
---

è¦åœ¨ Next.js ä¸­å®ç°èº«ä»½éªŒè¯ï¼Œæ‚¨éœ€è¦ç†Ÿæ‚‰ä»¥ä¸‹ä¸‰ä¸ªåŸºç¡€æ¦‚å¿µï¼š

- **[èº«ä»½éªŒè¯ (Authentication)](#authentication)** éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºå…¶å£°ç§°çš„èº«ä»½ã€‚è¦æ±‚ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå¯†ç ç­‰æ–¹å¼è¯æ˜èº«ä»½ã€‚
- **[ä¼šè¯ç®¡ç† (Session Management)](#session-management)** è·¨å¤šä¸ªè¯·æ±‚è·Ÿè¸ªç”¨æˆ·çŠ¶æ€ï¼ˆå¦‚ç™»å½•çŠ¶æ€ï¼‰ã€‚
- **[æˆæƒ (Authorization)](#authorization)** å†³å®šç”¨æˆ·æœ‰æƒè®¿é—®åº”ç”¨çš„å“ªäº›éƒ¨åˆ†ã€‚

æœ¬é¡µå°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Next.js åŠŸèƒ½å®ç°å¸¸è§çš„èº«ä»½éªŒè¯ã€æˆæƒå’Œä¼šè¯ç®¡ç†æ¨¡å¼ï¼Œæ‚¨å¯ä»¥æ ¹æ®åº”ç”¨éœ€æ±‚é€‰æ‹©æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚

## èº«ä»½éªŒè¯

èº«ä»½éªŒè¯ç”¨äºç¡®è®¤ç”¨æˆ·èº«ä»½ã€‚å½“ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå¯†ç æˆ– Google ç­‰æœåŠ¡ç™»å½•æ—¶å³å‘ç”Ÿæ­¤è¿‡ç¨‹ã€‚å…¶æ ¸å¿ƒåœ¨äºéªŒè¯ç”¨æˆ·çœŸå®èº«ä»½ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®å’Œåº”ç”¨ç¨‹åºå…å—æœªæˆæƒè®¿é—®æˆ–æ¬ºè¯ˆè¡Œä¸ºã€‚

### èº«ä»½éªŒè¯ç­–ç•¥

ç°ä»£ Web åº”ç”¨é€šå¸¸é‡‡ç”¨ä»¥ä¸‹å‡ ç§èº«ä»½éªŒè¯ç­–ç•¥ï¼š

1. **OAuth/OpenID Connect (OIDC)**ï¼šå…è®¸ç¬¬ä¸‰æ–¹è®¿é—®è€Œä¸å…±äº«ç”¨æˆ·å‡­è¯ã€‚é€‚ç”¨äºç¤¾äº¤åª’ä½“ç™»å½•å’Œå•ç‚¹ç™»å½• (SSO) è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ OpenID Connect æ·»åŠ èº«ä»½å±‚ã€‚
2. **å‡­è¯ç™»å½• (Email + Password)**ï¼šWeb åº”ç”¨çš„æ ‡å‡†é€‰æ‹©ï¼Œç”¨æˆ·é€šè¿‡é‚®ç®±å’Œå¯†ç ç™»å½•ã€‚è™½ç„¶ç†Ÿæ‚‰æ˜“å®ç°ï¼Œä½†éœ€é‡‡å–å¼ºå®‰å…¨æªæ–½é˜²èŒƒç½‘ç»œé’“é±¼ç­‰å¨èƒã€‚
3. **æ— å¯†ç /ä»¤ç‰ŒéªŒè¯ (Passwordless/Token-based)**ï¼šä½¿ç”¨é‚®ç®±é­”æœ¯é“¾æ¥æˆ–çŸ­ä¿¡ä¸€æ¬¡æ€§ä»£ç å®ç°å…å¯†å®‰å…¨è®¿é—®ã€‚å› å…¶ä¾¿åˆ©æ€§å’Œå¢å¼ºå®‰å…¨æ€§è€Œæµè¡Œï¼Œå¯å‡å°‘å¯†ç ç–²åŠ³ã€‚å±€é™æ€§åœ¨äºä¾èµ–ç”¨æˆ·é‚®ç®±æˆ–æ‰‹æœºå¯ç”¨æ€§ã€‚
4. **é€šè¡Œå¯†é’¥/WebAuthn (Passkeys/WebAuthn)**ï¼šä½¿ç”¨æ¯ä¸ªç«™ç‚¹å”¯ä¸€çš„åŠ å¯†å‡­è¯ï¼Œæä¾›é˜²é’“é±¼çš„é«˜å®‰å…¨æ€§ã€‚è™½ç„¶å®‰å…¨ä½†è¾ƒæ–°ï¼Œå®ç°éš¾åº¦è¾ƒå¤§ã€‚

é€‰æ‹©èº«ä»½éªŒè¯ç­–ç•¥åº”ä¸åº”ç”¨ç¨‹åºçš„ç‰¹å®šéœ€æ±‚ã€ç”¨æˆ·ç•Œé¢è€ƒè™‘å’Œå®‰å…¨ç›®æ ‡ä¿æŒä¸€è‡´ã€‚

### å®ç°èº«ä»½éªŒè¯

æœ¬èŠ‚å°†æ¢è®¨å¦‚ä½•ä¸º Web åº”ç”¨æ·»åŠ åŸºç¡€çš„é‚®ç®±å¯†ç éªŒè¯ã€‚è™½ç„¶æ­¤æ–¹æ³•æä¾›åŸºæœ¬å®‰å…¨çº§åˆ«ï¼Œä½†å»ºè®®è€ƒè™‘ OAuth æˆ–æ— å¯†ç ç™»å½•ç­‰æ›´é«˜çº§é€‰é¡¹ä»¥å¢å¼ºå¯¹å¸¸è§å®‰å…¨å¨èƒçš„é˜²æŠ¤ã€‚æˆ‘ä»¬å°†è®¨è®ºçš„éªŒè¯æµç¨‹å¦‚ä¸‹ï¼š

<PagesOnly>

1. ç”¨æˆ·é€šè¿‡ç™»å½•è¡¨å•æäº¤å‡­è¯
2. è¡¨å•å‘é€ç”± API è·¯ç”±å¤„ç†çš„è¯·æ±‚
3. éªŒè¯æˆåŠŸåå®Œæˆæµç¨‹ï¼Œè¡¨ç¤ºç”¨æˆ·éªŒè¯æˆåŠŸ
4. è‹¥éªŒè¯å¤±è´¥åˆ™æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

è€ƒè™‘ä»¥ä¸‹ç”¨æˆ·å¯è¾“å…¥å‡­è¯çš„ç™»å½•è¡¨å•ï¼š

```tsx filename="pages/login.tsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // å¤„ç†é”™è¯¯
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

```jsx filename="pages/login.jsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // å¤„ç†é”™è¯¯
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

ä¸Šè¿°è¡¨å•åŒ…å«ä¸¤ä¸ªè¾“å…¥å­—æ®µç”¨äºè·å–ç”¨æˆ·é‚®ç®±å’Œå¯†ç ã€‚æäº¤æ—¶ä¼šè§¦å‘å‘ API è·¯ç”± (`/api/auth/login`) å‘é€ POST è¯·æ±‚çš„å‡½æ•°ã€‚

ç„¶åæ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­è°ƒç”¨èº«ä»½éªŒè¯æä¾›å•†çš„ API æ¥å¤„ç†éªŒè¯ï¼š

```ts filename="pages/api/auth/login.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'æ— æ•ˆå‡­è¯' })
    } else {
      res.status(500).json({ error: 'å‘ç”Ÿé”™è¯¯' })
    }
  }
}
```

```js filename="pages/api/auth/login.js" switcher
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'æ— æ•ˆå‡­è¯' })
    } else {
      res.status(500).json({ error: 'å‘ç”Ÿé”™è¯¯' })
    }
  }
}
```

</PagesOnly>

<AppOnly>

1. ç”¨æˆ·é€šè¿‡ç™»å½•è¡¨å•æäº¤å‡­è¯
2. è¡¨å•è°ƒç”¨æœåŠ¡å™¨æ“ä½œ (Server Action)
3. éªŒè¯æˆåŠŸåå®Œæˆæµç¨‹ï¼Œè¡¨ç¤ºç”¨æˆ·éªŒè¯æˆåŠŸ
4. è‹¥éªŒè¯å¤±è´¥åˆ™æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

è€ƒè™‘ä»¥ä¸‹ç”¨æˆ·å¯è¾“å…¥å‡­è¯çš„ç™»å½•è¡¨å•ï¼š

```tsx filename="app/login/page.tsx" switcher
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

```jsx filename="app/login/page.jsx" switcher
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

ä¸Šè¿°è¡¨å•åŒ…å«ä¸¤ä¸ªè¾“å…¥å­—æ®µç”¨äºè·å–ç”¨æˆ·é‚®ç®±å’Œå¯†ç ã€‚æäº¤æ—¶ä¼šè°ƒç”¨ `authenticate` æœåŠ¡å™¨æ“ä½œã€‚

ç„¶åæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨æ“ä½œä¸­è°ƒç”¨èº«ä»½éªŒè¯æä¾›å•†çš„ API æ¥å¤„ç†éªŒè¯ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState: unknown, formData: FormData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'æ— æ•ˆå‡­è¯'
        default:
          return 'å‘ç”Ÿé”™è¯¯'
      }
    }
    throw error
  }
}
```

```js filename="app/lib/actions.js" switcher
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState, formData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'æ— æ•ˆå‡­è¯'
        default:
          return 'å‘ç”Ÿé”™è¯¯'
      }
    }
    throw error
  }
}
```

</AppOnly>

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ`signIn` æ–¹æ³•ä¼šæ ¹æ®å­˜å‚¨çš„ç”¨æˆ·æ•°æ®æ£€æŸ¥å‡­è¯ã€‚èº«ä»½éªŒè¯æä¾›å•†å¤„ç†å‡­è¯åï¼Œæœ‰ä¸¤ç§å¯èƒ½ç»“æœï¼š

- **éªŒè¯æˆåŠŸ**ï¼šæ„å‘³ç€ç™»å½•æˆåŠŸã€‚éšåå¯å‘èµ·è®¿é—®å—ä¿æŠ¤è·¯ç”±å’Œè·å–ç”¨æˆ·ä¿¡æ¯ç­‰æ“ä½œã€‚
- **éªŒè¯å¤±è´¥**ï¼šå½“å‡­è¯é”™è¯¯æˆ–é‡åˆ°é”™è¯¯æ—¶ï¼Œå‡½æ•°è¿”å›ç›¸åº”é”™è¯¯ä¿¡æ¯è¡¨ç¤ºéªŒè¯å¤±è´¥ã€‚

<AppOnly>

æœ€åï¼Œåœ¨æ‚¨çš„ `login-form.tsx` ç»„ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ React çš„ `useFormState` è°ƒç”¨æœåŠ¡å™¨æ“ä½œå¹¶å¤„ç†è¡¨å•é”™è¯¯ï¼Œä½¿ç”¨ `useFormStatus` å¤„ç†è¡¨å•çš„å¾…å®šçŠ¶æ€ï¼š

```tsx filename="app/login/page.tsx" switcher
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  const handleClick = (event) => {
    if (pending) {
      event.preventDefault()
    }
  }

  return (
    <button aria-disabled={pending} type="submit" onClick={handleClick}>
      ç™»å½•
    </button>
  )
}
```

```jsx filename="app/login/page.jsx" switcher
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  const handleClick = (event) => {
    if (pending) {
      event.preventDefault()
    }
  }

  return (
    <button aria-disabled={pending} type="submit" onClick={handleClick}>
      ç™»å½•
    </button>
  )
}
```

</AppOnly>

å¯¹äº Next.js é¡¹ç›®ä¸­æ›´ç®€åŒ–çš„èº«ä»½éªŒè¯è®¾ç½®ï¼Œç‰¹åˆ«æ˜¯å½“æä¾›å¤šç§ç™»å½•æ–¹å¼æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å…¨é¢çš„[èº«ä»½éªŒè¯è§£å†³æ–¹æ¡ˆ](#examples)ã€‚

## æˆæƒ

ç”¨æˆ·é€šè¿‡èº«ä»½éªŒè¯åï¼Œæ‚¨éœ€è¦ç¡®ä¿ç”¨æˆ·æœ‰æƒè®¿é—®ç‰¹å®šè·¯ç”±ï¼Œå¹¶æ‰§è¡Œè¯¸å¦‚ä½¿ç”¨æœåŠ¡å™¨æ“ä½œå˜æ›´æ•°æ®å’Œè°ƒç”¨è·¯ç”±å¤„ç†ç¨‹åºç­‰æ“ä½œã€‚

### ä½¿ç”¨ä¸­é—´ä»¶ä¿æŠ¤è·¯ç”±

Next.js ä¸­çš„[ä¸­é—´ä»¶ (Middleware)](/docs/app/building-your-application/routing/middleware) å¯å¸®åŠ©æ§åˆ¶ç½‘ç«™ä¸åŒéƒ¨åˆ†çš„è®¿é—®æƒé™ã€‚è¿™å¯¹äºä¿æŠ¤ç”¨æˆ·ä»ªè¡¨ç›˜ç­‰åŒºåŸŸåŒæ—¶ä¿æŒè¥é”€é¡µé¢å…¬å¼€éå¸¸é‡è¦ã€‚å»ºè®®å¯¹æ‰€æœ‰è·¯ç”±åº”ç”¨ä¸­é—´ä»¶ï¼Œå¹¶ä¸ºå…¬å¼€è®¿é—®æŒ‡å®šä¾‹å¤–ã€‚

ä»¥ä¸‹æ˜¯åœ¨ Next.js ä¸­å®ç°èº«ä»½éªŒè¯ä¸­é—´ä»¶çš„æ–¹æ³•ï¼š

#### è®¾ç½®ä¸­é—´ä»¶ï¼š

- åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `middleware.ts` æˆ– `.js` æ–‡ä»¶
- åŒ…å«æˆæƒç”¨æˆ·è®¿é—®çš„é€»è¾‘ï¼Œå¦‚æ£€æŸ¥éªŒè¯ä»¤ç‰Œ

#### å®šä¹‰å—ä¿æŠ¤è·¯ç”±ï¼š

- å¹¶éæ‰€æœ‰è·¯ç”±éƒ½éœ€è¦æˆæƒã€‚ä½¿ç”¨ä¸­é—´ä»¶ä¸­çš„ `matcher` é€‰é¡¹æŒ‡å®šä¸éœ€è¦æˆæƒæ£€æŸ¥çš„è·¯ç”±

#### ä¸­é—´ä»¶é€»è¾‘ï¼š

- ç¼–å†™éªŒè¯ç”¨æˆ·æ˜¯å¦å·²é€šè¿‡èº«ä»½éªŒè¯çš„é€»è¾‘ã€‚æ£€æŸ¥ç”¨æˆ·è§’è‰²æˆ–æƒé™ä»¥è¿›è¡Œè·¯ç”±æˆæƒ

#### å¤„ç†æœªæˆæƒè®¿é—®ï¼š

- æ ¹æ®æƒ…å†µå°†æœªæˆæƒç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µæˆ–é”™è¯¯é¡µ

ä¸­é—´ä»¶æ–‡ä»¶ç¤ºä¾‹ï¼š

```ts filename="middleware.ts" switcher
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser && !request.nextUrl.pathname.startsWith('/dashboard')) {
    return Response.redirect(new URL('/dashboard', request.url))
  }

  if (!currentUser && !request.nextUrl.pathname.startsWith('/login')) {
    return Response.redirect(new URL('/login', request.url))
  }
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

```js filename="middleware.js" switcher
export function middleware(request) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser && !request.nextUrl.pathname.startsWith('/dashboard')) {
    return Response.redirect(new URL('/dashboard', request.url))
  }

  if (!currentUser && !request.nextUrl.pathname.startsWith('/login')) {
    return Response.redirect(new URL('/login', request.url))
  }
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

æ­¤ç¤ºä¾‹ä½¿ç”¨ [`Response.redirect`](https://developer.mozilla.org/en-US/docs/Web/API/Response/redirect_static) åœ¨è¯·æ±‚ç®¡é“æ—©æœŸå¤„ç†é‡å®šå‘ï¼Œä½¿å…¶é«˜æ•ˆä¸”é›†ä¸­è®¿é—®æ§åˆ¶ã€‚

<AppOnly>

å¯¹äºç‰¹å®šçš„é‡å®šå‘éœ€æ±‚ï¼Œå¯åœ¨æœåŠ¡å™¨ç»„ä»¶ã€è·¯ç”±å¤„ç†ç¨‹åºå’ŒæœåŠ¡å™¨æ“ä½œä¸­ä½¿ç”¨ `redirect` å‡½æ•°ä»¥æä¾›æ›´å¤šæ§åˆ¶ã€‚è¿™å¯¹äºåŸºäºè§’è‰²çš„å¯¼èˆªæˆ–ä¸Šä¸‹æ–‡æ•æ„Ÿåœºæ™¯éå¸¸æœ‰ç”¨ã€‚

```ts filename="app/page.tsx" switcher
import { redirect } from 'next/navigation'

export default function Page() {
  // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘çš„é€»è¾‘
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // å®šä¹‰å…¶ä»–è·¯ç”±å’Œé€»è¾‘
}
```

```js filename="app/page.jsx" switcher
import { redirect } from 'next/navigation'

export default function Page() {
  // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘çš„é€»è¾‘
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // å®šä¹‰å…¶ä»–è·¯ç”±å’Œé€»è¾‘
}
```

</AppOnly>

æˆåŠŸéªŒè¯åï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²ç®¡ç†å¯¼èˆªéå¸¸é‡è¦ã€‚ä¾‹å¦‚ï¼Œç®¡ç†å‘˜ç”¨æˆ·å¯èƒ½è¢«é‡å®šå‘åˆ°ç®¡ç†ä»ªè¡¨ç›˜ï¼Œè€Œæ™®é€šç”¨æˆ·åˆ™è¢«å‘é€åˆ°ä¸åŒé¡µé¢ã€‚è¿™å¯¹äºè§’è‰²ç‰¹å®šä½“éªŒå’Œæ¡ä»¶å¯¼èˆªï¼ˆå¦‚éœ€è¦æ—¶æç¤ºç”¨æˆ·å®Œå–„èµ„æ–™ï¼‰éå¸¸é‡è¦ã€‚

è®¾ç½®æˆæƒæ—¶ï¼Œå¿…é¡»ç¡®ä¿ä¸»è¦å®‰å…¨æ£€æŸ¥å‘ç”Ÿåœ¨åº”ç”¨è®¿é—®æˆ–æ›´æ”¹æ•°æ®çš„ä½ç½®ã€‚è™½ç„¶ä¸­é—´ä»¶å¯ç”¨äºåˆå§‹éªŒè¯ï¼Œä½†ä¸åº”è¯¥æ˜¯ä¿æŠ¤æ•°æ®çš„å”¯ä¸€é˜²çº¿ã€‚å¤§éƒ¨åˆ†å®‰å…¨æ£€æŸ¥åº”åœ¨æ•°æ®è®¿é—®å±‚ (DAL) æ‰§è¡Œã€‚

<PagesOnly>

### ä¿æŠ¤ API è·¯ç”±

Next.js ä¸­çš„ API è·¯ç”±å¯¹äºå¤„ç†æœåŠ¡ç«¯é€»è¾‘å’Œæ•°æ®ç®¡ç†è‡³å…³é‡è¦ã€‚ç¡®ä¿è¿™äº›è·¯ç”±çš„å®‰å…¨æ€§ååˆ†å¿…è¦ï¼Œåªæœ‰ç»è¿‡æˆæƒçš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç‰¹å®šåŠŸèƒ½ã€‚è¿™é€šå¸¸æ¶‰åŠéªŒè¯ç”¨æˆ·çš„è®¤è¯çŠ¶æ€åŠå…¶åŸºäºè§’è‰²çš„æƒé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¿æŠ¤ API è·¯ç”±çš„ç¤ºä¾‹ï¼š

```ts filename="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    res.status(401).json({
      error: 'ç”¨æˆ·æœªè®¤è¯',
    })
    return
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·ä¸å…·å¤‡ç®¡ç†å‘˜æƒé™ã€‚',
    })
    return
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œè·¯ç”±é€»è¾‘
  // ... API è·¯ç”±çš„å…·ä½“å®ç°
}
```

```js filename="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req)

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    res.status(401).json({
      error: 'ç”¨æˆ·æœªè®¤è¯',
    })
    return
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·ä¸å…·å¤‡ç®¡ç†å‘˜æƒé™ã€‚',
    })
    return
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œè·¯ç”±é€»è¾‘
  // ... API è·¯ç”±çš„å…·ä½“å®ç°
}
```

æ­¤ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå…·æœ‰åŒé‡å®‰å…¨æ£€æŸ¥ï¼ˆè®¤è¯å’Œæˆæƒï¼‰çš„ API è·¯ç”±ã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ´»è·ƒä¼šè¯ï¼Œç„¶åéªŒè¯å·²ç™»å½•ç”¨æˆ·æ˜¯å¦ä¸º 'admin'ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿äº†åªæœ‰ç»è¿‡è®¤è¯å’Œæˆæƒçš„ç”¨æˆ·æ‰èƒ½å®‰å…¨è®¿é—®ï¼Œä¸ºè¯·æ±‚å¤„ç†æä¾›äº†å¼ºå¤§çš„å®‰å…¨ä¿éšœã€‚

</PagesOnly>

<AppOnly>

å¦‚[è¿™ç¯‡å®‰å…¨åšå®¢](/blog/security-nextjs-server-components-actions)æ‰€è¿°ï¼Œæ¨èå°†æ‰€æœ‰æ•°æ®è®¿é—®é›†ä¸­åˆ°ä¸“ç”¨çš„æ•°æ®è®¿é—®å±‚ (DAL) ä¸­ã€‚è¿™ç§ç­–ç•¥èƒ½ç¡®ä¿ä¸€è‡´çš„æ•°æ®è®¿é—®ï¼Œå‡å°‘æˆæƒé”™è¯¯ï¼Œå¹¶ç®€åŒ–ç»´æŠ¤å·¥ä½œã€‚ä¸ºç¡®ä¿å…¨é¢å®‰å…¨æ€§ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å…³é”®é¢†åŸŸï¼š

- æœåŠ¡ç«¯æ“ä½œ (Server Actions)ï¼šåœ¨æœåŠ¡ç«¯æµç¨‹ä¸­å®æ–½å®‰å…¨æ£€æŸ¥ï¼Œç‰¹åˆ«æ˜¯æ•æ„Ÿæ“ä½œã€‚
- è·¯ç”±å¤„ç†å™¨ (Route Handlers)ï¼šé€šè¿‡å®‰å…¨æªæ–½ç®¡ç†ä¼ å…¥è¯·æ±‚ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è®¿é—®ã€‚
- æ•°æ®è®¿é—®å±‚ (DAL)ï¼šç›´æ¥ä¸æ•°æ®åº“äº¤äº’ï¼Œè´Ÿè´£éªŒè¯å’Œæˆæƒæ•°æ®äº‹åŠ¡ã€‚åœ¨ DAL ä¸­æ‰§è¡Œå…³é”®æ£€æŸ¥è‡³å…³é‡è¦ï¼Œä»¥åœ¨æ•°æ®æœ€å…³é”®çš„æ“ä½œç‚¹ï¼ˆè®¿é—®æˆ–ä¿®æ”¹ï¼‰ç¡®ä¿å®‰å…¨ã€‚

å…³äºå¦‚ä½•ä¿æŠ¤ DAL çš„è¯¦ç»†æŒ‡å—ï¼ŒåŒ…æ‹¬ç¤ºä¾‹ä»£ç ç‰‡æ®µå’Œé«˜çº§å®‰å…¨å®è·µï¼Œè¯·å‚é˜…å®‰å…¨æŒ‡å—ä¸­çš„[æ•°æ®è®¿é—®å±‚éƒ¨åˆ†](/blog/security-nextjs-server-components-actions#data-access-layer)ã€‚

### ä¿æŠ¤æœåŠ¡ç«¯æ“ä½œ

å¯¹å¾…[æœåŠ¡ç«¯æ“ä½œ](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)æ—¶ï¼Œåº”ä¸é¢å‘å…¬ä¼—çš„ API ç«¯ç‚¹ä¸€æ ·é‡è§†å®‰å…¨æ€§ã€‚éªŒè¯æ¯ä¸ªæ“ä½œç”¨æˆ·çš„æˆæƒè‡³å…³é‡è¦ã€‚åœ¨æœåŠ¡ç«¯æ“ä½œä¸­å®æ–½æƒé™æ£€æŸ¥ï¼Œä¾‹å¦‚é™åˆ¶æŸäº›æ“ä½œä»…é™ç®¡ç†å‘˜ç”¨æˆ·æ‰§è¡Œã€‚

ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å…è®¸æ“ä½œç»§ç»­ä¹‹å‰æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæ‰§è¡Œè¯¥æ“ä½œ
  if (userRole !== 'admin') {
    throw new Error('æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·ä¸å…·å¤‡ç®¡ç†å‘˜æƒé™ã€‚')
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œæ“ä½œ
  // ... æ“ä½œçš„å…·ä½“å®ç°
}
```

```js filename="app/lib/actions.js" switcher
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæ‰§è¡Œè¯¥æ“ä½œ
  if (userRole !== 'admin') {
    throw new Error('æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·ä¸å…·å¤‡ç®¡ç†å‘˜æƒé™ã€‚')
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œæ“ä½œ
  // ... æ“ä½œçš„å…·ä½“å®ç°
}
```

### ä¿æŠ¤è·¯ç”±å¤„ç†å™¨

Next.js ä¸­çš„è·¯ç”±å¤„ç†å™¨åœ¨ç®¡ç†ä¼ å…¥è¯·æ±‚æ–¹é¢èµ·ç€å…³é”®ä½œç”¨ã€‚ä¸æœåŠ¡ç«¯æ“ä½œä¸€æ ·ï¼Œåº”ç¡®ä¿å…¶å®‰å…¨æ€§ï¼Œä»…é™æˆæƒç”¨æˆ·è®¿é—®ç‰¹å®šåŠŸèƒ½ã€‚è¿™é€šå¸¸æ¶‰åŠéªŒè¯ç”¨æˆ·çš„è®¤è¯çŠ¶æ€åŠå…¶æƒé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¿æŠ¤è·¯ç”±å¤„ç†å™¨çš„ç¤ºä¾‹ï¼š

```ts filename="app/api/route.ts" switcher
export async function GET() {
  // ç”¨æˆ·è®¤è¯å’Œè§’è‰²éªŒè¯
  const session = await getSession()

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    return new Response(null, { status: 401 }) // ç”¨æˆ·æœªè®¤è¯
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // ç”¨æˆ·å·²è®¤è¯ä½†æ— æƒé™
  }

  // ä¸ºæˆæƒç”¨æˆ·è·å–æ•°æ®
}
```

```js filename="app/api/route.js" switcher
export async function GET() {
  // ç”¨æˆ·è®¤è¯å’Œè§’è‰²éªŒè¯
  const session = await getSession()

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    return new Response(null, { status: 401 }) // ç”¨æˆ·æœªè®¤è¯
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // ç”¨æˆ·å·²è®¤è¯ä½†æ— æƒé™
  }

  // ä¸ºæˆæƒç”¨æˆ·è·å–æ•°æ®
}
```

æ­¤ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå…·æœ‰åŒé‡å®‰å…¨æ£€æŸ¥ï¼ˆè®¤è¯å’Œæˆæƒï¼‰çš„è·¯ç”±å¤„ç†å™¨ã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ´»è·ƒä¼šè¯ï¼Œç„¶åéªŒè¯å·²ç™»å½•ç”¨æˆ·æ˜¯å¦ä¸º 'admin'ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿äº†åªæœ‰ç»è¿‡è®¤è¯å’Œæˆæƒçš„ç”¨æˆ·æ‰èƒ½å®‰å…¨è®¿é—®ï¼Œä¸ºè¯·æ±‚å¤„ç†æä¾›äº†å¼ºå¤§çš„å®‰å…¨ä¿éšœã€‚

### ä½¿ç”¨æœåŠ¡ç«¯ç»„ä»¶è¿›è¡Œæˆæƒ

Next.js ä¸­çš„[æœåŠ¡ç«¯ç»„ä»¶](/docs/app/building-your-application/rendering/server-components)ä¸“ä¸ºæœåŠ¡ç«¯æ‰§è¡Œè®¾è®¡ï¼Œä¸ºé›†æˆå¤æ‚é€»è¾‘ï¼ˆå¦‚æˆæƒï¼‰æä¾›äº†å®‰å…¨ç¯å¢ƒã€‚å®ƒä»¬å¯ç›´æ¥è®¿é—®åç«¯èµ„æºï¼Œä¼˜åŒ–æ•°æ®å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ï¼Œå¹¶å¢å¼ºæ•æ„Ÿæ“ä½œçš„å®‰å…¨æ€§ã€‚

åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­ï¼Œå¸¸è§çš„åšæ³•æ˜¯æ ¹æ®ç”¨æˆ·è§’è‰²æœ‰æ¡ä»¶åœ°æ¸²æŸ“ UI å…ƒç´ ã€‚è¿™ç§æ–¹æ³•é€šè¿‡ç¡®ä¿ç”¨æˆ·ä»…è®¿é—®å…¶æœ‰æƒæŸ¥çœ‹çš„å†…å®¹ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ã€‚

**ç¤ºä¾‹ï¼š**

```tsx filename="app/dashboard/page.tsx" switcher
export default async function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // å‡è®¾ 'role' æ˜¯ä¼šè¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard /> // ç®¡ç†å‘˜ç”¨æˆ·çš„ç»„ä»¶
  } else if (userRole === 'user') {
    return <UserDashboard /> // æ™®é€šç”¨æˆ·çš„ç»„ä»¶
  } else {
    return <AccessDenied /> // æœªæˆæƒè®¿é—®æ—¶æ˜¾ç¤ºçš„ç»„ä»¶
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
export default function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // å‡è®¾ 'role' æ˜¯ä¼šè¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard /> // ç®¡ç†å‘˜ç”¨æˆ·çš„ç»„ä»¶
  } else if (userRole === 'user') {
    return <UserDashboard /> // æ™®é€šç”¨æˆ·çš„ç»„ä»¶
  } else {
    return <AccessDenied /> // æœªæˆæƒè®¿é—®æ—¶æ˜¾ç¤ºçš„ç»„ä»¶
  }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒDashboard ç»„ä»¶æ ¹æ® 'admin'ã€'user' å’Œæœªæˆæƒè§’è‰²æ¸²æŸ“ä¸åŒçš„ UIã€‚è¿™ç§æ¨¡å¼ç¡®ä¿æ¯ä¸ªç”¨æˆ·ä»…ä¸å…¶è§’è‰²å¯¹åº”çš„ç»„ä»¶äº¤äº’ï¼Œä»è€Œæå‡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

</AppOnly>

### æœ€ä½³å®è·µ

- **å®‰å…¨çš„ä¼šè¯ç®¡ç†**ï¼šä¼˜å…ˆä¿æŠ¤ä¼šè¯æ•°æ®çš„å®‰å…¨ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®å’Œæ•°æ®æ³„éœ²ã€‚ä½¿ç”¨åŠ å¯†å’Œå®‰å…¨å­˜å‚¨å®è·µã€‚
- **åŠ¨æ€è§’è‰²ç®¡ç†**ï¼šé‡‡ç”¨çµæ´»çš„ç”¨æˆ·è§’è‰²ç³»ç»Ÿï¼Œä¾¿äºè°ƒæ•´æƒé™å’Œè§’è‰²ï¼Œé¿å…ç¡¬ç¼–ç è§’è‰²ã€‚
- **å®‰å…¨ä¼˜å…ˆç­–ç•¥**ï¼šåœ¨æ‰€æœ‰æˆæƒé€»è¾‘ä¸­ä¼˜å…ˆè€ƒè™‘å®‰å…¨æ€§ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®å¹¶ç»´æŠ¤åº”ç”¨çš„å®Œæ•´æ€§ã€‚è¿™åŒ…æ‹¬å…¨é¢æµ‹è¯•å’Œè€ƒè™‘æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚

## ä¼šè¯ç®¡ç†

ä¼šè¯ç®¡ç†æ¶‰åŠè·Ÿè¸ªå’Œç®¡ç†ç”¨æˆ·ä¸åº”ç”¨çš„äº¤äº’ï¼Œç¡®ä¿å…¶è®¤è¯çŠ¶æ€åœ¨åº”ç”¨çš„ä¸åŒéƒ¨åˆ†ä¹‹é—´ä¿æŒã€‚è¿™é¿å…äº†é‡å¤ç™»å½•çš„éœ€è¦ï¼Œæ—¢å¢å¼ºäº†å®‰å…¨æ€§ï¼Œåˆæå‡äº†ç”¨æˆ·ä½“éªŒã€‚ä¸»è¦æœ‰ä¸¤ç§ä¼šè¯ç®¡ç†æ–¹æ³•ï¼šåŸºäº Cookie çš„ä¼šè¯å’Œæ•°æ®åº“ä¼šè¯ã€‚

### åŸºäº Cookie çš„ä¼šè¯

> **ğŸ¥ è§‚çœ‹**ï¼šäº†è§£æ›´å¤šå…³äºåŸºäº Cookie çš„ä¼šè¯å’Œ Next.js è®¤è¯ â†’ [YouTube (11 åˆ†é’Ÿ)](https://www.youtube.com/watch?v=DJvM2lSPn6w)ã€‚

åŸºäº Cookie çš„ä¼šè¯é€šè¿‡å°†åŠ å¯†çš„ä¼šè¯ä¿¡æ¯ç›´æ¥å­˜å‚¨åœ¨æµè§ˆå™¨ Cookie ä¸­æ¥ç®¡ç†ç”¨æˆ·æ•°æ®ã€‚ç”¨æˆ·ç™»å½•åï¼ŒåŠ å¯†æ•°æ®å­˜å‚¨åœ¨ Cookie ä¸­ã€‚éšåçš„æ¯ä¸ªæœåŠ¡å™¨è¯·æ±‚éƒ½ä¼šåŒ…å«æ­¤ Cookieï¼Œå‡å°‘é‡å¤æœåŠ¡å™¨æŸ¥è¯¢çš„éœ€æ±‚ï¼Œæå‡å®¢æˆ·ç«¯æ•ˆç‡ã€‚

ç„¶è€Œï¼Œæ­¤æ–¹æ³•éœ€è¦è°¨æ…åŠ å¯†ä»¥ä¿æŠ¤æ•æ„Ÿæ•°æ®ï¼Œå› ä¸º Cookie å®¹æ˜“å—åˆ°å®¢æˆ·ç«¯å®‰å…¨é£é™©çš„å½±å“ã€‚åŠ å¯† Cookie ä¸­çš„ä¼šè¯æ•°æ®æ˜¯ä¿æŠ¤ç”¨æˆ·ä¿¡æ¯å…å—æœªæˆæƒè®¿é—®çš„å…³é”®ã€‚å³ä½¿ Cookie è¢«ç›—ï¼Œå†…éƒ¨æ•°æ®ä»ä¸å¯è¯»ã€‚

æ­¤å¤–ï¼Œè™½ç„¶å•ä¸ª Cookie çš„å¤§å°æœ‰é™ï¼ˆé€šå¸¸çº¦ 4KBï¼‰ï¼Œä½†é€šè¿‡ Cookie åˆ†å—ç­‰æŠ€æœ¯å¯ä»¥å°†å¤§å‹ä¼šè¯æ•°æ®åˆ†å‰²åˆ°å¤šä¸ª Cookie ä¸­ã€‚

åœ¨ Next.js é¡¹ç›®ä¸­è®¾ç½® Cookie å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

**åœ¨æœåŠ¡å™¨ç«¯è®¾ç½® Cookieï¼š**

<PagesOnly>

```ts filename="pages/api/login.ts" switcher
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè®¾ç½® Cookieï¼' })
}
```

```js filename="pages/api/login.js" switcher
import { serialize } from 'cookie'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'æˆåŠŸè®¾ç½® Cookieï¼' })
}
```

</PagesOnly>

<AppOnly>

```ts filename="app/actions.ts" switcher
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // åŠ å¯†ä¼šè¯æ•°æ®
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  // è®¾ç½® Cookie åé‡å®šå‘æˆ–å¤„ç†å“åº”
}
```

```js filename="app/actions.js" switcher
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // åŠ å¯†ä¼šè¯æ•°æ®
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  // è®¾ç½® Cookie åé‡å®šå‘æˆ–å¤„ç†å“åº”
}
```

**åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­è®¿é—®å­˜å‚¨åœ¨ Cookie ä¸­çš„ä¼šè¯æ•°æ®ï¼š**

```tsx filename="app/page.tsx" switcher
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

```jsx filename="app/page.jsx" switcher
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

</AppOnly>

### æ•°æ®åº“ä¼šè¯

æ•°æ®åº“ä¼šè¯ç®¡ç†å°†ä¼šè¯æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œç”¨æˆ·çš„æµè§ˆå™¨ä»…æ¥æ”¶ä¼šè¯ IDã€‚æ­¤ ID å¼•ç”¨å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯çš„ä¼šè¯æ•°æ®ï¼Œè€Œä¸åŒ…å«æ•°æ®æœ¬èº«ã€‚è¿™ç§æ–¹æ³•å¢å¼ºäº†å®‰å…¨æ€§ï¼Œå› ä¸ºæ•æ„Ÿä¼šè¯æ•°æ®è¿œç¦»å®¢æˆ·ç«¯ç¯å¢ƒï¼Œå‡å°‘äº†æš´éœ²äºå®¢æˆ·ç«¯æ”»å‡»çš„é£é™©ã€‚æ•°æ®åº“ä¼šè¯ä¹Ÿæ›´å…·æœ‰æ‰©å±•æ€§ï¼Œé€‚åº”æ›´å¤§çš„æ•°æ®å­˜å‚¨éœ€æ±‚ã€‚

ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•æœ‰å…¶æƒè¡¡ã€‚ç”±äºæ¯æ¬¡ç”¨æˆ·äº¤äº’éƒ½éœ€è¦æ•°æ®åº“æŸ¥è¯¢ï¼Œå¯èƒ½ä¼šå¢åŠ æ€§èƒ½å¼€é”€ã€‚ä¼šè¯æ•°æ®ç¼“å­˜ç­‰ç­–ç•¥å¯ä»¥å¸®åŠ©ç¼“è§£æ­¤é—®é¢˜ã€‚æ­¤å¤–ï¼Œä¾èµ–æ•°æ®åº“æ„å‘³ç€ä¼šè¯ç®¡ç†çš„å¯é æ€§å–å†³äºæ•°æ®åº“çš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚

ä»¥ä¸‹æ˜¯åœ¨ Next.js åº”ç”¨ä¸­å®ç°æ•°æ®åº“ä¼šè¯çš„ç®€åŒ–ç¤ºä¾‹ï¼š

**åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¼šè¯ï¼š**

<PagesOnly>

```ts filename="pages/api/create-session.ts" switcher
import db from '../../lib/db'
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯' })
  }
}
```

```js filename="pages/api/create-session.js" switcher
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯' })
  }
}
```

</PagesOnly>

<AppOnly>

```js
import db from './lib/db'

export async function createSession(user) {
  const sessionId = generateSessionId() // ç”Ÿæˆå”¯ä¸€ä¼šè¯ ID
  await db.insertSession({ sessionId, userId: user.id, createdAt: new Date() })
  return sessionId
}
```

**åœ¨ä¸­é—´ä»¶æˆ–æœåŠ¡ç«¯é€»è¾‘ä¸­æ£€ç´¢ä¼šè¯ï¼š**

```js
import { cookies } from 'next/headers'
import db from './lib/db'

export async function getSession() {
  const sessionId = cookies().get('sessionId')?.value
  return sessionId ? await db.findSession(sessionId) : null
}
```

</AppOnly>

### åœ¨ Next.js ä¸­é€‰æ‹©ä¼šè¯ç®¡ç†æ–¹æ¡ˆ

åœ¨ Next.js ä¸­é€‰æ‹©åŸºäº Cookie è¿˜æ˜¯ä¼šè¯æ•°æ®åº“ (database sessions) çš„æ–¹æ¡ˆå–å†³äºåº”ç”¨éœ€æ±‚ã€‚åŸºäº Cookie çš„ä¼šè¯æ›´ç®€å•ï¼Œé€‚åˆæœåŠ¡å™¨è´Ÿè½½è¾ƒä½çš„å°å‹åº”ç”¨ï¼Œä½†å®‰å…¨æ€§å¯èƒ½è¾ƒå¼±ã€‚ä¼šè¯æ•°æ®åº“æ–¹æ¡ˆè™½ç„¶æ›´å¤æ‚ï¼Œä½†èƒ½æä¾›æ›´å¥½çš„å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œæ˜¯æ•°æ®æ•æ„Ÿå‹å¤§å‹åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚

ä½¿ç”¨è¯¸å¦‚ [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5) è¿™æ ·çš„[è®¤è¯è§£å†³æ–¹æ¡ˆ](#examples)æ—¶ï¼Œæ— è®ºæ˜¯é‡‡ç”¨ Cookie è¿˜æ˜¯ä¼šè¯æ•°æ®åº“å­˜å‚¨ï¼Œä¼šè¯ç®¡ç†éƒ½ä¼šæ›´åŠ é«˜æ•ˆã€‚è¿™ç§è‡ªåŠ¨åŒ–ç®€åŒ–äº†å¼€å‘æµç¨‹ï¼Œä½†ç†è§£æ‰€é€‰è§£å†³æ–¹æ¡ˆä½¿ç”¨çš„ä¼šè¯ç®¡ç†æ–¹æ³•å¾ˆé‡è¦ã€‚è¯·ç¡®ä¿è¯¥æ–¹æ¡ˆç¬¦åˆæ‚¨åº”ç”¨çš„å®‰å…¨æ€§å’Œæ€§èƒ½è¦æ±‚ã€‚

æ— è®ºé€‰æ‹©å“ªç§æ–¹æ¡ˆï¼Œéƒ½åº”å°†ä¼šè¯ç®¡ç†ç­–ç•¥çš„å®‰å…¨æ€§æ”¾åœ¨é¦–ä½ã€‚å¯¹äºåŸºäº Cookie çš„ä¼šè¯ï¼Œä½¿ç”¨å®‰å…¨ä¸” HTTP-only çš„ Cookie å¯¹ä¿æŠ¤ä¼šè¯æ•°æ®è‡³å…³é‡è¦ã€‚å¯¹äºä¼šè¯æ•°æ®åº“æ–¹æ¡ˆï¼Œå®šæœŸå¤‡ä»½å’Œå®‰å…¨å¤„ç†ä¼šè¯æ•°æ®æ˜¯åŸºæœ¬è¦æ±‚ã€‚ä¸¤ç§æ–¹æ¡ˆéƒ½éœ€è¦å®ç°ä¼šè¯è¿‡æœŸå’Œæ¸…ç†æœºåˆ¶ï¼Œä»¥é˜²æ­¢æœªæˆæƒè®¿é—®å¹¶ä¿æŒåº”ç”¨çš„æ€§èƒ½å’Œå¯é æ€§ã€‚

## ç¤ºä¾‹

ä»¥ä¸‹æ˜¯å…¼å®¹ Next.js çš„è®¤è¯è§£å†³æ–¹æ¡ˆï¼Œè¯·å‚è€ƒä»¥ä¸‹å¿«é€Ÿå…¥é—¨æŒ‡å—äº†è§£å¦‚ä½•åœ¨ Next.js åº”ç”¨ä¸­é…ç½®å®ƒä»¬ï¼š

{/* TODO: æ–°æ–‡æ¡£å°±ç»ªåæ›´æ–°ä¸º authjs.dev é“¾æ¥ */}

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Lucia](https://lucia-auth.com/getting-started/nextjs-app)
- [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [Iron Session](https://github.com/vvo/iron-session)

## å»¶ä¼¸é˜…è¯»

è¦ç»§ç»­å­¦ä¹ è®¤è¯ä¸å®‰å…¨ç›¸å…³çŸ¥è¯†ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹èµ„æºï¼š

- [ç†è§£ XSS æ”»å‡»](https://vercel.com/guides/understanding-xss-attacks)
- [ç†è§£ CSRF æ”»å‡»](https://vercel.com/guides/understanding-csrf-attacks)
