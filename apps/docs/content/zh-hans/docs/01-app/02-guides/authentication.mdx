---
source-updated-at: 2025-06-08T05:18:05.000Z
translation-updated-at: 2025-06-08T20:51:04.872Z
title: å¦‚ä½•åœ¨ Next.js ä¸­å®ç°èº«ä»½éªŒè¯
nav_title: èº«ä»½éªŒè¯
description: å­¦ä¹ å¦‚ä½•åœ¨ Next.js åº”ç”¨ä¸­å®ç°èº«ä»½éªŒè¯åŠŸèƒ½
---

ç†è§£èº«ä»½éªŒè¯æœºåˆ¶å¯¹äºä¿æŠ¤åº”ç”¨æ•°æ®è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†æŒ‡å¯¼æ‚¨ä½¿ç”¨ React å’Œ Next.js ç‰¹æ€§æ¥å®ç°èº«ä»½éªŒè¯åŠŸèƒ½ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªè¿‡ç¨‹åˆ†è§£ä¸ºä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

1. **[èº«ä»½éªŒè¯ (Authentication)](#authentication)**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦ä¸å…¶å£°ç§°çš„èº«ä»½ä¸€è‡´ã€‚è¦æ±‚ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå¯†ç ç­‰å‡­è¯è¯æ˜èº«ä»½ã€‚
2. **[ä¼šè¯ç®¡ç† (Session Management)](#session-management)**ï¼šè·¨è¯·æ±‚è·Ÿè¸ªç”¨æˆ·çš„è®¤è¯çŠ¶æ€ã€‚
3. **[æˆæƒ (Authorization)](#authorization)**ï¼šå†³å®šç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›è·¯ç”±å’Œæ•°æ®ã€‚

ä¸‹å›¾å±•ç¤ºäº†ä½¿ç”¨ React å’Œ Next.js ç‰¹æ€§çš„èº«ä»½éªŒè¯æµç¨‹ï¼š

<Image
  alt="å±•ç¤ºä½¿ç”¨ React å’Œ Next.js ç‰¹æ€§çš„èº«ä»½éªŒè¯æµç¨‹å›¾"
  srcLight="/docs/light/authentication-overview.png"
  srcDark="/docs/dark/authentication-overview.png"
  width="1600"
  height="1383"
/>

æœ¬æ–‡ç¤ºä¾‹å°†æ¼”ç¤ºåŸºæœ¬çš„ç”¨æˆ·åå¯†ç éªŒè¯ï¼ˆå‡ºäºæ•™å­¦ç›®çš„ï¼‰ã€‚è™½ç„¶æ‚¨å¯ä»¥å®ç°è‡ªå®šä¹‰éªŒè¯æ–¹æ¡ˆï¼Œä½†ä¸ºäº†æ›´é«˜çš„å®‰å…¨æ€§å’Œç®€ä¾¿æ€§ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨èº«ä»½éªŒè¯åº“ã€‚è¿™äº›åº“æä¾›äº†å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬èº«ä»½éªŒè¯ã€ä¼šè¯ç®¡ç†ã€æˆæƒï¼Œä»¥åŠç¤¾äº¤ç™»å½•ã€å¤šå› ç´ è®¤è¯ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç­‰é™„åŠ åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨ [èº«ä»½éªŒè¯åº“](#auth-libraries) éƒ¨åˆ†æ‰¾åˆ°ç›¸å…³åˆ—è¡¨ã€‚

## èº«ä»½éªŒè¯

<AppOnly>

### æ³¨å†Œä¸ç™»å½•åŠŸèƒ½

æ‚¨å¯ä»¥ä½¿ç”¨ [`<form>`](https://react.dev/reference/react-dom/components/form) å…ƒç´ é…åˆ React çš„ [æœåŠ¡ç«¯æ“ä½œ (Server Actions)](/docs/app/building-your-application/data-fetching/server-actions-and-mutations) å’Œ `useActionState` æ¥æ•è·ç”¨æˆ·å‡­è¯ã€éªŒè¯è¡¨å•å­—æ®µå¹¶è°ƒç”¨èº«ä»½éªŒè¯æä¾›å•†çš„ API æˆ–æ•°æ®åº“ã€‚

ç”±äºæœåŠ¡ç«¯æ“ä½œå§‹ç»ˆåœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œè¿™ä¸ºå¤„ç†èº«ä»½éªŒè¯é€»è¾‘æä¾›äº†å®‰å…¨ç¯å¢ƒã€‚

ä»¥ä¸‹æ˜¯å®ç°æ³¨å†Œ/ç™»å½•åŠŸèƒ½çš„æ­¥éª¤ï¼š

#### 1. æ•è·ç”¨æˆ·å‡­è¯

åˆ›å»ºè¡¨å•å¹¶åœ¨æäº¤æ—¶è°ƒç”¨æœåŠ¡ç«¯æ“ä½œæ¥æ•è·ç”¨æˆ·å‡­è¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ¥æ”¶ç”¨æˆ·åã€é‚®ç®±å’Œå¯†ç çš„æ³¨å†Œè¡¨å•ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">å§“å</label>
        <input id="name" name="name" placeholder="å§“å" />
      </div>
      <div>
        <label htmlFor="email">é‚®ç®±</label>
        <input id="email" name="email" type="email" placeholder="é‚®ç®±" />
      </div>
      <div>
        <label htmlFor="password">å¯†ç </label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">æ³¨å†Œ</button>
    </form>
  )
}
```

```jsx filename="app/ui/signup-form.js" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">å§“å</label>
        <input id="name" name="name" placeholder="å§“å" />
      </div>
      <div>
        <label htmlFor="email">é‚®ç®±</label>
        <input id="email" name="email" type="email" placeholder="é‚®ç®±" />
      </div>
      <div>
        <label htmlFor="password">å¯†ç </label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">æ³¨å†Œ</button>
    </form>
  )
}
```

```tsx filename="app/actions/auth.ts" switcher
export async function signup(formData: FormData) {}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(formData) {}
```

#### 2. åœ¨æœåŠ¡ç«¯éªŒè¯è¡¨å•å­—æ®µ

ä½¿ç”¨æœåŠ¡ç«¯æ“ä½œåœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯è¡¨å•å­—æ®µã€‚å¦‚æœæ‚¨çš„èº«ä»½éªŒè¯æä¾›å•†ä¸æä¾›è¡¨å•éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨ [Zod](https://zod.dev/) æˆ– [Yup](https://github.com/jquense/yup) ç­‰æ¨¡å¼éªŒè¯åº“ã€‚

ä»¥ Zod ä¸ºä¾‹ï¼Œæ‚¨å¯ä»¥å®šä¹‰å¸¦æœ‰é”™è¯¯æç¤ºçš„è¡¨å•æ¨¡å¼ï¼š

```ts filename="app/lib/definitions.ts" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'å§“åé•¿åº¦è‡³å°‘ä¸º2ä¸ªå­—ç¬¦' })
    .trim(),
  email: z.string().email({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' }).trim(),
  password: z
    .string()
    .min(8, { message: 'é•¿åº¦è‡³å°‘ä¸º8ä¸ªå­—ç¬¦' })
    .regex(/[a-zA-Z]/, { message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯' })
    .regex(/[0-9]/, { message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªæ•°å­—' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦',
    })
    .trim(),
})

export type FormState =
  | {
      errors?: {
        name?: string[]
        email?: string[]
        password?: string[]
      }
      message?: string
    }
  | undefined
```

```js filename="app/lib/definitions.js" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'å§“åé•¿åº¦è‡³å°‘ä¸º2ä¸ªå­—ç¬¦' })
    .trim(),
  email: z.string().email({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' }).trim(),
  password: z
    .string()
    .min(8, { message: 'é•¿åº¦è‡³å°‘ä¸º8ä¸ªå­—ç¬¦' })
    .regex(/[a-zA-Z]/, { message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯' })
    .regex(/[0-9]/, { message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªæ•°å­—' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'è‡³å°‘åŒ…å«ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦',
    })
    .trim(),
})
```

ä¸ºé¿å…ä¸å¿…è¦çš„èº«ä»½éªŒè¯æä¾›å•† API æˆ–æ•°æ®åº“è°ƒç”¨ï¼Œå¦‚æœä»»ä½•è¡¨å•å­—æ®µä¸ç¬¦åˆå®šä¹‰çš„æ¨¡å¼ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯æ“ä½œä¸­æå‰ `return`ã€‚

```ts filename="app/actions/auth.ts" switcher
import { SignupFormSchema, FormState } from '@/app/lib/definitions'

export async function signup(state: FormState, formData: FormData) {
  // éªŒè¯è¡¨å•å­—æ®µ
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // å¦‚æœæœ‰å­—æ®µéªŒè¯å¤±è´¥ï¼Œæå‰è¿”å›
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // è°ƒç”¨æä¾›å•†æˆ–æ•°æ®åº“åˆ›å»ºç”¨æˆ·...
}
```

```js filename="app/actions/auth.js" switcher
import { SignupFormSchema } from '@/app/lib/definitions'

export async function signup(state, formData) {
  // éªŒè¯è¡¨å•å­—æ®µ
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // å¦‚æœæœ‰å­—æ®µéªŒè¯å¤±è´¥ï¼Œæå‰è¿”å›
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // è°ƒç”¨æä¾›å•†æˆ–æ•°æ®åº“åˆ›å»ºç”¨æˆ·...
}
```

å›åˆ° `<SignupForm />` ç»„ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ React çš„ `useActionState` é’©å­åœ¨è¡¨å•æäº¤æ—¶æ˜¾ç¤ºéªŒè¯é”™è¯¯ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher highlight={7,15,21,27-36}
'use client'

import { signup } from '@/app/actions/auth'
import { useActionState } from 'react'

export default function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">å§“å</label>
        <input id="name" name="name" placeholder="å§“å" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">é‚®ç®±</label>
        <input id="email" name="email" placeholder="é‚®ç®±" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">å¯†ç </label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>å¯†ç å¿…é¡»ï¼š</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button disabled={pending} type="submit">
        æ³¨å†Œ
      </button>
    </form>
  )
}
```

```jsx filename="app/ui/signup-form.js" switcher highlight={7,15,21,27-36}
'use client'

import { signup } from '@/app/actions/auth'
import { useActionState } from 'react'

export default function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">å§“å</label>
        <input id="name" name="name" placeholder="å§“å" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">é‚®ç®±</label>
        <input id="email" name="email" placeholder="é‚®ç®±" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">å¯†ç </label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>å¯†ç å¿…é¡»ï¼š</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button disabled={pending} type="submit">
        æ³¨å†Œ
      </button>
    </form>
  )
}
```

> **é¡»çŸ¥ï¼š**
>
> - åœ¨ React 19 ä¸­ï¼Œ`useFormStatus` è¿”å›å¯¹è±¡åŒ…å«é¢å¤–é”®å€¼ï¼Œå¦‚ dataã€method å’Œ actionã€‚å¦‚æœæœªä½¿ç”¨ React 19ï¼Œåˆ™ä»… `pending` é”®å¯ç”¨ã€‚
> - åœ¨ä¿®æ”¹æ•°æ®å‰ï¼Œåº”å§‹ç»ˆç¡®ä¿ç”¨æˆ·å·²è·å¾—æˆæƒã€‚å‚è§ [èº«ä»½éªŒè¯ä¸æˆæƒ](#authorization)ã€‚

#### 3. åˆ›å»ºç”¨æˆ·æˆ–éªŒè¯ç”¨æˆ·å‡­è¯

åœ¨éªŒè¯è¡¨å•å­—æ®µåï¼Œæ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨è®¤è¯æä¾›å•†çš„ API æˆ–æ•°æ®åº“æ¥åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·æˆ–æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚

å»¶ç»­ä¹‹å‰çš„ç¤ºä¾‹ï¼š

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(state: FormState, formData: FormData) {
  // 1. éªŒè¯è¡¨å•å­—æ®µ
  // ...

  // 2. å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®
  const { name, email, password } = validatedFields.data
  // ä¾‹å¦‚ï¼šåœ¨å­˜å‚¨å‰å¯¹ç”¨æˆ·å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. å°†ç”¨æˆ·æ’å…¥æ•°æ®åº“æˆ–è°ƒç”¨è®¤è¯åº“çš„ API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'åˆ›å»ºè´¦æˆ·æ—¶å‘ç”Ÿé”™è¯¯',
    }
  }

  // å¾…åŠäº‹é¡¹ï¼š
  // 4. åˆ›å»ºç”¨æˆ·ä¼šè¯
  // 5. é‡å®šå‘ç”¨æˆ·
}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(state, formData) {
  // 1. éªŒè¯è¡¨å•å­—æ®µ
  // ...

  // 2. å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®
  const { name, email, password } = validatedFields.data
  // ä¾‹å¦‚ï¼šåœ¨å­˜å‚¨å‰å¯¹ç”¨æˆ·å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. å°†ç”¨æˆ·æ’å…¥æ•°æ®åº“æˆ–è°ƒç”¨åº“ API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'åˆ›å»ºè´¦æˆ·æ—¶å‘ç”Ÿé”™è¯¯',
    }
  }

  // å¾…åŠäº‹é¡¹ï¼š
  // 4. åˆ›å»ºç”¨æˆ·ä¼šè¯
  // 5. é‡å®šå‘ç”¨æˆ·
}
```

æˆåŠŸåˆ›å»ºç”¨æˆ·è´¦æˆ·æˆ–éªŒè¯ç”¨æˆ·å‡­è¯åï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä¼šè¯æ¥ç®¡ç†ç”¨æˆ·çš„è®¤è¯çŠ¶æ€ã€‚æ ¹æ®ä¼šè¯ç®¡ç†ç­–ç•¥çš„ä¸åŒï¼Œä¼šè¯å¯ä»¥å­˜å‚¨åœ¨ cookie æˆ–æ•°æ®åº“ä¸­ï¼Œæˆ–ä¸¤è€…å…¼æœ‰ã€‚ç»§ç»­é˜…è¯»[ä¼šè¯ç®¡ç†](#session-management)éƒ¨åˆ†äº†è§£æ›´å¤šã€‚

> **æç¤ºï¼š**
>
> - ä¸Šé¢çš„ç¤ºä¾‹è¾ƒä¸ºè¯¦ç»†ï¼Œå› ä¸ºå®ƒä¸ºäº†æ•™è‚²ç›®çš„åˆ†è§£äº†è®¤è¯æ­¥éª¤ã€‚è¿™è¡¨æ˜å®ç°è‡ªå·±çš„å®‰å…¨è§£å†³æ–¹æ¡ˆå¯èƒ½å¾ˆå¿«å˜å¾—å¤æ‚ã€‚è€ƒè™‘ä½¿ç”¨[è®¤è¯åº“](#auth-libraries)æ¥ç®€åŒ–æµç¨‹ã€‚
> - ä¸ºäº†æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨æ³¨å†Œæµç¨‹çš„æ—©æœŸæ£€æŸ¥é‡å¤çš„ç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·è¾“å…¥ç”¨æˆ·åæˆ–è¾“å…¥å­—æ®µå¤±å»ç„¦ç‚¹æ—¶ã€‚è¿™å¯ä»¥å¸®åŠ©é˜²æ­¢ä¸å¿…è¦çš„è¡¨å•æäº¤ï¼Œå¹¶ä¸ºç”¨æˆ·æä¾›å³æ—¶åé¦ˆã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¯¸å¦‚ [use-debounce](https://www.npmjs.com/package/use-debounce) è¿™æ ·çš„åº“æ¥ç®¡ç†è¿™äº›æ£€æŸ¥çš„é¢‘ç‡ã€‚

</AppOnly>

<PagesOnly>

ä»¥ä¸‹æ˜¯å®ç°æ³¨å†Œå’Œ/æˆ–ç™»å½•è¡¨å•çš„æ­¥éª¤ï¼š

1. ç”¨æˆ·é€šè¿‡è¡¨å•æäº¤å…¶å‡­è¯ã€‚
2. è¡¨å•å‘é€ä¸€ä¸ªç”± API è·¯ç”±å¤„ç†çš„è¯·æ±‚ã€‚
3. éªŒè¯æˆåŠŸåï¼Œæµç¨‹å®Œæˆï¼Œè¡¨ç¤ºç”¨æˆ·å·²æˆåŠŸè®¤è¯ã€‚
4. å¦‚æœéªŒè¯å¤±è´¥ï¼Œåˆ™æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚

è€ƒè™‘ä¸€ä¸ªç”¨æˆ·å¯ä»¥è¾“å…¥å…¶å‡­è¯çš„ç™»å½•è¡¨å•ï¼š

```tsx filename="pages/login.tsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // å¤„ç†é”™è¯¯
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

```jsx filename="pages/login.jsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // å¤„ç†é”™è¯¯
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">ç™»å½•</button>
    </form>
  )
}
```

ä¸Šé¢çš„è¡¨å•æœ‰ä¸¤ä¸ªè¾“å…¥å­—æ®µï¼Œç”¨äºæ•è·ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œå¯†ç ã€‚æäº¤æ—¶ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ªå‡½æ•°ï¼Œå‘ API è·¯ç”± (`/api/auth/login`) å‘é€ POST è¯·æ±‚ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨ API è·¯ç”±ä¸­è°ƒç”¨è®¤è¯æä¾›å•†çš„ API æ¥å¤„ç†è®¤è¯ï¼š

```ts filename="pages/api/auth/login.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'æ— æ•ˆå‡­è¯' })
    } else {
      res.status(500).json({ error: 'å‘ç”Ÿé”™è¯¯' })
    }
  }
}
```

```js filename="pages/api/auth/login.js" switcher
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'æ— æ•ˆå‡­è¯' })
    } else {
      res.status(500).json({ error: 'å‘ç”Ÿé”™è¯¯' })
    }
  }
}
```

</PagesOnly>

## ä¼šè¯ç®¡ç†

ä¼šè¯ç®¡ç†ç¡®ä¿ç”¨æˆ·çš„è®¤è¯çŠ¶æ€åœ¨å¤šä¸ªè¯·æ±‚ä¹‹é—´ä¿æŒã€‚å®ƒæ¶‰åŠåˆ›å»ºã€å­˜å‚¨ã€åˆ·æ–°å’Œåˆ é™¤ä¼šè¯æˆ–ä»¤ç‰Œã€‚

æœ‰ä¸¤ç§ç±»å‹çš„ä¼šè¯ï¼š

1. [**æ— çŠ¶æ€ä¼šè¯**](#stateless-sessions)ï¼šä¼šè¯æ•°æ®ï¼ˆæˆ–ä»¤ç‰Œï¼‰å­˜å‚¨åœ¨æµè§ˆå™¨çš„ cookie ä¸­ã€‚cookie éšæ¯ä¸ªè¯·æ±‚å‘é€ï¼Œå…è®¸åœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯ä¼šè¯ã€‚è¿™ç§æ–¹æ³•æ›´ç®€å•ï¼Œä½†å¦‚æœå®ç°ä¸å½“å¯èƒ½ä¸å¤ªå®‰å…¨ã€‚
2. [**æ•°æ®åº“ä¼šè¯**](#database-sessions)ï¼šä¼šè¯æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç”¨æˆ·çš„æµè§ˆå™¨ä»…æ¥æ”¶åŠ å¯†çš„ä¼šè¯ IDã€‚è¿™ç§æ–¹æ³•æ›´å®‰å…¨ï¼Œä½†å¯èƒ½æ›´å¤æ‚å¹¶å ç”¨æ›´å¤šæœåŠ¡å™¨èµ„æºã€‚

> **é¡»çŸ¥ï¼š** è™½ç„¶æ‚¨å¯ä»¥ä½¿ç”¨å…¶ä¸­ä¸€ç§æ–¹æ³•æˆ–ä¸¤è€…å…¼ç”¨ï¼Œä½†æˆ‘ä»¬å»ºè®®ä½¿ç”¨ä¼šè¯ç®¡ç†åº“ï¼Œå¦‚ [iron-session](https://github.com/vvo/iron-session) æˆ– [Jose](https://github.com/panva/jose)ã€‚

### æ— çŠ¶æ€ä¼šè¯

<AppOnly>

è¦åˆ›å»ºå’Œç®¡ç†æ— çŠ¶æ€ä¼šè¯ï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. ç”Ÿæˆä¸€ä¸ªå¯†é’¥ï¼Œç”¨äºç­¾åä¼šè¯ï¼Œå¹¶å°†å…¶å­˜å‚¨ä¸º[ç¯å¢ƒå˜é‡](/docs/app/guides/environment-variables)ã€‚
2. ä½¿ç”¨ä¼šè¯ç®¡ç†åº“ç¼–å†™åŠ å¯†/è§£å¯†ä¼šè¯æ•°æ®çš„é€»è¾‘ã€‚
3. ä½¿ç”¨ Next.js [`cookies`](/docs/app/api-reference/functions/cookies) API ç®¡ç† cookieã€‚

é™¤äº†ä¸Šè¿°å†…å®¹ï¼Œè¿˜å¯ä»¥è€ƒè™‘æ·»åŠ åŠŸèƒ½ä»¥åœ¨ç”¨æˆ·è¿”å›åº”ç”¨ç¨‹åºæ—¶[æ›´æ–°ï¼ˆæˆ–åˆ·æ–°ï¼‰](#updating-or-refreshing-sessions)ä¼šè¯ï¼Œå¹¶åœ¨ç”¨æˆ·æ³¨é”€æ—¶[åˆ é™¤](#deleting-the-session)ä¼šè¯ã€‚

> **é¡»çŸ¥ï¼š** æ£€æŸ¥æ‚¨çš„[è®¤è¯åº“](#auth-libraries)æ˜¯å¦åŒ…å«ä¼šè¯ç®¡ç†ã€‚

#### 1. ç”Ÿæˆå¯†é’¥

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç”Ÿæˆç”¨äºç­¾åä¼šè¯çš„å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é€‰æ‹©åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ `openssl` å‘½ä»¤ï¼š

```bash filename="terminal"
openssl rand -base64 32
```

æ­¤å‘½ä»¤ç”Ÿæˆä¸€ä¸ª 32 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²ï¼Œæ‚¨å¯ä»¥ç”¨ä½œå¯†é’¥å¹¶å­˜å‚¨åœ¨[ç¯å¢ƒå˜é‡æ–‡ä»¶](/docs/app/guides/environment-variables)ä¸­ï¼š

```bash filename=".env"
SESSION_SECRET=your_secret_key
```

ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨ä¼šè¯ç®¡ç†é€»è¾‘ä¸­å¼•ç”¨æ­¤å¯†é’¥ï¼š

```js filename="app/lib/session.js"
const secretKey = process.env.SESSION_SECRET
```

#### 2. åŠ å¯†å’Œè§£å¯†ä¼šè¯

æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨é¦–é€‰çš„[ä¼šè¯ç®¡ç†åº“](#session-management-libraries)æ¥åŠ å¯†å’Œè§£å¯†ä¼šè¯ã€‚å»¶ç»­å‰é¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Jose](https://www.npmjs.com/package/jose)ï¼ˆä¸ [Edge Runtime](/docs/app/api-reference/edge) å…¼å®¹ï¼‰å’Œ React çš„ [`server-only`](https://www.npmjs.com/package/server-only) åŒ…ï¼Œä»¥ç¡®ä¿æ‚¨çš„ä¼šè¯ç®¡ç†é€»è¾‘ä»…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

```tsx filename="app/lib/session.ts" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'
import { SessionPayload } from '@/app/lib/definitions'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload: SessionPayload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session: string | undefined = '') {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('éªŒè¯ä¼šè¯å¤±è´¥')
  }
}
```

```jsx filename="app/lib/session.js" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session) {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('éªŒè¯ä¼šè¯å¤±è´¥')
  }
}
```

> **æç¤ºï¼š**
>
> - æœ‰æ•ˆè½½è·åº”åŒ…å«åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨çš„**æœ€å°**ã€å”¯ä¸€çš„ç”¨æˆ·æ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·çš„ IDã€è§’è‰²ç­‰ã€‚ä¸åº”åŒ…å«ä¸ªäººèº«ä»½ä¿¡æ¯ï¼Œå¦‚ç”µè¯å·ç ã€ç”µå­é‚®ä»¶åœ°å€ã€ä¿¡ç”¨å¡ä¿¡æ¯ç­‰ï¼Œæˆ–æ•æ„Ÿæ•°æ®å¦‚å¯†ç ã€‚

#### 3. è®¾ç½® cookieï¼ˆæ¨èé€‰é¡¹ï¼‰

è¦å°†ä¼šè¯å­˜å‚¨åœ¨ cookie ä¸­ï¼Œè¯·ä½¿ç”¨ Next.js [`cookies`](/docs/app/api-reference/functions/cookies) APIã€‚cookie åº”åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®ï¼Œå¹¶åŒ…æ‹¬ä»¥ä¸‹æ¨èé€‰é¡¹ï¼š

- **HttpOnly**ï¼šé˜²æ­¢å®¢æˆ·ç«¯ JavaScript è®¿é—® cookieã€‚
- **Secure**ï¼šä½¿ç”¨ https å‘é€ cookieã€‚
- **SameSite**ï¼šæŒ‡å®š cookie æ˜¯å¦å¯ä»¥ä¸è·¨ç«™ç‚¹è¯·æ±‚ä¸€èµ·å‘é€ã€‚
- **Max-Age æˆ– Expires**ï¼šåœ¨ä¸€å®šæ—¶é—´ååˆ é™¤ cookieã€‚
- **Path**ï¼šå®šä¹‰ cookie çš„ URL è·¯å¾„ã€‚

è¯·å‚é˜… [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) è·å–æœ‰å…³è¿™äº›é€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId: string) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })
  const cookieStore = await cookies()

  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })
  const cookieStore = await cookies()

  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

å›åˆ°æ‚¨çš„æœåŠ¡å™¨æ“ä½œä¸­ï¼Œæ‚¨å¯ä»¥è°ƒç”¨ `createSession()` å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ [`redirect()`](/docs/app/guides/redirecting) API å°†ç”¨æˆ·é‡å®šå‘åˆ°é€‚å½“çš„é¡µé¢ï¼š

```ts filename="app/actions/auth.ts" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state: FormState, formData: FormData) {
  // ä¹‹å‰çš„æ­¥éª¤ï¼š
  // 1. éªŒè¯è¡¨å•å­—æ®µ
  // 2. å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®
  // 3. å°†ç”¨æˆ·æ’å…¥æ•°æ®åº“æˆ–è°ƒç”¨åº“ API

  // å½“å‰æ­¥éª¤ï¼š
  // 4. åˆ›å»ºç”¨æˆ·ä¼šè¯
  await createSession(user.id)
  // 5. é‡å®šå‘ç”¨æˆ·
  redirect('/profile')
}
```

```js filename="app/actions/auth.js" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state, formData) {
  // ä¹‹å‰çš„æ­¥éª¤ï¼š
  // 1. éªŒè¯è¡¨å•å­—æ®µ
  // 2. å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®
  // 3. å°†ç”¨æˆ·æ’å…¥æ•°æ®åº“æˆ–è°ƒç”¨åº“ API

  // å½“å‰æ­¥éª¤ï¼š
  // 4. åˆ›å»ºç”¨æˆ·ä¼šè¯
  await createSession(user.id)
  // 5. é‡å®šå‘ç”¨æˆ·
  redirect('/profile')
}
```

> **æç¤ºï¼š**
>
> - **åº”åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½® cookie** ä»¥é˜²æ­¢å®¢æˆ·ç«¯ç¯¡æ”¹ã€‚
> - ğŸ¥ è§‚çœ‹ï¼šäº†è§£æ›´å¤šå…³äºæ— çŠ¶æ€ä¼šè¯å’Œ Next.js è®¤è¯çš„å†…å®¹ â†’ [YouTube (11 åˆ†é’Ÿ)](https://www.youtube.com/watch?v=DJvM2lSPn6w)ã€‚

#### æ›´æ–°ï¼ˆæˆ–åˆ·æ–°ï¼‰ä¼šè¯

æ‚¨è¿˜å¯ä»¥å»¶é•¿ä¼šè¯çš„è¿‡æœŸæ—¶é—´ã€‚è¿™å¯¹äºåœ¨ç”¨æˆ·å†æ¬¡è®¿é—®åº”ç”¨ç¨‹åºæ—¶ä¿æŒå…¶ç™»å½•çŠ¶æ€éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼š

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)(
    await cookies()
  ).set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

> **æç¤ºï¼š** æ£€æŸ¥æ‚¨çš„è®¤è¯åº“æ˜¯å¦æ”¯æŒåˆ·æ–°ä»¤ç‰Œï¼Œå¯ç”¨äºå»¶é•¿ç”¨æˆ·çš„ä¼šè¯ã€‚

#### åˆ é™¤ä¼šè¯

è¦åˆ é™¤ä¼šè¯ï¼Œå¯ä»¥åˆ é™¤å¯¹åº”çš„ cookieï¼š

```ts filename="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

```js filename="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

ç„¶åå¯ä»¥åœ¨åº”ç”¨ä¸­å¤ç”¨ `deleteSession()` å‡½æ•°ï¼Œä¾‹å¦‚åœ¨ç™»å‡ºæ—¶ï¼š

```ts filename="app/actions/auth.ts" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  await deleteSession()
  redirect('/login')
}
```

```js filename="app/actions/auth.js" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  await deleteSession()
  redirect('/login')
}
```

</AppOnly>

<PagesOnly>

#### è®¾ç½®å’Œåˆ é™¤ Cookie

å¯ä»¥ä½¿ç”¨ [API è·¯ç”±](/docs/pages/building-your-application/routing/api-routes) åœ¨æœåŠ¡ç«¯å°†ä¼šè¯è®¾ç½®ä¸º cookieï¼š

```ts filename="pages/api/login.ts" switcher
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'
import { encrypt } from '@/app/lib/session'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'Successfully set cookie!' })
}
```

```js filename="pages/api/login.js" switcher
import { serialize } from 'cookie'
import { encrypt } from '@/app/lib/session'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // ä¸€å‘¨
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'Successfully set cookie!' })
}
```

</PagesOnly>

### æ•°æ®åº“ä¼šè¯

è¦åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“ä¼šè¯ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¡¨æ¥å­˜å‚¨ä¼šè¯æ•°æ®ï¼ˆæˆ–æ£€æŸ¥æ‚¨çš„è®¤è¯åº“æ˜¯å¦å·²å¤„ç†æ­¤åŠŸèƒ½ï¼‰
2. å®ç°æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ä¼šè¯çš„åŠŸèƒ½
3. å°†ä¼šè¯ ID åŠ å¯†åå†å­˜å‚¨åˆ°ç”¨æˆ·æµè§ˆå™¨ä¸­ï¼Œå¹¶ç¡®ä¿æ•°æ®åº“å’Œ cookie ä¿æŒåŒæ­¥ï¼ˆè¿™æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®ç”¨äº [ä¸­é—´ä»¶](#optimistic-checks-with-middleware-optional) ä¸­çš„ä¹è§‚è®¤è¯æ£€æŸ¥ï¼‰

<AppOnly>

ä¾‹å¦‚ï¼š

```ts filename="app/lib/session.ts" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id: number) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¼šè¯
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // è¿”å›ä¼šè¯ ID
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. åŠ å¯†ä¼šè¯ ID
  const session = await encrypt({ sessionId, expiresAt })

  // 3. å°†ä¼šè¯å­˜å‚¨åœ¨ cookie ä¸­ä»¥è¿›è¡Œä¹è§‚è®¤è¯æ£€æŸ¥
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

```js filename="app/lib/session.js" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¼šè¯
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // è¿”å›ä¼šè¯ ID
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. åŠ å¯†ä¼šè¯ ID
  const session = await encrypt({ sessionId, expiresAt })

  // 3. å°†ä¼šè¯å­˜å‚¨åœ¨ cookie ä¸­ä»¥è¿›è¡Œä¹è§‚è®¤è¯æ£€æŸ¥
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

> **æç¤º**ï¼š
>
> - ä¸ºäº†æ›´å¿«è®¿é—®ï¼Œå¯ä»¥è€ƒè™‘ä¸ºä¼šè¯ç”Ÿå‘½å‘¨æœŸæ·»åŠ æœåŠ¡å™¨ç¼“å­˜ã€‚ä¹Ÿå¯ä»¥å°†ä¼šè¯æ•°æ®ä¿ç•™åœ¨ä¸»æ•°æ®åº“ä¸­ï¼Œå¹¶åˆå¹¶æ•°æ®è¯·æ±‚ä»¥å‡å°‘æŸ¥è¯¢æ¬¡æ•°
> - å¯¹äºæ›´é«˜çº§çš„ç”¨ä¾‹ï¼ˆå¦‚è·Ÿè¸ªç”¨æˆ·ä¸Šæ¬¡ç™»å½•æ—¶é—´ã€æ´»è·ƒè®¾å¤‡æ•°é‡æˆ–è®©ç”¨æˆ·èƒ½å¤Ÿæ³¨é”€æ‰€æœ‰è®¾å¤‡ï¼‰ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨æ•°æ®åº“ä¼šè¯

å®ç°ä¼šè¯ç®¡ç†åï¼Œéœ€è¦æ·»åŠ æˆæƒé€»è¾‘æ¥æ§åˆ¶ç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ä¸­è®¿é—®å’Œæ‰§è¡Œçš„å†…å®¹ã€‚ç»§ç»­é˜…è¯» [æˆæƒ](#authorization) éƒ¨åˆ†äº†è§£æ›´å¤šã€‚

</AppOnly>

<PagesOnly>

**åœ¨æœåŠ¡ç«¯åˆ›å»ºä¼šè¯**ï¼š

```ts filename="pages/api/create-session.ts" switcher
import db from '../../lib/db'
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

```js filename="pages/api/create-session.js" switcher
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

</PagesOnly>

## æˆæƒ

ç”¨æˆ·è®¤è¯å¹¶åˆ›å»ºä¼šè¯åï¼Œå¯ä»¥å®ç°æˆæƒæ¥æ§åˆ¶ç”¨æˆ·åœ¨åº”ç”¨ä¸­å¯ä»¥è®¿é—®å’Œæ‰§è¡Œçš„å†…å®¹ã€‚

ä¸»è¦æœ‰ä¸¤ç§æˆæƒæ£€æŸ¥ç±»å‹ï¼š

1. **ä¹è§‚æ£€æŸ¥**ï¼šä½¿ç”¨å­˜å‚¨åœ¨ cookie ä¸­çš„ä¼šè¯æ•°æ®æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è·¯ç”±æˆ–æ‰§è¡Œæ“ä½œã€‚è¿™äº›æ£€æŸ¥é€‚ç”¨äºå¿«é€Ÿæ“ä½œï¼Œå¦‚æ˜¾ç¤º/éšè— UI å…ƒç´ æˆ–æ ¹æ®æƒé™æˆ–è§’è‰²é‡å®šå‘ç”¨æˆ·
2. **å®‰å…¨æ£€æŸ¥**ï¼šä½¿ç”¨å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¼šè¯æ•°æ®æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è·¯ç”±æˆ–æ‰§è¡Œæ“ä½œã€‚è¿™äº›æ£€æŸ¥æ›´å®‰å…¨ï¼Œç”¨äºéœ€è¦è®¿é—®æ•æ„Ÿæ•°æ®æˆ–æ“ä½œçš„æƒ…å†µ

å¯¹äºè¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å»ºè®®ï¼š

- åˆ›å»º [æ•°æ®è®¿é—®å±‚ (DAL)](#creating-a-data-access-layer-dal) æ¥é›†ä¸­æˆæƒé€»è¾‘
- ä½¿ç”¨ [æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)](#using-data-transfer-objects-dto) ä»…è¿”å›å¿…è¦çš„æ•°æ®
- å¯é€‰ä½¿ç”¨ [ä¸­é—´ä»¶](#optimistic-checks-with-middleware-optional) æ‰§è¡Œä¹è§‚æ£€æŸ¥

### ä½¿ç”¨ä¸­é—´ä»¶è¿›è¡Œä¹è§‚æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨ [ä¸­é—´ä»¶](/docs/app/building-your-application/routing/middleware) å¹¶æ ¹æ®æƒé™é‡å®šå‘ç”¨æˆ·ï¼š

- æ‰§è¡Œä¹è§‚æ£€æŸ¥ã€‚ç”±äºä¸­é—´ä»¶åœ¨æ¯ä¸ªè·¯ç”±ä¸Šè¿è¡Œï¼Œè¿™æ˜¯é›†ä¸­é‡å®šå‘é€»è¾‘å’Œé¢„è¿‡æ»¤æœªæˆæƒç”¨æˆ·çš„å¥½æ–¹æ³•
- ä¿æŠ¤ç”¨æˆ·ä¹‹é—´å…±äº«æ•°æ®çš„é™æ€è·¯ç”±ï¼ˆå¦‚ä»˜è´¹å†…å®¹ï¼‰

ä½†ç”±äºä¸­é—´ä»¶åœ¨æ¯ä¸ªè·¯ç”±ä¸Šè¿è¡Œï¼ˆåŒ…æ‹¬ [é¢„å–](/docs/app/getting-started/linking-and-navigating#prefetching) çš„è·¯ç”±ï¼‰ï¼Œé‡è¦çš„æ˜¯ä»…ä» cookie è¯»å–ä¼šè¯ï¼ˆä¹è§‚æ£€æŸ¥ï¼‰ï¼Œé¿å…æ•°æ®åº“æ£€æŸ¥ä»¥é˜²æ­¢æ€§èƒ½é—®é¢˜ã€‚

ä¾‹å¦‚ï¼š

```tsx filename="middleware.ts" switcher
import { NextRequest, NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. æŒ‡å®šå—ä¿æŠ¤å’Œå…¬å¼€è·¯ç”±
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req: NextRequest) {
  // 2. æ£€æŸ¥å½“å‰è·¯ç”±æ˜¯å—ä¿æŠ¤è¿˜æ˜¯å…¬å¼€
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. ä» cookie è§£å¯†ä¼šè¯
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 4. å¦‚æœç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ° /login
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 5. å¦‚æœç”¨æˆ·å·²è®¤è¯ï¼Œé‡å®šå‘åˆ° /dashboard
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ä¸­é—´ä»¶ä¸åº”è¿è¡Œçš„è·¯ç”±
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

```js filename="middleware.js" switcher
import { NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. æŒ‡å®šå—ä¿æŠ¤å’Œå…¬å¼€è·¯ç”±
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req) {
  // 2. æ£€æŸ¥å½“å‰è·¯ç”±æ˜¯å—ä¿æŠ¤è¿˜æ˜¯å…¬å¼€
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. ä» cookie è§£å¯†ä¼šè¯
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 5. å¦‚æœç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ° /login
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 6. å¦‚æœç”¨æˆ·å·²è®¤è¯ï¼Œé‡å®šå‘åˆ° /dashboard
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ä¸­é—´ä»¶ä¸åº”è¿è¡Œçš„è·¯ç”±
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

è™½ç„¶ä¸­é—´ä»¶å¯¹åˆå§‹æ£€æŸ¥å¾ˆæœ‰ç”¨ï¼Œä½†å®ƒä¸åº”è¯¥æ˜¯ä¿æŠ¤æ•°æ®çš„å”¯ä¸€é˜²çº¿ã€‚å¤§å¤šæ•°å®‰å…¨æ£€æŸ¥åº”å°½å¯èƒ½é è¿‘æ•°æ®æºæ‰§è¡Œï¼Œè¯¦è§ [æ•°æ®è®¿é—®å±‚](#creating-a-data-access-layer-dal)ã€‚

> **æç¤º**ï¼š
>
> - åœ¨ä¸­é—´ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `req.cookies.get('session').value` è¯»å– cookie
> - ä¸­é—´ä»¶ä½¿ç”¨ [Edge è¿è¡Œæ—¶](/docs/app/api-reference/edge)ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è®¤è¯åº“å’Œä¼šè¯ç®¡ç†åº“æ˜¯å¦å…¼å®¹
> - å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶ä¸­çš„ `matcher` å±æ€§æŒ‡å®šä¸­é—´ä»¶åº”è¿è¡Œçš„è·¯ç”±ã€‚ä½†å¯¹äºè®¤è¯ï¼Œå»ºè®®ä¸­é—´ä»¶åœ¨æ‰€æœ‰è·¯ç”±ä¸Šè¿è¡Œ

<AppOnly>

### åˆ›å»ºæ•°æ®è®¿é—®å±‚ (DAL)

æˆ‘ä»¬å»ºè®®åˆ›å»º DAL æ¥é›†ä¸­æ•°æ®è¯·æ±‚å’Œæˆæƒé€»è¾‘ã€‚

DAL åº”åŒ…å«ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ç”¨æˆ·ä¸åº”ç”¨äº¤äº’æ—¶éªŒè¯ç”¨æˆ·çš„ä¼šè¯ã€‚è‡³å°‘ï¼Œè¯¥å‡½æ•°åº”æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆï¼Œç„¶åé‡å®šå‘æˆ–è¿”å›è¿›è¡Œè¿›ä¸€æ­¥è¯·æ±‚æ‰€éœ€çš„ç”¨æˆ·ä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼Œä¸º DAL åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« `verifySession()` å‡½æ•°ã€‚ç„¶åä½¿ç”¨ React çš„ [cache](https://react.dev/reference/react/cache) API åœ¨ React æ¸²æŸ“è¿‡ç¨‹ä¸­è®°å¿†åŒ–å‡½æ•°çš„è¿”å›å€¼ï¼š

```tsx filename="app/lib/dal.ts" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session?.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

```js filename="app/lib/dal.js" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

ç„¶åå¯ä»¥åœ¨æ•°æ®è¯·æ±‚ã€æœåŠ¡å™¨æ“ä½œã€è·¯ç”±å¤„ç†ç¨‹åºä¸­è°ƒç”¨ `verifySession()` å‡½æ•°ï¼š

```tsx filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // æ˜ç¡®è¿”å›æ‰€éœ€çš„åˆ—è€Œä¸æ˜¯æ•´ä¸ªç”¨æˆ·å¯¹è±¡
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('Failed to fetch user')
    return null
  }
})
```

```jsx filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // æ˜ç¡®è¿”å›æ‰€éœ€çš„åˆ—è€Œä¸æ˜¯æ•´ä¸ªç”¨æˆ·å¯¹è±¡
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('Failed to fetch user')
    return null
  }
})
```

> **æç¤º**ï¼š
>
> - DAL å¯ç”¨äºä¿æŠ¤è¯·æ±‚æ—¶è·å–çš„æ•°æ®ã€‚ä½†å¯¹äºç”¨æˆ·ä¹‹é—´å…±äº«æ•°æ®çš„é™æ€è·¯ç”±ï¼Œæ•°æ®å°†åœ¨æ„å»ºæ—¶è·å–è€Œä¸æ˜¯è¯·æ±‚æ—¶è·å–ã€‚ä½¿ç”¨ [ä¸­é—´ä»¶](#optimistic-checks-with-middleware-optional) ä¿æŠ¤é™æ€è·¯ç”±
> - å¯¹äºå®‰å…¨æ£€æŸ¥ï¼Œå¯ä»¥é€šè¿‡å°†ä¼šè¯ ID ä¸æ•°æ®åº“è¿›è¡Œæ¯”è¾ƒæ¥æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆã€‚ä½¿ç”¨ React çš„ [cache](https://react.dev/reference/react/cache) å‡½æ•°é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å¯¹æ•°æ®åº“è¿›è¡Œä¸å¿…è¦çš„é‡å¤è¯·æ±‚
> - æ‚¨å¯èƒ½å¸Œæœ›å°†ç›¸å…³æ•°æ®è¯·æ±‚åˆå¹¶åˆ°ä¸€ä¸ª JavaScript ç±»ä¸­ï¼Œè¯¥ç±»åœ¨ä»»ä½•æ–¹æ³•ä¹‹å‰è¿è¡Œ `verifySession()`

### ä½¿ç”¨æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)

åœ¨è·å–æ•°æ®æ—¶ï¼Œå»ºè®®åªè¿”å›åº”ç”¨ç¨‹åºä¸­éœ€è¦ä½¿ç”¨çš„å¿…è¦æ•°æ®ï¼Œè€Œéæ•´ä¸ªå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå½“è·å–ç”¨æˆ·æ•°æ®æ—¶ï¼Œå¯ä»¥ä»…è¿”å›ç”¨æˆ·IDå’Œå§“åï¼Œè€Œä¸æ˜¯åŒ…å«å¯†ç ã€ç”µè¯å·ç ç­‰æ•æ„Ÿä¿¡æ¯çš„å®Œæ•´ç”¨æˆ·å¯¹è±¡ã€‚

è‹¥æ‚¨æ— æ³•æ§åˆ¶è¿”å›çš„æ•°æ®ç»“æ„ï¼Œæˆ–éœ€è¦é¿å…å°†å®Œæ•´å¯¹è±¡ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼ˆå¦‚åœ¨å›¢é˜Ÿåä½œä¸­ï¼‰ï¼Œå¯ä»¥é‡‡ç”¨æŒ‡å®šå®‰å…¨å­—æ®µæš´éœ²ç»™å®¢æˆ·ç«¯çš„ç­–ç•¥ã€‚

```tsx filename="app/lib/dto.ts" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer: User) {
  return true
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug: string) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // åœ¨æ­¤å¤„è¿”å›ç‰¹å®šåˆ—
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // æˆ–åœ¨æ­¤å¤„ä»…è¿”å›æŸ¥è¯¢æ‰€éœ€çš„ç‰¹å®šå­—æ®µ
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

```js filename="app/lib/dto.js" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer) {
  return true
}

function canSeePhoneNumber(viewer, team) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // åœ¨æ­¤å¤„è¿”å›ç‰¹å®šåˆ—
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // æˆ–åœ¨æ­¤å¤„ä»…è¿”å›æŸ¥è¯¢æ‰€éœ€çš„ç‰¹å®šå­—æ®µ
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

é€šè¿‡åœ¨æ•°æ®è®¿é—®å±‚ (DAL) é›†ä¸­ç®¡ç†æ•°æ®è¯·æ±‚å’Œæˆæƒé€»è¾‘ï¼Œå¹¶ä½¿ç”¨ DTOï¼Œå¯ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®è¯·æ±‚çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œä»è€Œæ›´æ˜“äºç»´æŠ¤ã€å®¡è®¡å’Œè°ƒè¯•åº”ç”¨ç¨‹åºã€‚

> **é¡»çŸ¥**:
>
> - å®šä¹‰ DTO æœ‰å¤šç§æ–¹å¼ï¼ŒåŒ…æ‹¬ä½¿ç”¨ `toJSON()`ã€å¦‚ç¤ºä¾‹ä¸­çš„ç‹¬ç«‹å‡½æ•°æˆ– JavaScript ç±»ã€‚ç”±äºè¿™äº›æ˜¯ JavaScript æ¨¡å¼è€Œé React æˆ– Next.js ç‰¹æ€§ï¼Œå»ºè®®æ‚¨ç ”ç©¶æœ€é€‚åˆåº”ç”¨ç¨‹åºçš„æ¨¡å¼ã€‚
> - äº†è§£æ›´å¤šå®‰å…¨æœ€ä½³å®è·µï¼Œè¯·å‚é˜… [Next.js å®‰å…¨æ–‡ç« ](/blog/security-nextjs-server-components-actions)ã€‚

### æœåŠ¡ç«¯ç»„ä»¶

åœ¨[æœåŠ¡ç«¯ç»„ä»¶](/docs/app/getting-started/server-and-client-components)ä¸­è¿›è¡Œæƒé™æ£€æŸ¥é€‚ç”¨äºåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²æ¡ä»¶æ¸²æŸ“ç»„ä»¶ï¼š

```tsx filename="app/dashboard/page.tsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session?.user?.role // å‡è®¾ 'role' æ˜¯ä¼šè¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session.role // å‡è®¾ 'role' æ˜¯ä¼šè¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°æ®è®¿é—®å±‚ä¸­çš„ `verifySession()` å‡½æ•°æ£€æŸ¥ 'admin'ã€'user' å’Œæœªæˆæƒè§’è‰²ã€‚è¿™ç§æ¨¡å¼ç¡®ä¿æ¯ä¸ªç”¨æˆ·ä»…ä¸é€‚åˆå…¶è§’è‰²çš„ç»„ä»¶äº¤äº’ã€‚

### å¸ƒå±€ä¸æƒé™æ£€æŸ¥

ç”±äº[éƒ¨åˆ†æ¸²æŸ“](/docs/app/getting-started/linking-and-navigating#client-side-transitions)ï¼Œåœ¨[å¸ƒå±€](/docs/app/api-reference/file-conventions/layout)ä¸­è¿›è¡Œæ£€æŸ¥æ—¶éœ€è°¨æ…ï¼Œå› ä¸ºè¿™äº›æ£€æŸ¥ä¸ä¼šåœ¨å¯¼èˆªæ—¶é‡æ–°æ¸²æŸ“ï¼Œæ„å‘³ç€ç”¨æˆ·ä¼šè¯ä¸ä¼šåœ¨æ¯æ¬¡è·¯ç”±å˜æ›´æ—¶è¢«æ£€æŸ¥ã€‚

ç›¸åï¼Œåº”åœ¨æ•°æ®æºé™„è¿‘æˆ–æ¡ä»¶æ¸²æŸ“çš„ç»„ä»¶ä¸­è¿›è¡Œæ£€æŸ¥ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªå…±äº«å¸ƒå±€ï¼Œå®ƒè·å–ç”¨æˆ·æ•°æ®å¹¶åœ¨å¯¼èˆªä¸­æ˜¾ç¤ºç”¨æˆ·å›¾åƒã€‚ä¸åº”åœ¨å¸ƒå±€ä¸­è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œè€Œåº”åœ¨å¸ƒå±€ä¸­è·å–ç”¨æˆ·æ•°æ® (`getUser()`)ï¼Œå¹¶åœ¨æ•°æ®è®¿é—®å±‚ä¸­è¿›è¡Œæƒé™æ£€æŸ¥ã€‚

è¿™ç¡®ä¿æ— è®ºä½•æ—¶åœ¨åº”ç”¨ç¨‹åºä¸­è°ƒç”¨ `getUser()`ï¼Œéƒ½ä¼šæ‰§è¡Œæƒé™æ£€æŸ¥ï¼Œé˜²æ­¢å¼€å‘äººå‘˜å¿˜è®°æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æ•°æ®ã€‚

```tsx filename="app/layout.tsx" switcher
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```jsx filename="app/layout.js" switcher
export default async function Layout({ children }) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```ts filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // ä»ä¼šè¯ä¸­è·å–ç”¨æˆ·IDå¹¶è·å–æ•°æ®
})
```

```js filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // ä»ä¼šè¯ä¸­è·å–ç”¨æˆ·IDå¹¶è·å–æ•°æ®
})
```

> **é¡»çŸ¥:**
>
> - åœ¨å•é¡µåº”ç”¨ (SPA) ä¸­ï¼Œå¸¸è§çš„æ¨¡å¼æ˜¯åœ¨å¸ƒå±€æˆ–é¡¶çº§ç»„ä»¶ä¸­ `return null` å¦‚æœç”¨æˆ·æœªæˆæƒã€‚è¿™ç§æ¨¡å¼**ä¸æ¨è**ï¼Œå› ä¸º Next.js åº”ç”¨ç¨‹åºæœ‰å¤šä¸ªå…¥å£ç‚¹ï¼Œæ— æ³•é˜»æ­¢åµŒå¥—è·¯ç”±æ®µå’ŒæœåŠ¡ç«¯æ“ä½œè¢«è®¿é—®ã€‚

### æœåŠ¡ç«¯æ“ä½œ

å°†[æœåŠ¡ç«¯æ“ä½œ](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)è§†ä¸ºä¸é¢å‘å…¬ä¼—çš„ API ç«¯ç‚¹ç›¸åŒçš„å®‰å…¨è€ƒè™‘ï¼Œå¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦è¢«å…è®¸æ‰§è¡Œå˜æ›´ã€‚

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å…è®¸æ“ä½œç»§ç»­ä¹‹å‰æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ï¼š

```ts filename="app/lib/actions.ts" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction(formData: FormData) {
  const session = await verifySession()
  const userRole = session?.user?.role

  // å¦‚æœç”¨æˆ·æœªæˆæƒæ‰§è¡Œæ“ä½œï¼Œåˆ™æå‰è¿”å›
  if (userRole !== 'admin') {
    return null
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œæ“ä½œ
}
```

```js filename="app/lib/actions.js" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction() {
  const session = await verifySession()
  const userRole = session.user.role

  // å¦‚æœç”¨æˆ·æœªæˆæƒæ‰§è¡Œæ“ä½œï¼Œåˆ™æå‰è¿”å›
  if (userRole !== 'admin') {
    return null
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œæ“ä½œ
}
```

### è·¯ç”±å¤„ç†å™¨

å°†[è·¯ç”±å¤„ç†å™¨](/docs/app/building-your-application/routing/route-handlers)è§†ä¸ºä¸é¢å‘å…¬ä¼—çš„ API ç«¯ç‚¹ç›¸åŒçš„å®‰å…¨è€ƒè™‘ï¼Œå¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦è¢«å…è®¸è®¿é—®è·¯ç”±å¤„ç†å™¨ã€‚

ä¾‹å¦‚ï¼š

```ts filename="app/api/route.ts" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ç”¨æˆ·è®¤è¯å’Œè§’è‰²éªŒè¯
  const session = await verifySession()

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    // ç”¨æˆ·æœªè®¤è¯
    return new Response(null, { status: 401 })
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    // ç”¨æˆ·å·²è®¤è¯ä½†æ²¡æœ‰æ­£ç¡®æƒé™
    return new Response(null, { status: 403 })
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œ
}
```

```js filename="app/api/route.js" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ç”¨æˆ·è®¤è¯å’Œè§’è‰²éªŒè¯
  const session = await verifySession()

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    // ç”¨æˆ·æœªè®¤è¯
    return new Response(null, { status: 401 })
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    // ç”¨æˆ·å·²è®¤è¯ä½†æ²¡æœ‰æ­£ç¡®æƒé™
    return new Response(null, { status: 403 })
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œ
}
```

ä¸Šè¿°ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå…·æœ‰ä¸¤å±‚å®‰å…¨æ£€æŸ¥çš„è·¯ç”±å¤„ç†å™¨ã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ´»åŠ¨ä¼šè¯ï¼Œç„¶åéªŒè¯ç™»å½•ç”¨æˆ·æ˜¯å¦ä¸º 'admin'ã€‚

## ä¸Šä¸‹æ–‡æä¾›è€…

ç”±äº[äº¤é”™æ¸²æŸ“](/docs/app/getting-started/server-and-client-components#examples#interleaving-server-and-client-components)ï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡æä¾›è€…è¿›è¡Œè®¤è¯æ˜¯å¯è¡Œçš„ã€‚ç„¶è€Œï¼ŒReact `context` åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­ä¸å—æ”¯æŒï¼Œå› æ­¤ä»…é€‚ç”¨äºå®¢æˆ·ç«¯ç»„ä»¶ã€‚

è¿™ç§æ–¹å¼æœ‰æ•ˆï¼Œä½†ä»»ä½•å­æœåŠ¡ç«¯ç»„ä»¶å°†é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ï¼Œå¹¶ä¸”æ— æ³•è®¿é—®ä¸Šä¸‹æ–‡æä¾›è€…çš„ä¼šè¯æ•°æ®ï¼š

```tsx filename="app/layout.ts" switcher
import { ContextProvider } from 'auth-lib'

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <ContextProvider>{children}</ContextProvider>
      </body>
    </html>
  )
}
```

```tsx filename="app/ui/profile.ts switcher
'use client';

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

```jsx filename="app/ui/profile.js switcher
'use client';

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

å¦‚æœå®¢æˆ·ç«¯ç»„ä»¶éœ€è¦ä¼šè¯æ•°æ®ï¼ˆä¾‹å¦‚ç”¨äºå®¢æˆ·ç«¯æ•°æ®è·å–ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ React çš„ [`taintUniqueValue`](https://react.dev/reference/react/experimental_taintUniqueValue) API é˜²æ­¢æ•æ„Ÿä¼šè¯æ•°æ®æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

</AppOnly>

<PagesOnly>

### åˆ›å»ºæ•°æ®è®¿é—®å±‚ (DAL)

#### ä¿æŠ¤ API è·¯ç”±

Next.js ä¸­çš„ API è·¯ç”±å¯¹äºå¤„ç†æœåŠ¡å™¨ç«¯é€»è¾‘å’Œæ•°æ®ç®¡ç†è‡³å…³é‡è¦ã€‚å¿…é¡»ä¿æŠ¤è¿™äº›è·¯ç”±ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è®¿é—®ç‰¹å®šåŠŸèƒ½ã€‚è¿™é€šå¸¸æ¶‰åŠéªŒè¯ç”¨æˆ·çš„è®¤è¯çŠ¶æ€å’ŒåŸºäºè§’è‰²çš„æƒé™ã€‚

ä»¥ä¸‹æ˜¯ä¿æŠ¤ API è·¯ç”±çš„ç¤ºä¾‹ï¼š

```ts filename="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    res.status(401).json({
      error: 'ç”¨æˆ·æœªè®¤è¯',
    })
    return
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™ã€‚',
    })
    return
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å®ç°
}
```

```js filename="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req)

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
  if (!session) {
    res.status(401).json({
      error: 'ç”¨æˆ·æœªè®¤è¯',
    })
    return
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ 'admin' è§’è‰²
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªç»æˆæƒçš„è®¿é—®ï¼šç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™ã€‚',
    })
    return
  }

  // ä¸ºæˆæƒç”¨æˆ·ç»§ç»­æ‰§è¡Œè·¯ç”±
  // ... API è·¯ç”±çš„å®ç°
}
```

æ­¤ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå…·æœ‰ä¸¤å±‚å®‰å…¨æ£€æŸ¥çš„ API è·¯ç”±ï¼Œç”¨äºè®¤è¯å’Œæˆæƒã€‚å®ƒé¦–å…ˆæ£€æŸ¥æ´»åŠ¨ä¼šè¯ï¼Œç„¶åéªŒè¯ç™»å½•ç”¨æˆ·æ˜¯å¦ä¸º 'admin'ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿ä»…é™è®¤è¯å’Œæˆæƒç”¨æˆ·å®‰å…¨è®¿é—®ï¼Œä¿æŒè¯·æ±‚å¤„ç†çš„å¼ºå¤§å®‰å…¨æ€§ã€‚

</PagesOnly>

## èµ„æº

ç°åœ¨æ‚¨å·²äº†è§£ Next.js ä¸­çš„è®¤è¯ï¼Œä»¥ä¸‹æ˜¯å¸®åŠ©æ‚¨å®ç°å®‰å…¨è®¤è¯å’Œä¼šè¯ç®¡ç†çš„ Next.js å…¼å®¹åº“å’Œèµ„æºï¼š

### è®¤è¯åº“

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Better Auth](https://www.better-auth.com/docs/integrations/next)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Logto](https://docs.logto.io/quick-starts/next-app-router)
- [NextAuth.js](https://authjs.dev/getting-started/installation?framework=next.js)
- [Ory](https://www.ory.sh/docs/getting-started/integrate-auth/nextjs)
- [Stack Auth](https://docs.stack-auth.com/getting-started/setup)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [WorkOS](https://workos.com/docs/user-management/nextjs)

### ä¼šè¯ç®¡ç†åº“

- [Iron Session](https://github.com/vvo/iron-session)
- [Jose](https://github.com/panva/jose)

## å»¶ä¼¸é˜…è¯»

è¦ç»§ç»­å­¦ä¹ è®¤è¯å’Œå®‰å…¨ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹èµ„æºï¼š

- [å¦‚ä½•åœ¨ Next.js ä¸­è€ƒè™‘å®‰å…¨æ€§](/blog/security-nextjs-server-components-actions)
- [ç†è§£ XSS æ”»å‡»](https://vercel.com/guides/understanding-xss-attacks)
- [ç†è§£ CSRF æ”»å‡»](https://vercel.com/guides/understanding-csrf-attacks)
- [The Copenhagen Book](https://thecopenhagenbook.com/)
