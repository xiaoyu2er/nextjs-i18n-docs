---
title: Next.js 12.1 版本发布
description: >-
  Next.js 12.1 带来了按需增量静态再生 (ISR)、styled-components 和 Relay 支持、零配置 Jest 集成等新特性！
author:
  - name: Balázs Orbán
    image: /static/team/balazs.jpg
  - name: DongYoon Kang
    image: /static/team/kdy.jpg
  - name: Gerald Monaco
    image: /static/team/gerald.jpg
  - name: Javi Velasco
    image: /static/team/javi.jpg
  - name: Jiachi Liu
    image: /static/team/jiachi.png
  - name: JJ Kasper
    image: /static/team/jj.jpg
  - name: Joe Haddad
    image: /static/team/timer.jpg
  - name: Kara Erickson
    image: /static/team/kara.jpg
  - name: Maia Teegarden
    image: /static/team/maia.jpg
  - name: Shu Ding
    image: /static/team/shu.jpg
  - name: Steven
    image: /static/team/styfle.png
  - name: Tim Neutkens
    image: /static/team/tim.jpg
  - name: Tobias Koppers
    image: /static/team/sokra.jpg
date: 2022-02-17T16:00:00.507Z
image: >-
  https://h8DxKfmAPhn8O0p3.public.blob.vercel-storage.com/static/blog/next-12-1/twitter-card.png
---

我们很高兴在 Next.js 12.1 中发布用户最期待的功能：

*   [**按需增量静态再生 (Beta)**](#on-demand-incremental-static-regeneration-beta): 使用 `getStaticProps` 即时重新验证页面
*   [**扩展的 SWC 支持**](#improved-swc-support): 新增 `styled-components`、Relay 等工具链支持
*   [**`next/jest` 插件**](#zero-configuration-jest-plugin): 基于 SWC 的零配置 Jest 支持
*   [**SWC 极速代码压缩 (RC)**](#faster-minification-with-swc): 比 Terser 快 7 倍的压缩性能
*   [**自托管优化**](#self-hosted-nextjs-improvements): Docker 镜像体积缩小约 80%
*   [**React 18 & 服务端组件 (Alpha)**](#react-18-server-components-and-ssr-streaming-alpha): 稳定性和支持度提升
*   [**开发者调研**](#nextjs-developer-survey): 用您的反馈帮助我们改进 Next.js

立即通过 `npm i next@latest` 命令升级体验。

[按需增量静态再生 (Beta)](#on-demand-incremental-static-regeneration-beta)
---------------------------------------------------------------------------------------------------

Next.js 现在提供了 `unstable_revalidate()` 函数，允许您重新验证使用 `getStaticProps` 的独立页面。这是自 Next.js 9.5 引入[增量静态再生](/docs/pages/building-your-application/data-fetching/incremental-static-regeneration) (ISR) 功能以来用户最期待的特性。

ISR 发布后，我们看到 [Tripadvisor](https://vercel.com/customers/cruise-critic)、[Parachute](https://vercel.com/customers/parachute)、HashiCorp 等公司在保持卓越性能的同时大幅缩短了构建时间。基于用户对定时重新验证机制的反馈，我们很高兴能提供更灵活的解决方案。

当前，如果您设置 `revalidate` 时间为 `60` 秒，所有访问者将在一分钟内看到相同的静态页面版本。原先唯一的缓存失效方式是等待时间结束后有用户访问该页面。现在您可以手动按需清除 Next.js 中特定页面的缓存。

这使得以下场景的更新更加便捷：

*   无头 CMS 中的内容创建或更新时
*   电商元数据变更（价格、描述、分类、评论等）

```js filename="pages/api/revalidate.js"
export default async function handler(req, res) {
  // 检查密钥以确保请求有效
  if (req.query.secret !== process.env.MY_SECRET_TOKEN) {
    return res.status(401).json({ message: '无效令牌' });
  }
 
  try {
    await res.unstable_revalidate('/需重新验证的路径');
    return res.json({ revalidated: true });
  } catch (err) {
    // 出现错误时，Next.js 会继续显示
    // 上次成功生成的页面
    return res.status(500).send('重新验证错误');
  }
}
```

在 `getStaticProps` 中，使用按需重新验证时无需指定 `revalidate`。如果省略 `revalidate`，Next.js 将使用默认值 `false`（不重新验证），仅在调用 `unstable_revalidate()` 时按需重新验证页面。

增量静态再生功能支持所有兼容 [Next.js 构建 API](/docs/pages/building-your-application/deploying#nextjs-build-api) (`next build`) 的部署平台。在 Vercel 上部署时，按需重新验证可在约 300ms 内完成全球边缘节点的内容更新。

[查看演示](https://on-demand-isr.vercel.app/)体验按需重新验证功能并提供反馈。Svix（企业级 Webhooks 服务）和 Clerk（身份验证）也[创建了演示](https://www.svix.com/blog/vercel-on-demand-isr-and-svix)展示按需 ISR 的应用场景。

[增强的 SWC 支持](#improved-swc-support)
---------------------------------------------

我们致力于让所有 Next.js 应用获得更快的生产构建速度和即时的开发反馈。[Next.js 12](https://nextjs.org/blog/next-12) 引入了基于 Rust 的[新一代编译器](/docs/architecture/nextjs-compiler)，利用原生编译优势。

在 12.1 版本中，我们为 Next.js 编译器新增了以下支持：

*   [styled-components](/docs/architecture/nextjs-compiler#styled-components)
*   [importSource](/docs/architecture/nextjs-compiler#importsource)
*   [legacy-decorators](/docs/architecture/nextjs-compiler#legacy-decorators)
*   [relay](/docs/architecture/nextjs-compiler#relay)
*   [remove-react-properties](/docs/architecture/nextjs-compiler#remove-react-properties)
*   [remove-console](/docs/architecture/nextjs-compiler#remove-console)

通过新增这六项转换功能，我们已将最常用的 Babel 插件迁移至 Rust 编译器。如果您希望支持其他插件，请[参与讨论](https://github.com/vercel/next.js/discussions/30174)。此外，我们正在开发基于 SWC 的[高性能 WebAssembly 插件系统](https://twitter.com/swc_rs/status/1492454606118752257)。

[零配置 Jest 插件](#zero-configuration-jest-plugin)
-----------------------------------------------------------------

Next.js 现在通过基于 Rust 的编译器自动配置 Jest (`next/jest`)，支持以下功能：

*   自动模拟样式表 (`.css`、`.module.css` 及其 `.scss` 变体) 和图片导入
*   将 `.env` (及其所有变体) 加载到 `process.env`
*   从测试解析和转换中排除 `node_modules`
*   从测试解析中排除 `.next` 目录
*   读取 `next.config.js` 中的配置启用 Next.js 编译器转换

[查阅文档](/docs/pages/building-your-application/optimizing/testing#setting-up-jest-with-the-rust-compiler)了解更多，或从我们的 [Jest 示例](https://github.com/vercel/next.js/tree/canary/examples/with-jest)快速开始。

[SWC 极速代码压缩](#faster-minification-with-swc)
-------------------------------------------------------------

[Next.js 12](https://nextjs.org/blog/next-12) 引入了基于 SWC 的代码压缩功能，早期测试显示其速度比 Terser 快 7 倍。该功能在 12.1 版本中进入发布候选 (RC) 阶段，并将在 12.2 成为默认选项。

您可以在 `next.config.js` 中启用 SWC 压缩：

```js filename="next.config.js"
module.exports = {
  swcMinify: true,
};
```

欢迎在[讨论区](https://github.com/vercel/next.js/discussions/30237)分享使用反馈。

[更快的图片优化](#faster-image-optimization)
-------------------------------------------------------

内置图片优化 API 现已支持与 [ISR 页面](/docs/pages/building-your-application/data-fetching/incremental-static-regeneration)相同的模式，即先返回缓存的图片并在后台重新验证（也称为 `stale-while-revalidate` 策略）。

这是图片优化性能的重大改进。详见[图片缓存行为](/docs/pages/api-reference/components/image#caching-behavior)。

[自托管优化](#self-hosted-nextjs-improvements)
--------------------------------------------------------------------

Next.js 现在能自动创建 `standalone` 目录，仅复制生产部署所需的文件。这使得自托管应用的 Docker 镜像体积缩小了约 80%。

要启用此功能，请在 `next.config.js` 中配置：

```js filename="next.config.js"
module.exports = {
  experimental: {
    outputStandalone: true,
  },
};
```

这将在 `.next/standalone` 生成可独立部署的文件夹，无需安装 `node_modules`。

[查看文档](/docs/pages/api-reference/next-config-js/output#automatically-copying-traced-files-experimental)或从 [Docker 示例](https://github.com/vercel/next.js/tree/canary/examples/with-docker)开始。我们还新增了支持按环境加载不同 `.env` 文件的[多环境 Docker 示例](https://github.com/vercel/next.js/tree/canary/examples/with-docker-multi-env)。

[React 18、服务端组件与 SSR 流式渲染 (Alpha)](#react-18-server-components-and-ssr-streaming-alpha)
-------------------------------------------------------------------------------------------------------------

如 [Next.js 大会](https://www.youtube.com/watch?v=WlP2TB2ORL4)所展示的，我们正致力于将 React 18、服务端 Suspense、流式 SSR 和服务端组件引入 Next.js。

服务端组件是 React 的新特性，通过分离服务端和客户端代码来减少 JavaScript 包体积。它让开发者能构建横跨服务端与客户端的应用，兼具客户端应用的丰富交互性和传统服务端渲染的卓越性能。

对于关注 Next.js 中服务端组件从 Alpha 到 Beta 进展的开发者，近期更新包括：

*   [在 HTML 中内联服务端组件响应以避免二次请求](https://github.com/vercel/next.js/issues/30994)
*   [改进流式渲染时的脚本加载以实现 React 18 的部分水合](https://github.com/vercel/next.js/issues/31338)
*   [支持 React 18 的新 `useId` API](https://github.com/vercel/next.js/pull/31102)
*   [支持将 `_app` 作为服务端组件](https://github.com/vercel/next.js/issues/30996)
*   [改进服务端组件的代码分割](https://github.com/vercel/next.js/pull/31968)
*   [提升流式渲染性能](https://github.com/vercel/next.js/pull/30585)
*   [支持在 Node.js 和 Edge 运行时之间切换默认运行时](https://github.com/vercel/next.js/pull/34068) ([RFC](https://github.com/vercel/next.js/discussions/34179))

我们正在实现让整个 Next.js 应用在边缘运行时进行服务端渲染的能力。您可以选择哪些页面启用 Edge 运行时，逐步从 Node.js 迁移。

我们很快将发布详细介绍边缘运行时的文章。我们的两个演示项目 ([next-server-components](https://github.com/vercel/next-server-components) 和 [next-rsc-demo](https://github.com/vercel/next-rsc-demo)) 都已更新至最新变更。

[其他错误修复与改进](#other-bug-fixes-and-improvements)
---------------------------------------------------------------------

*   使用 `<a>` 和 `target="blank"` 时不再触发 ESLint 的 `next/link` 使用警告
*   `.d.ts` 文件不再被视为页面文件
*   向屏幕阅读器宣布页面变更时，`document.title` 现在优先于 `h1` 标题
*   现在支持创建 `pages/index/[...dynamic].js`，之前因 `index` 是保留关键字而无法实现
*   使用 `dynamic(() => import('./some-component'), { ssr: false })` 时，导入的组件会自动从服务端代码中被摇树优化
*   为减小安装体积并提升安全性，我们预编译了更多依赖项，最新加入的是 `node-fetch`
*   改进使用[中间件](/docs/pages/building-your-application/routing/middleware)时的快速刷新体验
*   支持 ESLint 8 与我们的[内置 ESLint 集成](/docs/pages/building-your-application/configuring/eslint)
*   `styled-jsx` 升级至 5.0 版本，为所有编译错误提供包含帮助链接的新错误提示
*   边缘运行时：新增 `AbortController` 和 `AbortSignal` 支持
*   边缘运行时：添加 `CryptoKey` 和 `globalThis.CryptoKey`
*   大型 Next.js 应用的快速刷新时间提升约 60%（涉及超过 1,000 个模块重新加载的情况）
*   快速刷新失败导致页面完全重载时现在会显示通知
*   使用 React 18 严格模式时，现在能正确跳过初始页面加载的路由播报
*   自 2021 年 12 月以来，我们已[解决近 300 个](https://nextjs-issue-tracker.vercel.app/) Next.js 仓库的问题（总计解决近 1000 个问题）

[Next.js 开发者调研](#nextjs-developer-survey)
----------------------------------------------------

通过我们的[首次开发者调研](https://vercel.link/nextjs-survey)分享反馈，帮助改进 Next.js。

本次调研包含两部分：8个问题的快速调研和针对具体功能的深入调研。如果您有时间，我们希望能完成两部分内容；如果时间有限，完成第一部分即可。

您的回答将完全匿名，但也可以选择分享应用网址。

感谢您帮助改进 Next.js！

[致谢贡献者](#thank-you-contributors)
--------------------------------------------------

Next.js 是 2000 多位独立开发者、Google 和 Facebook 等行业合作伙伴以及核心团队共同努力的成果。

为降低贡献门槛，我们已将 Next.js 仓库迁移至 [Turborepo](https://turborepo.com) 以提升构建性能。我们还添加了测试脚手架和错误链接，简化测试编写流程。最后，我们录制了[40 分钟贡献指南视频](https://www.youtube.com/watch?v=cuoNzXFLitc)演示如何参与 Next.js 开发。

本版本由以下贡献者共同打造：@MaedahBatool, @mutebg, @sokra, @huozhi, @hanford, @shuding, @sean6bucks, @jameshfisher, @devknoll, @yuta-ike, @zh-lx, @amandeepmittal, @alunyov, @stefanprobst, @leerob, @balazsorban44, @kdy1, @brittanyrw, @jord1e, @kara, @vvo, @ismaelrumzan, @dlindenkreuz, @MohammadxAli, @nguyenyou, @thibautsabot, @hanneslund, @vertti, @KateKate, @stefee, @mikinovation, @Leticijak, @mohsen1, @ncphillips, @ehowey, @lancechentw, @krychaxp, @fmacherey, @pklawansky, @RyanClementsHax, @lakbychance, @sannajammeh, @oliviertassinari, @alexander-akait, @u-yas, @Cheprer, @msp5382, @chrispat, @getspooky, @Ryz0nd, @klaasman, @midgleyc, @kumard3, @jesstelford, @neeraj3029, @glenngijsberts, @pie6k, @wouterraateland, @timneutkens, @11koukou, @thesyedbasim, @aeneasr, @ijjk, @lfades, @JuniorTour, @xavhan, @mattyocode, @padmaia, @Skn0tt, @gwer, @Nutlope, @styfle, @stipsan, @xhoantran, @eolme, @sespinosa, @zenorocha, @hjaber, @benmvp, @T-O-R-U-S, @dburrows, @atcastle, @kiriny, @molebox, @Vienio99, @kyliau, @PepijnSenders, @krystofex, @PizzaPete, @souljuse, @Schniz, @Nelsonfrank, @Mhmdrza, @hideokamoto-stripe, @Emrin, @gr-qft, @delbaoliveira, @redbar0n, @lxy-yz, @Divlo, @kachkaev, @teleaziz, @OgbeniHMMD, @goncy, @bennettdams, @hsynlms, @callumgare, @jonrosner, @karaggeorge, @rpie3, @MartijnHols, @bashunaimiroy, @NOCELL, @rishabhpoddar, @omariosouto, @theMosaad, @javivelasco, @pierrenel, @lobsterkatie, @tharakabimal, @saevarb, @nbouvrette, @paulnbrd, @ecklf, @renbaoshuo, @chozzz, @tbezman, @karlhorky, @j-mendez, @ffan0811, @arthurfiorette, @chimit, @joperron, @moh12594, @rasmusjp, @bryanrsmith, @TrySound, @josharsh, @thecrypticace, @arturparkhisenko, @segheysens, @thevinter, @AryanBeezadhur, @xiaohp, @tknickman, @oriolcp, @smakosh, @jorrit, @mix3d, @Clecio013, @michielvangendt, @intergalacticspacehighway, @jbraithwaite, @marcelocarmona, @benmerckx, @haykerman, @steven-tey, @jaredpalmer, @pi-guy-in-the-sky, @JuanM04, @apollisa, @D-Pagey, @Kikobeats, @ramosbugs, @dan-weaver, @chris-stytch, @MikevPeeren, @janpio, @emw3, @nubpro, @cmdcolin, @joostdecock, @sgallese, @housseindjirdeh, @minervabot, @cjboco, @Ryuurock, @dm430, @mkarkachov, @nvh95, @gfortaine, @zifeo, @vicente-s, @Rohithgilla12, @brookton, @skirsten, @davidfateh, @DavidBabel, @mannybecerra, @pveyes, @kaykdm, @xhiroga, @mzaien, @losfair, @ykzts, @knezevicdev, @yang-feng-yfeng, @xuchaobei, @elkevinwolf, @fabienheureux, @nilskaspersson, @Andarist, @mathcrln, @dferber90, @FranciscoMoretti, @benschwarz, @wendellhu95, @gazdagergo, @imabp, @ljosberinn, @samuliasmala, @ka2jun8, @monsonjeremy, @pqt, @leoortizz, @michel-kraemer, @ntkoopman, @iicdii, @chentsulin, @ericmatthys, @lennym, @balogunkeji, @wnr, @chemicalkosek, @KittyGiraudel, @OKinane, @KonstHardy, @BrandonRomano, @furcan, @dusanralic, @elliottsj, @hi-ogawa, @panva, @genetschneider, @thundermiracle, @stefano-rainieri, @ericbiewener, @vordgi, @stevejarvis, @ihmpavel, @matamatanot, @dyarfaradj, @iheyunfei, @ascorbic, @fytriht, @emzoumpo, @onurtemiz, @a-ursino, @mxschmitt, @bywo, @OArnarsson, @TurekBot, @gish, @vadymshymko, @kamsar, @skhaz, @Prashoon123, @IrisvanOllefen, @evan-bradley, @ntltd, @EzequielDM, @oBusk, @martpie, @BruceRodrigues, @luke-h1, @lucasvazq, @velocity23, @AkiraTsuboi, @mitheelgajare, @JamiesWhiteShirt, @leroydev, @JulienZD, @leotaku, @mattfwood, 和 @kripod。
